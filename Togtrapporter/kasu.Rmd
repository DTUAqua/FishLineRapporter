
---
fontsize: 11pt
geometry: top=1in, bottom=0.8in, left=0.8in, right=0.8in
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{floatrow}
- \usepackage[T1]{fontenc}
- \usepackage[danish]{babel}
- \usepackage[utf8]{inputenc}
- \usepackage{graphicx}
- \floatsetup[table]{capposition=bottom}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhf{}
- \fancyfoot[R]{\thepage}
- \usepackage[table]{xcolor}
- \usepackage{rotating}
- \usepackage{ragged2e}
- \usepackage{catchfile}
- \usepackage{array}
- \usepackage[export]{adjustbox}
- \usepackage{multirow}
- \linespread{1.15}
- \usepackage{tabularx}
- \usepackage{tcolorbox}
- \usepackage{lipsum}
- \usepackage{makecell}
- \usepackage{etoolbox}
- \usepackage{colortbl, xcolor}
- \usepackage{lscape}
- \usepackage{caption}
- \usepackage{lastpage}
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
---


\fancypagestyle{companypagestyle}{
    \fancyhf{}
    \fancyfoot[L]{
    \parbox[b]{\dimexpr\linewidth\relax}{\vspace{1cm}
    {\color{red}\rule{\dimexpr\linewidth\relax}{0.4pt}}\\
    {\footnotesize \color{gray} www.aqua.dtu.dk \hfill DTU AQUA, Kemitorvet, Building 202\\[-0.15cm]
           +45 3588 3300 \hfill 2800 Kgs. Lyngby, Denmark}}
    }
    \fancyfoot[R]{
    \parbox[b]{0cm}{}
    }
}



\pagenumbering{arabic}
\pagestyle{companypagestyle}

\renewcommand{\familydefault}{\sfdefault}
\def\Tiny{\fontsize{5pt}{5pt}\selectfont}

\sffamily

\renewcommand\floatpagefraction{0}
\renewcommand\textfraction{0}


\def\figurename{Figure}
\def\tablename{Table}


\pagenumbering{arabic}




```{r set_libraries, include=FALSE}


#Libraries
if (!require(sqldf)) {
  install.packages("sqldf", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(sqldf)
}
if (!require(RODBC)) {
  install.packages("RODBC", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(RODBC)
}
if (!require(plyr)) {
  install.packages("plyr", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(plyr)
}
if (!require(xtable)) {
  install.packages("xtable", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(xtable)
}
if (!require(ggplot2)) {
  install.packages("gplots", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(gplots)
}
if (!require(lubridate)) {
  install.packages("lubridate", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(lubridate)
}
if (!require(reshape2)) {
  install.packages("reshape2", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(reshape2)
}
if (!require(ggrepel)) {
  install.packages("ggrepel", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(ggrepel)
}
 if (!require(grid)) {
  install.packages("grid", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(grid)
}
 if (!require(gridExtra)) {
  install.packages("gridExtra", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(gridExtra)
}
 if (!require(gplots)) {
  install.packages("gplots", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(gplots)
}
 if (!require(Hmisc)) {
  install.packages("Hmisc", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(Hmisc)
}
 if (!require(stringr)) {
  install.packages("stringr", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(stringr)
}
 if (!require(dismo)) {
  install.packages("dismo", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(dismo)
}
 if (!require(raster)) {
  install.packages("raster", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(raster)
}
 if (!require(marmap)) {
  install.packages("marmap", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(marmap)
}
 if (!require(rgdal)) {
  install.packages("rgdal", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(rgdal)
}
 if (!require(maptools)) {
  install.packages("maptools", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(maptools)
}
 if (!require(rasterVis)) {
  install.packages("rasterVis", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(rasterVis)
}
 if (!require(shapefiles)) {
  install.packages("shapefiles", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(shapefiles)
}
 if (!require(calibrate)) {
  install.packages("calibrate", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(calibrate)
}
 if (!require(plotrix)) {
  install.packages("plotrix", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(plotrix)
}
 if (!require(base)) {
  install.packages("base", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(base)
}
 if (!require(mapplots)) {
  install.packages("mapplots", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(mapplots)
}
 if (!require(data.table)) {
  install.packages("data.table", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(data.table)
}
 if (!require(tinytex)) {
  install.packages("tinytex", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(tinytex)
 }
 if (!require(knitr)) {
  install.packages("knitr", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(knitr)
}


detach(package:Hmisc)

```




```{r define_input, include=FALSE, echo=FALSE}
plannedHauls <- 50
opts_knit$set(eval.after = 'fig.cap')

# year <- @paramYear # mandatory
# cruise <- @paramCruise # mandatory
# cruiseNo <- @paramCruiseNo # mandatory
# exDate <- @paramExDate
# cruiseNo <- @paramCruiseNo
# str1 <- @paramWeather # mandatory
# str2 <- @paramResults
# str3 <- @paramComments
# str4 <- "test"
# str_cruiseLeader <- @paramCruiseLeader
# str_results <- @paramResults
# str_weather <- @paramWeather
# str_gear <- @paramGear
# str_oxygen <- @paramOxygen
# # str_comments <- @paramComments
# coastString <- 'europe'
# dk_eezString <- 'eez_dk_LandAndSea_2017'


year <- 2018#@paramYear # mandatory
cruise <- "Tunger"#@paramCruise # mandatory
cruiseNo <- 1#@paramCruiseNo # mandatory
str1 <- "paramWeather"#@paramWeather # mandatory
exDate <- ""
str1 <- "A description of the weather." #@paramWeather # mandatory
str2 <- "A description of the results. "#@paramResults
str3 <- "Some comments"#@paramComments
str4 <- "test"
str_cruiseLeader <- "Name of cruise leader"#@paramCruiseLeader
str_results <- "A description of the results"#@paramResults
str_weather <- "A description of the weather"#@paramWeather
str_gear <- "A description of the gear"#@paramGear
str_oxygen <- "A description of oxygen"#@paramOxygen
str_comments <- "Some Comments"#@paramComments
coastString <- 'maps/europe_simple_wgs84'
dk_eezString <- 'maps/eez_dk_poly'
```



```{r table_setup, echo=FALSE, results='asis',message=FALSE,warning=FALSE}

######### Setup to use in xtable prints ######################

bold <- function(x) {paste('{\\textbf{',x,'}}', sep ='')}
gray <- function(x) {paste('{\\textcolor{gray}{',x,'}}', sep ='')}

addtorow          <- list()
addtorow$pos      <- list()
addtorow$pos[[1]] <- c(0)
addtorow$command  <- c(paste("\\hline \n",
                             "\\endhead \n",
                             "\\hline \n",
                             #"{\\footnotesize Continued on next page} \n",
                             "\\endfoot \n",
                             "\\endlastfoot \n",sep=""))

```




```{r info_cruise, echo=FALSE, message=FALSE, warning=FALSE,include=FALSE}

query1<-paste("SELECT Trip.year,Trip.contactPersonName,Trip.contactPersonId , Trip.trip, Trip.cruise, tripLeaderName, dateStart, dateEnd, platform1
              FROM Trip
              WHERE     (Trip.year = ",year," and Trip.cruise='",cruise,"')"
             ,sep = "")
query1


query2 <-paste("SELECT     Animal.year, Animal.cruise, Animal.speciesCode, Animal.representative, Animal.individNum,
                           Animal.number, Animal.length, Animal.weight,Animal.statisticalRectangle as ICESsquare
                FROM       Animal
                WHERE     (Animal.year=",year," and Animal.cruise='",cruise,"')"
                            ,sep = "")
query2

query4<-paste("SELECT Sample.station, Sample.stationName, Sample.fishingtime, Sample.latPosStartDec AS lat, Sample.lonPosStartDec AS lon,
                      Sample.gearType,Sample.gearQuality,Sample.haulType, Sample.selectionDevice,Sample.meshSize, Sample.dfuArea,
                      Sample.statisticalRectangle,Sample.quarterGearStart,
                      Sample.netOpening,Sample.wireLength as warpLength, Sample.otterBoardDist as DoorSpread,
                      Sample.depthAvg,Sample.windDirection,Sample.windSpeed, Sample.dateGearStart
              FROM Sample
              WHERE     (Sample.year=",year," and Sample.cruise='",cruise,"')"
              ,sep = "")
query4


query5 <-paste("SELECT     s.year, s.cruise, s.speciesCode, SUM(s.numberTotal) AS number, SUM(s.weightTotal) AS weight
                FROM         SpeciesListRaised as s
                WHERE     s.year=",year," and s.cruise='",cruise,"'
                GROUP BY s.year, s.cruise, s.speciesCode
              "
              ,sep = "")
query5

channel <- odbcConnect("FishLineDW")
data1 <- sqlQuery(channel, paste(query1),stringsAsFactors=FALSE)
data_animal <- sqlQuery(channel, paste(query2),stringsAsFactors=FALSE)
data_sample <- sqlQuery(channel, paste(query4),stringsAsFactors=FALSE)
all_spec <- sqlQuery(channel, paste(query5),stringsAsFactors=FALSE)
close(channel)

data1 <- with(data1, data1[order(data1$dateStart),])

cruise2 <- ifelse(cruise %in% c('Torsk','2262-Torsk'),"Torsk",ifelse(tolower(cruise)=='tunger',"Tunger",substr(cruise,1,4)))
Quarter <- unique(quarter(data1$dateStart),quarter(data1$dateEnd) )
StartDate <- ifelse(nrow(data1)==1,format(data1$dateStart,"%d-%m-%Y"),format(data1$dateStart[1],"%d-%m-%Y"))
EndDate <- ifelse(nrow(data1)==1,format(data1$dateEnd,"%d-%m-%Y"),format(data1$dateEnd[nrow(data1)],"%d-%m-%Y"))


StartTime <- paste0(format(data1$dateStart,"%H"),":00")
EndTime <- paste0(format(data1$dateEnd,"%H"),":00")

cruiseName <- ifelse(substr(cruise,1,4) %in% c("IBTS","BITS","KASU"),substr(cruise,1,4),cruise)
#if (cruiseName=="KASU") {cruiseName <- "BITS"}
ship <- ifelse(substr(cruise,1,4) %in% c("IBTS","BITS"),"R/V DANA",ifelse(substr(cruise,1,4)=="KASU","Havfisken",paste(unique(data1$platform1), collapse=', ' )))

cruise_title2 <- ifelse(substr(cruise,1,4)=="IBTS","International Bottom Trawl Survey",ifelse(substr(cruise,1,4)=="BITS",
                                                                                              "Baltic International Trawl Survey",""))
cruise_title <- ifelse(substr(cruise,1,4) %in% c("IBTS","BITS","KASU"),paste0(cruiseName," ",Quarter[1],"Q"," ",year),cruiseName)
cruise_title <- ifelse(length(unique(Quarter))==1,paste0(cruiseName," ",Quarter,"Q"," ",year),
                   paste(cruiseName, paste0(Quarter,"Q"," ",year, collapse = "\\& ")))



TripNum <- ifelse(nrow(data1)>1,"MT","ST")

num_AS <- as.character(round(sum(all_spec$number, na.rm=TRUE),0))
wei_AS <- as.character(round(sum(all_spec$weight, na.rm=TRUE),1))

num_TOR <- as.character(round(sum(all_spec[all_spec$speciesCode=="TOR","number"], na.rm=TRUE),0))
num_RSP <- as.character(round(sum(all_spec[all_spec$speciesCode=="RSP","number"], na.rm=TRUE),0))
num_TNG <- as.character(round(sum(all_spec[all_spec$speciesCode=="TNG","number"], na.rm=TRUE),0))

wei_TOR <- as.character(round(sum(all_spec[all_spec$speciesCode=="TOR","weight"], na.rm=TRUE),1))
wei_RSP <- as.character(round(sum(all_spec[all_spec$speciesCode=="RSP","weight"], na.rm=TRUE),1))
wei_TNG <- as.character(round(sum(all_spec[all_spec$speciesCode=="TNG","weight"], na.rm=TRUE),1))


```

<!-- definere forside -->




\thispagestyle{empty}

<!--

\vspace*{-1cm}


\vspace{-0.9cm}


#\begin{figure}[H]
#        \flushright
#        \includegraphics[width=10cm]{X:/Line/Togtrapport/logotilkort.png}
#\end{figure}

\vspace*{0.5cm}

-->




\thispagestyle{empty}



\vspace*{-2.5cm}



<!-- \begin{figure}[H] -->
<!--         \flushright -->
<!--         \includegraphics[width=5cm]{logo_ver4.png} -->
<!-- \end{figure} -->

\vspace*{0.5cm}



\noindent\textcolor{gray}{\rule{0.6\textwidth}{1pt}}\par
\vspace*{-0.6cm}
\noindent\textcolor{gray}{\rule{0.8\textwidth}{1pt}}\par


\textcolor{gray}{\Large DTU Aqua - Cruise report}

\vspace*{4.5cm}




\textbf{\Huge `r cruise_title`}\

\vspace*{-0.3cm}

\textbf{\it{\Large `r cruise_title2`}}\

\vspace*{1cm}

\textbf{\Huge `r ship`}

\vspace*{0.3cm}

\textbf{\Huge Denmark}

\vspace*{0.5cm}

\textbf{\large Cruise no. `r cruiseNo`}\

\textbf{\large From `r StartDate` to `r EndDate`}




\vfill

<!-- \begin{figure}[H] -->
<!--         \flushleft -->
<!--         \includegraphics[width=10cm]{aqua_uk.png} -->
<!-- \end{figure} -->

\vspace{-3.1cm}
\begin{flushright}
DTU Aqua\\
Kemitorvet, Building 202\\
2800 Kgs. Lyngby\\
Denmark
\end{flushright}







\newpage


<!-- define header -->

\lhead{\footnotesize \color{gray}  CRUISE REPORT, `r cruise_title`}
\rhead{\footnotesize \color{gray} PAGE \thepage\ OF \pageref{LastPage}}


\vspace*{0.01cm}



\vspace*{0.01cm}

\renewcommand{\contentsname}{Contents}
\tableofcontents

\newpage



#Cruise summary
\vspace{0.3cm}

\newcolumntype{s}{>{\hsize=.4\hsize}X}
\newcolumntype{u}{>{\hsize=1\hsize}X}
\newcolumntype{t}{>{\hsize=0.6\hsize}X}


\subsubsection*{General information}
\vspace{-0.5cm}



\renewcommand{\arraystretch}{1}
\renewcommand{\tabcolsep}{5pt}
\begin{tabularx}{0.93\textwidth}{utst}
        &\textbf{}   & \textbf{} &  \textbf{} \\
\it{Cruise} & `r cruiseName`  &  &  \\
\it{Cruise number} & `r cruiseNo` & &  \\
\it{Reseach vessel(s)}   & `r ship` &   &  \\
\it{Year and quarter}   & `r paste0(Quarter[1],"Q")` `r year`&   &  \\
\it{Country}    & Denmark & &
\end{tabularx}



\vspace{0.3cm}

\subsubsection*{Location and time}

\vspace{-0.2cm}

\newcommand{\abTN}{`r TripNum`}

\newcommand{\aORbTN}[1]{%
        \edef\mytemp{{#1}}%
        \expandafter\ifstrequal\mytemp{ST}{

\renewcommand{\arraystretch}{1}
\renewcommand{\tabcolsep}{5pt}
\begin{tabularx}{0.93\textwidth}{uts}
        &\textbf{Date}   & \textbf{Time}  \\
\hline
\it{Departure} & `r StartDate`  & `r StartTime` \\
\it{Arrival}   & `r EndDate`    & `r EndTime`    \\
\it{Staff and crew exchange}    & `r exDate` &
\end{tabularx}

  }{} %
    \expandafter\ifstrequal\mytemp{MT}{


        }{}%
}



\aORbTN{\abTN}




```{r tripInfo,results='asis',echo=FALSE,message=FALSE,warning=FALSE}

if (TripNum=="MT") {
    tripInfo <- data1[,c("trip","dateStart","dateEnd","platform1")]

    tripInfo$dateStart <- paste0(format(data1$dateStart,"%d-%m-%Y %H"),":00")
    tripInfo$dateEnd <- paste0(format(data1$dateEnd,"%d-%m-%Y %H"),":00")


    # trip_table <- xtable(tripInfo,label = "",caption="")
    colnames(tripInfo) <- c("Trip no.","Start date and time", "End date and time","Ship")
    # align(trip_table) <- "lp{3cm}p{5cm}p{5cm}p{2.5cm}"

    # print(trip_table,include.rownames=FALSE, sanitize.colnames.function=bold)
          #tabular.environment = "longtable",
  #        floating = FALSE,
   #       include.colnames=TRUE,
    #      include.rownames=FALSE,
     #     add.to.row = addtorow,
     #     sanitize.colnames.function=bold,
    #      booktabs=T,
    #      comment=FALSE,
     #     caption.placement = "top")

     library(Hmisc)
      mylatex <- function (...) {
          o <- capture.output(latex(...))
          # this will strip /all/ line-only comments; or if you're only
          #  interested in stripping the first such comment you could
          #  adjust accordingly
          o <- grep('^%', o, inv=T, value=T)
          cat(o, sep='\n')
      }

     mylatex(tripInfo,
             file='',
             booktabs =T,
             col.just = c("l","l","l","l"), 
             # rgroup =n.rgroup$rgroup ,
             rowname="",
             # n.rgroup=n.rgroup$n.rgroup,
             rowlabel="",
             colnamesTexCmd="bfseries",
             rgroupTexCmd="itshape",
             where='H',
             # collabel.just=c("l","l"),
             center='none')


    detach(package:Hmisc)

 }

```


\vspace{0.5cm}



\subsubsection*{Participants}

\vspace{0.2cm}

\renewcommand{\arraystretch}{1}
\renewcommand{\tabcolsep}{20pt}

```{r participants1, results='asis',echo=FALSE,message=FALSE,warning=FALSE}
read.csv.unknown.sep <- function(file,numCol){
    for (i in c(",",";","","_")){
        f <- read.csv(file, header=TRUE, sep = i,stringsAsFactors = F)
        if (ncol(f)==numCol){
            return(f)}
        }    
    }

participants <- read.csv.unknown.sep("participants.csv",4) 
participants <- participants[!is.na(participants$Leg),]
# participants <- participants[participants$Leg==1,]
participants$order <- as.integer(rownames(participants))

n.rgroup<-data.frame(rgroup=character(),
                     n.rgroup = integer(),
                     stringsAsFactors = F)
for (i in 1:max(participants$Leg)){
  n.rgroup[i,"rgroup"] <- paste0("Leg ",i)
  n.rgroup[i,"n.rgroup"] <- nrow(participants[participants$Leg==1,])
}

participants2 <- participants[with(participants, order(order)),!(names(participants) %in% c("Leg","order"))]

colnames(participants2) <- c("Name","Institute", "Function and tasks")
#rownames(participants2) <-  paste0(1:nrow(participants2)," ",participants2$Name)

participants3 <- participants2[,c("Institute", "Function and tasks")]

# 
# rgroup <- c("Leg 1","Leg 2")
# n.rgroup <- c(NoLeg1,NoLeg2)


     library(Hmisc)
      mylatex <- function (...) {
          o <- capture.output(latex(...))
          # this will strip /all/ line-only comments; or if you're only
          #  interested in stripping the first such comment you could
          #  adjust accordingly
          o <- grep('^%', o, inv=T, value=T)
          cat(o, sep='\n')
      }

      
     mylatex(participants2,
             file='',
             booktabs =T,
             col.just = c("l","l","l","l"), 
             rgroup =n.rgroup$rgroup ,
             rowname="",
             n.rgroup=n.rgroup$n.rgroup,
             rowlabel="Leg",
             colnamesTexCmd="bfseries",
             rgroupTexCmd="itshape",
             where='H',
             collabel.just=c("l","l"),
             center='none')


    detach(package:Hmisc)


```




```{r SIS_data, results='asis',echo=FALSE,message=FALSE,warning=FALSE}

#SIS_info <- read.table("X:\\Line\\Togtrapport\\SIS-info_BITS1_2008.csv",header=TRUE,sep=",")

No_oxy <- 1 #nrow(SIS_info[SIS_info$Redskab=="AKU",])
No_CTD <- 1 #nrow(SIS_info[SIS_info$Redskab=="SEA",])




yn_cruiseLeader <- ifelse(str_cruiseLeader!="","yes","no")
yn_oxygen <- ifelse(str_oxygen!="","yes","no")
yn_weather <- ifelse(str_weather!="","yes","no")
yn_results <- ifelse(str_results!="","yes","no")
yn_comments <- ifelse(str_comments!="","yes","no")
yn_gear <- ifelse(str_gear!="","yes","no")


pos <- data_sample[,c("station","stationName","gearType","gearQuality","lat","lon","dfuArea")]
pos[is.na(pos$stationName),"stationName"] <- pos[is.na(pos$stationName),"station"]
pos$stationName <- as.character(pos$stationName)

```

<!--

\newcommand{\ab}{`r substr(cruise,1,4)`}



\newcommand{\aORb}[1]{%
        \edef\mytemp{{#1}}%
        \expandafter\ifstrequal\mytemp{BITS}{

-->
\newpage




\newcommand{\ab}{`r cruise2`}

\newcommand{\aORb}[1]{%
\edef\mytemp{{#1}}%
\expandafter\ifstrequal\mytemp{BITS}{

\section{Objectives}

\subsection{Daytime}

\begin{itemize}
\item{`r str1`}
\item{`r str2`}
\item{
Several sets of fish and shellfish species were collected for teaching purposes.
At various stations during the first leg of the survey cameras were placed at different
part of the trawl. High quality video material was recorded mainly from tows at depths
shallower than 30 m due to light sensitivity limitations of the cameras. The material
allows studying the swimming behavior of several species, namely sprat, horse mackerel
and mackerel but also plaice, sharks and squids in the trawl just in front of the cod end.


}
\end{itemize}

\subsection{test1}

`r str1`

\subsection{test2}

Several sets of fish and shellfish species were collected for teaching purposes.
At various stations during the first leg of the survey cameras were placed at different
part of the trawl. High quality video material was recorded mainly from tows at depths
shallower than 30 m due to light sensitivity limitations of the cameras. The material
allows studying the swimming behavior of several species, namely sprat, horse mackerel
and mackerel but also plaice, sharks and squids in the trawl just in front of the cod end.


   \newpage

        \section{Haul summary}

        \vspace{0.5cm}





        \renewcommand{\arraystretch}{1.2}
        \begin{tabularx}{\textwidth}{@{}lrr@{}}
        \textbf{Number of planned hauls:} & `r plannedHauls` &
        \end{tabularx}

        \newcolumntype{K}{>{\hsize=0.2\hsize}X}

        \newcolumntype{L}{>{\hsize=3\hsize}r}


        \vspace{0.5cm}



        \renewcommand{\arraystretch}{1.3}
        \renewcommand{\tabcolsep}{10pt}
        \begin{tabularx}{0.93\textwidth}{@{}p{11cm}LLs}
         & \thead{Index \\qualified} & \thead{Non-index \\qualified} &  \\
        \hline
        \textbf{Number of succesfull trawl hauls:}                           &`r nrow(subset(data_sample,gearQuality=="V"))` & &  \\
        \textbf{Number of invalid trawl hauls:}                              & & `r nrow(subset(data_sample,gearQuality=="I"))`& \\
        \textbf{Number of "No oxygen trawl hauls" (assumed zero-catch):} & `r No_oxy`& & \\[0.3cm]
        \hline
        \textbf{SUM} & `r nrow(subset(data_sample,haulType=="N"))+nrow(subset(data_sample,gearQuality=="V"))` &`r nrow(subset(data_sample,gearQuality=="I"))` &
        \end{tabularx}

        \vspace{0.5cm}


        \renewcommand{\arraystretch}{1.3}
        \renewcommand{\tabcolsep}{10pt}
        \begin{tabularx}{0.93\textwidth}{@{}p{11.7cm}LLs}
         & & &  \\
        \hline
        \textbf{Number of trawl related CTD stations performed:} &  0& & \\
        \textbf{Number of NON-trawl related CTD stations performed:} & 10 & &\\
        \textbf{Number of successful BONGO hauls carried out):} & 5 & &\\
        \textbf{Number of successful IKMT hauls carried out:} & & &\\
        \textbf{Number of successful Appi hauls carried out:} & & &\\
        \textbf{Number of successful WP2 hauls carried out:}  & & &\\
        \textbf{Number of successful BOM hauls carried out:}  & & &\\
        \textbf{Number of successful Multi-NET hauls carried out:} & & &
        \end{tabularx}


}{}%

\expandafter\ifstrequal\mytemp{IBTS}{

       \subsection{Daytime}

        \begin{itemize}
\item{`r str1`}
\item{`r str2`}
\item{
Several sets of fish and shellfish species were collected for teaching purposes.
At various stations during the first leg of the survey cameras were placed at different
part of the trawl. High quality video material was recorded mainly from tows at depths
shallower than 30 m due to light sensitivity limitations of the cameras. The material
allows studying the swimming behavior of several species, namely sprat, horse mackerel
and mackerel but also plaice, sharks and squids in the trawl just in front of the cod end.


}
\end{itemize}

\subsection{test1}

`r str1`




}{}%

\expandafter\ifstrequal\mytemp{KASU}{

\section{Objectives}

        \begin{itemize}
\item{To describe the existence of fish in Kattegat, Øresund, Storebælt, Lillebælt and the Western Baltic based on their occurrence in test trawl.
The fishery in ICES araes 22 and 23 are a part of the IBTS survey./
At beskrive udbredelsen af fisk i Kattegat, Øresund, Storebælt, Lillebælt og den Vest-lige Østersø ud fra forekomst i forsøgstrawl. Fiskeriet i område 22 og 23 er en del af BITS.}
\item{To collect biological data regarding age, weight and maturity from subsamples of the catch from selected species./
At indsamle biologisk materiale vedr. alder, vægt og modenhed fra stikprøver fra fangsten af udvalgte arter.}
\item{Recording of hydrographic data with CTD./Opsamling af hydrografidata med CTD.}
\end{itemize}

\section{This survey}

}{}%
}



\aORb{\ab}

\newcommand{\abCL}{`r yn_cruiseLeader`}
\newcommand{\aORbCL}[1]{%
        \edef\mytemp{{#1}}%
        \expandafter\ifstrequal\mytemp{yes}{
           	\subsection*{Crusie Leader}
			`r str_cruiseLeader`
        }{} %
}
\aORbCL{\abCL}

\subsection*{Stations}
`r nrow(pos)` hauls were conducted during the survey. The positions off all hauls are presented in the map in Fig. 1 and hauls per ICES area are plotted in the maps in Fig. 2-`r length(unique(pos$dfuArea))+1`.

\newcommand{\abWE}{`r yn_weather`}
\newcommand{\aORbWE}[1]{%
        \edef\mytemp{{#1}}%
        \expandafter\ifstrequal\mytemp{yes}{
           	\subsection*{Weather Conditions}
			`r str_weather`
        }{} %
}
\aORbWE{\abWE}

\newcommand{\abGE}{`r yn_gear`}
\newcommand{\aORbGE}[1]{%
        \edef\mytemp{{#1}}%
        \expandafter\ifstrequal\mytemp{yes}{
           	\subsection*{Gear performance}
			`r str_gear`
        }{} %
}
\aORbGE{\abGE}



\newcommand{\abOX}{`r yn_oxygen`}
\newcommand{\aORbOX}[1]{%
        \edef\mytemp{{#1}}%
        \expandafter\ifstrequal\mytemp{yes}{
           	\subsection*{Oxygen Conditions}
			`r str_oxygen`
        }{} %
}
\aORbOX{\abOX}


\newcommand{\abOC}{`r yn_comments`}
\newcommand{\aORbOC}[1]{%
        \edef\mytemp{{#1}}%
        \expandafter\ifstrequal\mytemp{yes}{
           	\subsection*{Other Comments}
			`r str_comments`
        }{} %
}
\aORbGE{\abOC}


\newcommand{\abRE}{`r yn_results`}
\newcommand{\aORbRE}[1]{%
        \edef\mytemp{{#1}}%
        \expandafter\ifstrequal\mytemp{yes}{
        \section{Results}
			`r str_results`
        }{} %
}
\aORbRE{\abRE}



```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=8, fig.height=10,fig.pos='h',fig.cap=paste0("Survey map with all sampling stations, ",ship," Denmark, ",cruise_title,".\\label{fig:mapall}")}
trawlCode <- if (toupper(cruise)=="TUNGER"){"OTT"} else{"OTB"}

coast <- read.shapefile(coastString)
dk_eez <- read.shapefile(dk_eezString)

#latlon <- CRS("+proj=longlat +datum=WGS84")
#utm32N <- CRS("+proj=utm +zone=32 +datum=WGS84")

#All areas
ylim <- c(round(min(pos$lat,na.rm=T)-.5),round(max(pos$lat,na.rm=T)+.5))
xlim <- c(round(min(pos$lon,na.rm=T)-.5),round(max(pos$lon,na.rm=T)+.5))


########
col <- terrain.colors(12)


#####################################################################################################
##
##  Draw the map
##
#####################################################################################################

basemap(xlim=xlim, ylim=ylim, main = "",xlab=expression("Longitude"*~degree*"E"),ylab=expression("Latitude"*~degree*"N") ) #, bg="white")

draw.shape(coast, col="cornsilk", border="transparent", xlim=xlim, ylim=ylim)
draw.shape(dk_eez, col="transparent", border = "red", xlim=xlim, ylim=ylim)
draw.rect(col="grey")

#plot(route, lwd=0.01, add=T)
#lines(route, lwd=.2, col="gray")

# par(cex = 0.2)
# pointLabel(x=pos[pos$gearQuality=="V","lon"], y=pos[pos$gearQuality=="V","lat"],
#      labels=pos[pos$gearQuality=="V","stationName"],cex=4,offset=-1,allowSmallOverlap = FALSE)

par(cex = 1)
text(x=pos[pos$gearQuality=="V","lon"], y=pos[pos$gearQuality=="V","lat"],
    labels=pos[pos$gearQuality=="V","stationName"], adj = c(1,1),cex=0.8)

points(pos[pos$gearType==trawlCode & pos$gearQuality=="V","lon"], 
       pos[pos$gearType==trawlCode & pos$gearQuality=="V","lat"], 
       pch=16, col="blue", cex=.8)
points(pos[pos$gearType=="TV3" & pos$gearQuality=="V","lon"], 
       pos[pos$gearType=="TV3" & pos$gearQuality=="V","lat"], 
       pch=16, col="darkgreen", cex=.8)
points(pos[pos$gearQuality=="I","lon"],
       pos[pos$gearQuality=="I","lat"], 
       pch=16, col="dark orange", cex=.8)


legend( x="bottomright", title = "Stations",
        legend=c("Valid TV3", sprintf("Valid %s",trawlCode),"Invalid haul"),
        pch=c(16, 16,16), col = c("blue","darkgreen","dark orange"),
        cex = 0.9)

```

\subsection{Stations by ICES area}

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=7, fig.height=8,fig.pos='h',fig.cap=caption}

for (a in as.character(sort(unique(pos$dfuArea)))){
  
  if (any(pos$dfuArea==a)) {
    caption <- sprintf("Survey map with sampling stations in area %s, %s Denmark, %s.\\label{fig:map%s}",a,ship,cruise_title,a)
    
    pos2 <- pos[pos$dfuArea==a,]

    #area 20
    ylim <- c(floor(min(pos2$lat,na.rm=T)/.1)*.1,ceiling(max(pos2$lat,na.rm=T)/.1)*.1)
    xlim <- c(floor(min(pos2$lon,na.rm=T)/.5)*.5,ceiling(max(pos2$lon,na.rm=T)/.5)*.5)


#####################################################################################################
##
##  Draw the map
##
#####################################################################################################

basemap(xlim=xlim, ylim=ylim, main = "",xlab=expression("Longitude"*~degree*"E"),ylab=expression("Latitude"*~degree*"N") ) #, bg="white")

draw.shape(coast, col="cornsilk", border="transparent", xlim=xlim, ylim=ylim)
draw.rect(col="grey")

text(x=pos2[pos2$gearQuality=="V","lon"], 
     y=pos2[pos2$gearQuality=="V","lat"],
    labels=pos2[pos2$gearQuality=="V","stationName"], adj = c(1,1),cex=0.8)



points(pos2[pos2$gearType==trawlCode & pos2$gearQuality=="V","lon"], 
         pos2[pos2$gearType==trawlCode & pos2$gearQuality=="V","lat"], 
         pch=16, col="blue", cex=.9)


points(pos2[pos2$gearType=="TV3" & pos2$gearQuality=="V","lon"], 
       pos2[pos2$gearType=="TV3" & pos2$gearQuality=="V","lat"], 
       pch=16, col="darkgreen", cex=.9)

legend( x="bottomright", title = "Stations",
        legend=c(sprintf("Valid %s",trawlCode),"Valid TV3"),
        pch=c(16, 16), col = c("blue","darkgreen"),
        cex = 0.9)
title(sprintf("Valid stations in ICES area %s",a),line=2)

cat("\\newpage ")
  }
}
```



```{r depth_gear_info, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=7, fig.height=10}

gear_inf <- with(data_sample, data_sample[order(data_sample$dateGearStart) ,])


if (substr(cruise,1,4)=="IBTS") {

  #Function coefficient values taken from IBTS manual 2015 page 24.

  p1 <-  ggplot(gear_inf, aes(x=depthAvg,y=warpLength)) +
                theme_bw()+geom_point(color="red")+labs(y='Warp length (m)')+
                theme(axis.title.x=element_blank())+ expand_limits(x=0)

  p2 <-  ggplot(gear_inf, aes(x=depthAvg,y=netOpening)) +
                theme_bw()+geom_point(color="red")+labs(y='Net opening (m)')+
                stat_function(fun=function(x) 3.7461+1.7689*exp(-0.0140*x),linetype="dashed")+
                stat_function(fun=function(x) 4.9088+1.7727*exp(-0.0142*x),linetype="dashed")+
                theme(axis.title.x=element_blank()) + expand_limits(x=0)

  p3 <-  ggplot(gear_inf, aes(x=depthAvg,y=DoorSpread)) +
                theme_bw()+geom_point(color="red")+labs(x='Depth (m)',y='Door spread (m)') +
                stat_function(fun=function(x) 84.3842-39.4195*exp(-0.0140*x),linetype="dashed")+
                stat_function(fun=function(x) 103.9178-39.6521*exp(-0.0139*x),linetype="dashed")+ expand_limits(x=0)



  gp1<- ggplot_gtable(ggplot_build(p1))
gp2<- ggplot_gtable(ggplot_build(p2))
gp3<- ggplot_gtable(ggplot_build(p3))
maxWidth = unit.pmax(gp1$widths[2:3], gp2$widths[2:3], gp3$widths[2:3])
gp1$widths[2:3] <- maxWidth
gp2$widths[2:3] <- maxWidth
gp3$widths[2:3] <- maxWidth

grid.arrange(gp1, gp2, gp3)


}
```




```{r catch_data, echo=FALSE, message=FALSE, warning=FALSE,include=FALSE}

########## Collecting data from Fishline ###########

query1<-paste("SELECT    SpeciesListRaised.speciesCode, SUM(SpeciesListRaised.numberTotal) as cruiseNumberTotal,
                         SUM(SpeciesListRaised.weightTotal) as cruiseWeightTotal
              FROM       SpeciesListRaised
              WHERE      (SpeciesListRaised.year=",year," and
                          SpeciesListRaised.cruise='",cruise,"')
              GROUP BY   speciesCode"
              ,sep = "")
query1

query1b <-paste("SELECT    SpeciesListRaised.speciesCode, dfuArea as area, SUM(SpeciesListRaised.numberTotal) as cruiseNumberTotal,
                         SUM(SpeciesListRaised.weightTotal) as cruiseWeightTotal
              FROM       SpeciesListRaised
              WHERE      (SpeciesListRaised.year=",year," and
                          SpeciesListRaised.cruise='",cruise,"')
              GROUP BY   speciesCode,dfuArea"
              ,sep = "")
query1b

query2<-paste("SELECT L_Species.speciesCode, L_Species.ukName as Species,L_Species.dkName as dkSpecies,  L_Species.latin
              FROM L_Species"
              ,sep = "")
query2

tripQ <- sprintf("SELECT    SpeciesListRaised.speciesCode, SUM(SpeciesListRaised.numberTotal) as cruiseNumberTotal,
                         SUM(SpeciesListRaised.weightTotal) as cruiseWeightTotal
              FROM       SpeciesListRaised
                 where year = %s and cruise = '%s'
                 group by tripid,speciesCode,dfuArea",year,cruise)

channel <- odbcConnect("FishLineDW")
data_catch <- sqlQuery(channel, paste(query1),stringsAsFactors=FALSE)
data_catch_area <- sqlQuery(channel, paste(query1b),stringsAsFactors=FALSE)
trip_data <- sqlQuery(channel,tripQ,stringsAsFactors=F)
close(channel)
channel <- odbcConnect("FishLine")
species_names <- sqlQuery(channel, paste(query2),stringsAsFactors=FALSE)
close(channel)


```


\newpage

\section{Catch}

<!--

\renewcommand{\arraystretch}{1}
\renewcommand{\tabcolsep}{5pt}
\begin{tabularx}{uts}
        & \textbf{Weight (kg)}   & \textbf{Number}  \\
\hline
\it{Total catch} & `r round(sum(all_spec$weight,na.rm=TRUE))` & `r round(sum(all_spec$number,na.rm=TRUE))` \\
\it{Cod}   & `r round(all_spec[all_spec$speciesCode=="TOR","weight"])`    & `r round(all_spec[all_spec$speciesCode=="TOR","number"])`   \\
\it{Plaice}    & round(all_spec[all_spec$speciesCode=="RSP","weight"])` & `r round(all_spec[all_spec$speciesCode=="RSP","number"])`\\
\it{Sole}    & `r round(all_spec[all_spec$speciesCode=="TNG","weight"])` & `r round(all_spec[all_spec$speciesCode=="TNG","number"])`
\end{tabularx}

-->

The total catch of all species, cod, plaice and sole are presented below.
The total catch per species per ICES area are presented in table 1-`r length(unique(pos$dfuArea))`.

 \vspace{0.2cm}


\renewcommand{\arraystretch}{1}
\renewcommand{\tabcolsep}{30pt}
\begin{tabularx}{0.7\textwidth}{lrr}
        &\textbf{Weight (kg)}   & \textbf{Number}  \\[0.1cm]
\hline
\it{\textbf{Total catch}}  & `r wei_AS` & `r num_AS` \\[0.2cm]
\hline
\it{\textbf{Cod}}  & `r wei_TOR` & `r num_TOR` \\
\it{\textbf{Plaice}}  & `r wei_RSP` & `r num_RSP` \\
\it{\textbf{Sole}}    & `r wei_TNG` & `r num_TNG`
\end{tabularx}


 \vspace{0.3cm}

\small

\renewcommand{\arraystretch}{1}
\renewcommand{\tabcolsep}{8pt}

```{r catch_table, results='asis',echo=FALSE,message=FALSE,warning=FALSE}
library(data.table)

if (substr(cruise,1,4)=="KASU") {

    Catch_cruise <- merge(species_names,
                          data_catch_area[!(data_catch_area$speciesCode %like% "^AF"),],
                          by="speciesCode",all.y=TRUE)

    Catch_cruise2 <- Catch_cruise[with(Catch_cruise, order(area,latin)),
                                  !(names(Catch_cruise) %in% c("speciesCode"))]
    Catch_cruise2 <- Catch_cruise2[,c("latin","Species","dkSpecies",
                                      "cruiseNumberTotal","cruiseWeightTotal","area")]
    #Catch_cruise2[Catch_cruise2$latin=="Scyphozoa" & !is.na(Catch_cruise2$latin),"dkSpecies" ] <- "Storgopler"

   # colnames(Catch_cruise2) <- c("Latin name","English name","Danish name","Number","Weight (kg)","area")
#    rownames(Catch_cruise2) <- 1:nrow(Catch_cruise2)

    rgroup <- unique(Catch_cruise2$area)
   # n.rgroup <- c()
   # rgroupName <- c()
    for (i in 1:length(rgroup)) {
      assign(paste0("area_", i),Catch_cruise2[Catch_cruise2$area==rgroup[i],])
    #  n.rgroup[i] <- nrow(Catch_cruise2[Catch_cruise2$area==rgroup[i],]);
     # rgroupName[i] <- paste("Area", rgroup[i])

      Catch_table <- xtable(Catch_cruise2[Catch_cruise2$area==rgroup[i],!(names(area_1)=="area")],digits=0,
                            caption=paste("Species caught in area",rgroup[i] ))
      colnames(Catch_table) <- c("Latin name","English name", "Danish name","Number", "Weight (kg)")
      align(Catch_table) <- "lp{4.5cm}p{3.5cm}p{3.5cm}rr"

    print(Catch_table,
          tabular.environment = "longtable",
          floating = FALSE,
          include.colnames=TRUE,
          include.rownames=FALSE,
          add.to.row = addtorow,
          sanitize.colnames.function=bold,
          booktabs=T,
          comment=FALSE,
          caption.placement = "top")
}

} else if (toupper(cruise)=="TUNGER"){
  
}  else{

    Catch_cruise <- merge(species_names,data_catch[!(data_catch$speciesCode %like% "^AF"),], by="speciesCode",all.y=TRUE)

    Catch_cruise2 <- Catch_cruise[,c("latin","Species","dkSpecies","cruiseNumberTotal","cruiseWeightTotal")]
   # Catch_cruise2[Catch_cruise2$latin=="Scyphozoa" & !is.na(Catch_cruise2$latin),"dkSpecies" ]<- "Storgopler"
    Catch_cruise2 <- Catch_cruise2[with(Catch_cruise2, order(latin)), ]


    Catch_table <- xtable(Catch_cruise2,digits=0,caption="Species caught on the survey")
    colnames(Catch_table) <- c("Latin name","English name", "Danish name","Number", "Weight")
    align(Catch_table) <- "lp{4.5cm}p{4cm}p{3.5cm}rr"

    print(Catch_table,
          tabular.environment = "longtable",
          floating = FALSE,
          include.colnames=TRUE,
          include.rownames=FALSE,
          add.to.row = addtorow,
          sanitize.colnames.function=bold,
          booktabs=T,
          comment=FALSE,
          caption.placement = "top")

}


```


\captionsetup{font=normal}



```{r cod_lengths, echo=FALSE, message=FALSE, warning=FALSE,include=FALSE}
########## Collecting data from Fishline ###########

query1<-paste0("SELECT    AnimalRaised.trip, AnimalRaised.year, AnimalRaised.speciesCode, AnimalRaised.dfuArea,
                         AnimalRaised.numberTotalPerLength, AnimalRaised.length, AnimalRaised.station
              FROM       AnimalRaised
              WHERE      (AnimalRaised.year BETWEEN ",year-9," AND ",year," and
                         AnimalRaised.cruise='",cruise,"' and
                         AnimalRaised.speciesCode IN ('TOR','TNG'))")
query1

query2<-paste0("SELECT    Sample.year, count(Sample.station) as tot_stat
               FROM      Sample
               WHERE     (Sample.year BETWEEN ",year-9," AND ",year," and
                         Sample.cruise='",cruise,"' AND
                         Sample.gearQuality='V')
               GROUP BY  Sample.year ")


query2


channel <- odbcConnect("FishLineDW")
data_TORTNG <- sqlQuery(channel, paste(query1),stringsAsFactors=FALSE)
data_stat <- sqlQuery(channel, paste(query2),stringsAsFactors=FALSE)
close(channel)


CodPerStation <- sqldf('SELECT     data_TORTNG.year, data_TORTNG.length,sum(data_TORTNG.numberTotalPerLength) as numberPerYear,data_stat.tot_stat,
                                   sum(data_TORTNG.numberTotalPerLength)/data_stat.tot_stat as NumPerLenPerYear
                        FROM       data_TORTNG inner join data_stat on data_TORTNG.year=data_stat.year
                        WHERE      data_TORTNG.speciesCode="TOR"
                        GROUP BY   data_TORTNG.year, data_TORTNG.length')



min_year <- min(CodPerStation$year)
max_year <- max(CodPerStation$year)

Cod_weight <- as.integer(round(data_catch[data_catch$speciesCode=='TOR',]$cruiseWeightTotal))
Sole_weight <- as.integer(round(data_catch[data_catch$speciesCode=='TNG',]$cruiseWeightTotal))

Cod_oto <- nrow(data_animal[!is.na(data_animal$individNum) & data_animal$speciesCode=='TOR',])
Cod_num <- sum(data_animal[is.na(data_animal$individNum) & data_animal$speciesCode=='TOR',]$number)

Sole_oto <- nrow(data_animal[!is.na(data_animal$individNum) & data_animal$speciesCode=='TNG',])
Sole_num <- sum(data_animal[is.na(data_animal$individNum) & data_animal$speciesCode=='TNG',]$number)

```





\renewcommand{\arraystretch}{1}
\setlength\arraycolsep{0.2pt}
\renewcommand{\tabcolsep}{3pt}

\definecolor{lightgray}{gray}{0.9}
\rowcolors{2}{}{lightgray}


```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=14, fig.height=6, fig.pos="H"}

#THIS SECTION IS ONLY INCLUDED FOR IBTS CRUISES

if (substr(cruise,1,4)=="IBTS") {

	  cat('\\newpage')
	  cat('\\section{Single fish data}')


      #Read relation roundfish areas and square
      #RF_square <- read.table("X:\\Line\\Togtrapport\\join_RFareas_ICESareas_selected.txt",sep="",header=TRUE)

            RFS1 <- c("48E6","49E6","50E6","51E6","52E6","48E7","49E7","50E7","51E7","52E7","47E8","48E8","49E8","50E8",
                "51E8","52E8","47E9","48E9","49E9","50E9","51E9","52E9","44F0","45F0","46F0","47F0","48F0","49F0",
                "50F0","51F0","52F0","44F1","45F1","46F1","47F1","48F1","49F1","50F1","51F1","52F1","45F2","46F2",
                "47F2","48F2","49F2","50F2","51F2","52F2","45F3","46F3","47F3","48F3","49F3","50F3","51F3","52F3",
                "45F4","40F0","41F0","42F0","43F0","39F1","40F1","41F1","42F1","43F1","39F2","40F2","41F2","42F2",
                "43F2","44F2","40F3","41F3","42F3","43F3","44F3","40F4","41F4","42F4","43F4","44F4","41E6","42E6",
                "43E6","44E6","45E6","46E6","47E6","41E7","42E7","43E7","44E7","45E7","46E7","47E7","41E8","42E8",
                "43E8","44E8","45E8","46E8","41E9","42E9","43E9","44E9","45E9","46E9","40E6","40E7","38E8","39E8",
                "40E8","36E9","37E9","38E9","39E9","40E9","36F0","37F0","38F0","39F0","37F1","38F1","31F0","32F0",
                "34F0","35F0","31F1","32F1","33F1","34F1","35F1","36F1","33F2","34F2","35F2","36F2","31F2","32F2",
                "37F2","38F2","31F3","32F3","33F3","34F3","35F3","36F3","37F3","38F3","39F3","31F4","32F4","33F4",
                "34F4","35F4","36F4","37F4","38F4","39F4","33F5","34F5","35F5","36F5","37F5","38F5","39F5","35F6",
                "36F6","37F6","38F6","39F6","35F7","36F7","37F7","38F7","39F7","35F8","36F8","37F8","38F8","39F8",
                "35F9","36F9","40F5","41F5","42F5","43F5","44F5","40F6","41F6","42F6","43F6","40F7","41F7","42F7",
                "43F7","40F8","41F8","42F8","43F8","44F8","45F8","46F8","47F8","48F8","43F9","44F9","45F9","46F9",
                "47F9","48F9","44G0","45G0","46G0","47G0","48G0","44G1","45G1","46G1","47G1","48G1","41G0","42G0",
                "43G0","41G1","42G1","43G1","41G2","42G2","43G2")
      RFS2 <- c(rep(1,57),rep(2,25),rep(3,26),rep(4,16),rep(5,14),rep(6,46),rep(7,16),rep(8,22),rep(9,9))
      RF_square_val <- data.frame("ICESsquare"=RFS1,"Rfarea"=RFS2)
      RF_square <- RF_square_val

      single_fish <- merge(data_animal[!is.na(data_animal$individNum),],RF_square, by="ICESsquare", all.x=TRUE)
      single_fish <- merge(single_fish,species_names, by="speciesCode", all.x=TRUE)

      single_fish2 <- ddply(single_fish, .(Species,Rfarea), summarize, Tot_num=sum(number) )
      single_fish2$Rfarea <- paste0("Area: ",single_fish2$Rfarea)
      single_fish2 <- single_fish2[with(single_fish2, order(Rfarea)), ]



      SF_wide <- dcast(single_fish2, Species ~ Rfarea)
      SF_wide2 <- cbind(SF_wide,"Total"=rowSums(SF_wide[,-1], na.rm = TRUE))

      RFAfish <- c("Herring","Sprat","Cod","Haddock","Whiting","Mackerel","Saithe","Plaice","Norway pout")
      SF_wide2$type <- ifelse(SF_wide2$Species %in% RFAfish,"A","B")
      NoRFA <- nrow(SF_wide2[SF_wide2$type=="A",])
      SF_wide2 <- SF_wide2[with(SF_wide2, order(type, Species)), -ncol(SF_wide2)]
      SF_wide2[(NoRFA+1):nrow(SF_wide2),2:(ncol(SF_wide2)-1)] <- NA
      SF_wide3 <- rbind(SF_wide2,Sum=c("Sum",rep("",7),sum(SF_wide2$Total)))
      rgroup <- c("Stratified by roundfish area","Not stratified by roundfish area","All species")
      n.rgroup <- c(NoRFA,nrow(SF_wide3)-NoRFA-1,1)
      rownames(SF_wide3) <- SF_wide3$Species

      library(Hmisc)

      mylatex(SF_wide3[,-1],file='',booktabs =T,rgroup = rgroup,n.rgroup=n.rgroup,rowlabel="Species",longtable=TRUE,
            col.just = c("r","r","r","r","r","r","r","r"),colnamesTexCmd="bfseries",rgroupTexCmd="itshape",where='H',
            caption="Number of single fish data (length, weight, sex and maturity) and samples for ageing.",
            center='centering')

      detach(package:Hmisc)



}

```


\newcommand{\abTWO}{`r cruise2`}

\rowcolors{1}{}{white}

\newcommand{\aORbTWO}[1]{%
        \edef\mytemp{{#1}}%
        \expandafter\ifstrequal\mytemp{BITS}{

                    \newpage

                    \section{Cod}

                    \renewcommand{\arraystretch}{1.2}
                    \begin{tabularx}{\textwidth}{@{}lrr@{}}
                    \textbf{Total kgs of cod catched:} &  `r Cod_weight` & \\
                    \textbf{Total number of cod measured:} &  `r Cod_num` & \\
                    \textbf{Total number of cod otoliths collected:} & `r Cod_oto` &
                    \end{tabularx}

                    \vspace{0.4cm}

                    In figure 1 to 5 the length distributions of cod from `r min_year` to `r max_year` are presented.
                    For each year, the length distribution presents the average number of cods caught per length and station.

                    \vspace{1cm}
        }{} %
        \expandafter\ifstrequal\mytemp{Torsk}{

         \newpage

                    \section{Cod}

                    \renewcommand{\arraystretch}{1.2}
                    \begin{tabularx}{\textwidth}{@{}lrr@{}}
                    \textbf{Total kgs of cod catched:} &  `r Cod_weight` & \\
                    \textbf{Total number of cod measured:} &  `r Cod_num` & \\
                    \textbf{Total number of cod otoliths collected:} & `r Cod_oto` &
                    \end{tabularx}

                    \vspace{1cm}






        }{}%
        \expandafter\ifstrequal\mytemp{Tunger}{

         \newpage

                    \section{Sole}

                    \renewcommand{\arraystretch}{1.2}
                    \begin{tabularx}{\textwidth}{@{}lrr@{}}
                    \textbf{Total kgs of sole catched:} &  `r Sole_weight` & \\
                    \textbf{Total number of sole measured:} &  `r Sole_num` & \\
                    \textbf{Total number of sole otoliths collected:} & `r Sole_oto` &
                    \end{tabularx}

                    \vspace{1cm}






        }{}%
}


\aORbTWO{\abTWO}




```{r, echo=FALSE, message=FALSE, warning=FALSE,results='asis', fig.width=15, fig.height=8,fig.cap=paste0("Cod length distribution per area for ",cruise,", ",year), fig.pos="H"}

#THIS SECTION IS ONLY INCLUDED FOR BITS CRUISES

if (cruise2 %in% c("BITS","Torsk","Tunger")) {

 spec <- ifelse(cruise2 %in% c("BITS","Torsk"),"TOR","TNG")

 speciesDat <- ddply(data_TORTNG[data_TORTNG$year==year &data_TORTNG$speciesCode==spec,],.(year,length,dfuArea),
                            summarize,number=sum(numberTotalPerLength))

 p <- ggplot(speciesDat, aes(x=length, y=number))
 plot1  <- p + geom_bar(stat="identity",aes(fill=factor(dfuArea)), position ="dodge")+
                     scale_fill_discrete(name="Area")+
                      theme_classic(base_size = 18, base_family = "")+
                      labs(x = "Length (mm)", y="Number")+
                      theme(axis.title.y = element_text(vjust = 2),
                            axis.title.x = element_text(vjust = -1),
                            axis.line = element_line(colour = "black"),
                            panel.grid.major.x = element_blank(),
                            panel.grid.major.y =  element_line(colour="grey", size=0.5),
                            panel.border = element_rect(colour = "black", fill=NA, size=0.8),
                            legend.justification = c(1, 1), legend.position = c(1, 1),
                            legend.background = element_rect(size=0.6, linetype="solid", colour ="black"))+
              scale_x_continuous(breaks = seq(100, round_any(max(speciesDat$length), 100, f = ceiling), by = 100))
              #+ scale_y_continuous(breaks = seq(0, round_any(max(speciesDat$number), 1000, f = ceiling), by = 500))

    plot(plot1)


}

```



```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=14, fig.height=6,fig.cap="Cod length distributions", fig.pos="H"}

#THIS SECTION IS ONLY INCLUDED FOR BITS CRUISES

if (substr(cruise,1,4)=="BITS") {

    CodLimY <- round_any(max(CodPerStation$NumPerLenPerYear), 10, f = ceiling)
    CodLimX <- round_any(max(CodPerStation$length), 100, f = ceiling)

    #--------------------------------------- Function -------------------------------------------------------------
    plot_cod <- function(data,corr){
        year_cod <- min(CodPerStation$year)+corr
        plot_COD <-  ggplot(data[data$year==year_cod,], aes(x=length, y=NumPerLenPerYear)) +
                     geom_bar(stat="identity",position ="dodge",fill="steelblue")+ labs(x ='Length (mm)', y ='Number')+
                     ggtitle(year_cod)+
                     xlim(0,CodLimX)+ylim(0,CodLimY)+
                     theme_bw() + theme(strip.background = element_rect(fill = "lightgrey"),
                                      strip.text = element_text(color = "white"),
                                      plot.margin= unit(c(0, 0.3, 0, 0), "lines"), #top,left,bottom,right
                                      axis.text = element_text(size=14),
                                      axis.title = element_text(size=16),
                                      plot.title = element_text(lineheight=.8, face="bold",size=20))
        return(plot_COD)
    }
    #---------------------------------------------------------------------------------------------------------------

    for (i in 0:9) {
        assign(paste0("p_", i),plot_cod(CodPerStation,i))
    }

    grid.arrange(p_0,p_1, ncol=2)
    grid.arrange(p_2,p_3, ncol=2)
    grid.arrange(p_4,p_5, ncol=2)
    grid.arrange(p_6,p_7, ncol=2)
    grid.arrange(p_8,p_9, ncol=2)




}

```


\newpage


\setlength\arraycolsep{0.4pt}


\definecolor{lightgray}{gray}{0.9}
\renewcommand{\arraystretch}{0.8}
\rowcolors{5}{}{lightgray}

\setlength{\LTleft}{-20cm plus -1fill}
\setlength{\LTright}{\LTleft}

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE,results='asis', fig.width=14, fig.height=6,fig.cap="Preliminary abundance indices", fig.pos="H"}

#THIS SECTION IS ONLY INCLUDED FOR IBTS
round2 = function(x) trunc(x+0.5);



######  ABUNDANCE INDICES #######
if (substr(cruise,1,4)=="IBTS") {

	cat('\\newpage')

   # limits <- read.csv("X:\\Line\\Togtrapport\\Abundance_limits.csv",header=TRUE,sep=",",stringsAsFactors=FALSE)

    lim1 <- c(rep("TOR",4),rep("KUL",4),rep("HVL",4),rep("SPE",4),rep("SIL",4),rep("BRS",4),rep("MAK",4),
              rep("MSJ",4),rep("RSP",4),rep("TOR",3),rep("KUL",3),rep("HVL",3),rep("SPE",3),rep("SIL",3),
              rep("BRS",3),rep("MAK",3),rep("MSJ",3),rep("RSP",3))
    lim2 <- c(rep("G1",36),rep("G0",27))
    lim3 <- c(rep(c(1,2,3,4),9),rep(c(2,3,4),9))
    lim4 <- c(250, 330, 380, 440, 200, 270, 300, 320, 200, 230, 240, 260, 150, 150, 160, 200, 200, 210, 230, 245,
              100, 105, 130, 140, 250, 250, 300, 310, 250, 250, 330, 380,   0,   0, 190, 210, 110, 180, 230, 120,
              170, 200,  90, 170, 200, 0, 130, 140, 0, 155, 175, 0, 0, 100, 0, 170, 240, 0,220, 250, 0, 100, 120)
    limits2 <- data.frame("speciesCode"=lim1,"AgeGroup"=lim2,"Quarter"=lim3,"MaxLength"=lim4,"Group"=lim2)
    limits <- limits2
    limits$speciesCode <- as.character(limits$speciesCode)
    limits$AgeGroup <- as.character(limits$AgeGroup)
    limits_Q <- limits[limits$Quarter==Quarter,]
    limits_Q$MaxLength <- limits_Q$MaxLength/10



    channel <- odbcConnect("FishLineDW")
    Data_abund_index<- sqlQuery(channel,paste0("SELECT      A.station, A.statisticalRectangle as square, A.speciesCode, A.length/10 AS length,
                                                            A.numberTotalPerLength, SAM.fishingtime
                                                 FROM       AnimalRaised AS A INNER JOIN
                                                            SpeciesListRaised AS S ON A.speciesListRaisedId = S.speciesListRaisedId INNER JOIN
                                                            Sample AS SAM ON S.sampleId = SAM.sampleId
                                                 WHERE      (A.year = ",year,") AND (A.cruise = '",cruise,"') AND
                                                            (A.speciesCode IN ('TOR','KUL','HVL','SPE','SIL','BRS','MAK','MSJ','RSP'))
                                               ") )
    close(channel)

    Data_abund_index <- merge(Data_abund_index,species_names, by="speciesCode",all.x=TRUE)
    limits_Q <- merge(limits_Q,species_names, by="speciesCode",all.x=TRUE)


    if (Quarter %in% c(2,3,4)) {
    #Sort data into age group depending on lengths
     for (i in 1:nrow(Data_abund_index)) {
        if (Data_abund_index$length[i] < min(limits_Q[limits_Q$speciesCode==
                                                      Data_abund_index$speciesCode[i],
                                                      "MaxLength"],na.rm=TRUE)) {
              Data_abund_index$AgeGroup[i] <- min(limits_Q[limits_Q$speciesCode==
                                                             Data_abund_index$speciesCode[i],"AgeGroup"],na.rm=TRUE)
              Data_abund_index$LenRange[i] <- paste0("< ",min(limits_Q[limits_Q$speciesCode==
                                                 Data_abund_index$speciesCode[i],"MaxLength"],na.rm=TRUE))
              Data_abund_index$AgeVal[i] <- "0"
        }else if (Data_abund_index$length[i] < max(limits_Q[limits_Q$speciesCode==
                                                            Data_abund_index$speciesCode[i],"MaxLength"],na.rm=TRUE)) {
              Data_abund_index$AgeGroup[i] <- max(limits_Q[limits_Q$speciesCode==
                                                             Data_abund_index$speciesCode[i],"AgeGroup"],na.rm=TRUE)
              Data_abund_index$LenRange[i] <- paste0(min(limits_Q[limits_Q$speciesCode==Data_abund_index$speciesCode[i],
                                              "MaxLength"],na.rm=TRUE),"-",max(limits_Q[limits_Q$speciesCode==
                                               Data_abund_index$speciesCode[i],"MaxLength"],na.rm=TRUE)-1 )
              Data_abund_index$AgeVal[i] <- "1"
        }else {
              Data_abund_index$AgeGroup[i] <- "G2"
              Data_abund_index$LenRange[i] <- paste0(">= ",max(limits_Q[limits_Q$speciesCode==
                                                  Data_abund_index$speciesCode[i],"MaxLength"],na.rm=TRUE))
              Data_abund_index$AgeVal[i] <- "2+"
        }
    }

    } else if (Quarter==1) {
      for (i in 1:nrow(Data_abund_index)) {
        if (Data_abund_index$length[i] < min(limits_Q[limits_Q$speciesCode==Data_abund_index$speciesCode[i],
                                                      "MaxLength"],na.rm=TRUE)) {
              Data_abund_index$AgeGroup[i] <- min(limits_Q[limits_Q$speciesCode==Data_abund_index$speciesCode[i],
                                                           "AgeGroup"],na.rm=TRUE)
              Data_abund_index$LenRange[i] <- paste0("< ",
                                                min(limits_Q[limits_Q$speciesCode==Data_abund_index$speciesCode[i],
                                                "MaxLength"],na.rm=TRUE))
              Data_abund_index$AgeVal[i] <- "1"
        }else {
              Data_abund_index$AgeGroup[i] <- "G2"
              Data_abund_index$LenRange[i] <- paste0(">= ",max(limits_Q[limits_Q$speciesCode==
                                                  Data_abund_index$speciesCode[i],"MaxLength"],na.rm=TRUE))
              Data_abund_index$AgeVal[i] <- "2+"
        }
    }




  }

#detach(package:Hmisc)

    DI <- ddply(Data_abund_index, .(station,square,Species,AgeGroup,LenRange,AgeVal), summarize,
                AIndex=round2(sum(numberTotalPerLength*60/fishingtime)))

    fullDI <- expand.grid(Species=levels(factor(DI$Species)),
                          AgeGroup=levels(factor(DI$AgeGroup)),station=NA,square=NA,AIndex=NA,AgeVal=NA,LenRange=NA)
    fullDI <- merge(DI,fullDI, all=T)
    fullDI <- fullDI[!(duplicated(fullDI[3:4]) & is.na(fullDI$AIndex)),]

    for (i in 1:nrow(fullDI)) {
        if (fullDI$AgeGroup[i]=="G0" & is.na(fullDI$station[i])) {
              fullDI$LenRange[i] <- paste0("< ",min(limits_Q[limits_Q$Species==fullDI$Species[i],4],na.rm=TRUE) )
              fullDI$AgeVal[i] <- "0"
        }else if (fullDI$AgeGroup[i]=="G1" & is.na(fullDI$station[i])) {
              fullDI$LenRange[i] <- paste0(min(limits_Q[limits_Q$Species==fullDI$Species[i],4],na.rm=TRUE),
                                                     "-",max(limits_Q[limits_Q$Species==fullDI$Species[i],4],na.rm=TRUE)-1 )
              fullDI$AgeVal[i] <- "1"
        }else if (fullDI$AgeGroup[i]=="G2" & is.na(fullDI$station[i])){
              fullDI$LenRange[i] <- paste0(">= ",max(limits_Q[limits_Q$Species==fullDI$Species[i],4],na.rm=TRUE))
              fullDI$AgeVal[i] <- "2+"
        }
    }

    fullDI <- fullDI[!(fullDI$Species=="Sprat" & fullDI$AgeGroup=="G0"),]
    Abundance1 <- dcast(fullDI, station+square ~ Species+AgeGroup, value.var="AIndex")
    Abundance1 <-  Abundance1[!is.na(Abundance1$station),]
    Abundance1[is.na(Abundance1)] <- 0


    test1 <- unique(fullDI[c("Species","AgeGroup","LenRange","AgeVal")])
    test2 <- melt(test1, id.vars=c("Species","AgeGroup"))
    test3 <- dcast(test2, variable ~ Species+AgeGroup,value.var="value")


    Table_out <- Abundance1

    if (Quarter %in% c(2,3,4)) {
        colnames(Table_out) <- c("Station","\\makecell[cb]{\\it{Age} \\\\ \\it{Length cm} \\\\ \\quad \\\\ Square }",
                           paste0("\\makecell[cb]{",test3[2,2:27],"\\\\",test3[1,2:27],"\\\\ \\quad \\\\  \\quad }") )

    } else {
        colnames(Table_out) <- c("Station","\\makecell[cb]{\\it{Age} \\\\ \\it{Length cm} \\\\ \\quad \\\\ Square }",
                           paste0("\\makecell[cb]{",test3[2,2:19],"\\\\",test3[1,2:19],"\\\\ \\quad \\\\  \\quad }") )
    }

  library(Hmisc)




  if (Quarter==1) {
    cat('\\renewcommand{\\tabcolsep}{4pt}')
    mylatex(Table_out,file='',cgroup= c("","","Cod","Haddock","Herring","Mackeral","Noray pout","Plaice","Saithe","Sprat","Whiting"),
             rowname=NULL,n.cgroup = c(1,1,rep(2,9)),booktabs =T,longtable=TRUE,size="scriptsize",lines.page=4000,where='H',
             caption="Preliminary abundance indices for cod, haddock, herring, mackeral, norway pout, plaice, saithe, sprat and whiting.",
             col.just = c("l","c","|r","r","|r","r","|r","r","|r","r","|r","r","|r","r","|r","r","|r","r","|r","r"),landscape=TRUE)
  }else {
    cat('\\renewcommand{\\tabcolsep}{2pt}')
    mylatex(Table_out,file='',cgroup= c("","","Cod","Haddock","Herring","Mackeral","Noray pout","Plaice","Saithe","Sprat","Whiting"),
            rowname=NULL,n.cgroup = c(1,1,rep(3,7),2,3),booktabs =T,longtable=TRUE,size="tiny",lines.page=4000,where='H',landscape=TRUE,
            caption="Preliminary abundance indices for cod, haddock, herring, mackeral, norway pout, plaice, saithe, sprat and whiting.",
            col.just = c("l","c","|r","r","r","|r","r","r","|r","r","r","|r","r","r","|r","r","r","|r","r","r","|r","r","r","|r","r","|r","r","r"))
  }

}

```
