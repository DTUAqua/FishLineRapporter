---
fontsize: 12pt
geometry: margin=1in
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{floatrow}
- \usepackage[T1]{fontenc}
- \usepackage[danish]{babel}
- \usepackage[utf8]{inputenc}
- \usepackage{graphicx}
- \floatsetup[table]{capposition=top}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhf{}
- \usepackage[table]{xcolor}
- \usepackage{ragged2e}
- \usepackage{catchfile}
- \usepackage{array}
- \usepackage[export]{adjustbox}
- \usepackage{multirow}
- \linespread{1.15}
- \usepackage{tabularx}
- \usepackage{tcolorbox}
- \usepackage{lipsum}
output:
  pdf_document: default
  word_document: default
---

\renewcommand{\familydefault}{\sfdefault}
\sffamily


```{r set_libraries, include=FALSE}
#Libraries
if (!require(pacman)) {
  install.packages("pacman", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(pacman)
}

p_load(sqldf,RODBC,plyr,dplyr,stringr,xtable,ggmap,gplots,grid,ggrepel,reshape2,
       marmap,sf,ggrepel,lwgeom,rgdal,mapplots,maptools,shapefiles)



```
 

 
```{r define_input, echo=FALSE}

#Parameters
# year<- @paramYear
# cruise <- @paramCruise
# trip <- @paramTrip
# input_art_multiplot <- c(@paramMultiSpecies) #Art (multiplot)
# input_art <- c(@paramSpecies)  #Art (længdefordeling)
# hilsen <- c(@paramHilsen)  #hilsen
# species_individ <- c(@paramSpecLW)
# coast_string <- 'europe_simple_wgs84.shp'
# dk_eez_string <- 'eez_dk_line.shp'
# ices_areas_string <- "ICES_areas.shp"
# ices_sq_string <- "ices_squares.shp"
# KVARTAL <- @paramQuarter
# AREA <- @paramArea
# FID <- @paramFid


year<- 2019
cruise <- 'SEAS'
trip <- 1718

channel <- odbcConnect("FishLineDW")
 multiplot <- sqlQuery(channel, sprintf("select distinct speciesCode from animal where year = %s and cruise = '%s' and trip = '%s' ",year,cruise,trip),stringsAsFactors=FALSE)
individ <- sqlQuery(channel,
                            paste(sprintf("SELECT A.speciesCode FROM FishLineDW.dbo.Animal A LEFT OUTER JOIN FishLine.dbo.L_Species s ON s.speciesCode = A.speciesCode WHERE A.year = %s   AND A.cruise = '%s'   AND A.trip = '%s'   AND A.individNum != 0 GROUP BY  s.dkName, A.speciesCode ORDER BY A.speciesCode",year,cruise,trip)),
                            stringsAsFactors=FALSE)
close(channel)

species_individ <- individ$speciesCode
input_art_multiplot <- multiplot$speciesCode
input_art <-  input_art_multiplot
hilsen <- ""
coast_string <- "M:/123 - FiskeLine/Rapporter/Rapporter/kort/europe_simple_wgs84.shp"
dk_eez_string <- "M:/123 - FiskeLine/Rapporter/Rapporter/kort/eez_dk_line.shp"
ices_areas_string <- "M:/123 - FiskeLine/Rapporter/Rapporter/kort/ICES_areas.shp"
ices_sq_string <- "M:/123 - FiskeLine/Rapporter/Rapporter/kort/ices_squares.shp"

```






```{r include=FALSE, cache=FALSE}

########## Collecting data from Fishline ###########

query1<-paste("SELECT Trip.year,Trip.contactPersonName,Trip.contactPersonId , Trip.trip, Trip.cruise, tripLeaderName, dateStart, dateEnd, platform1
              FROM Trip
              WHERE     (Trip.year = ",year," and Trip.trip = '",trip,"' and Trip.cruise='",cruise,"')"
             ,sep = "")
query1

query2<-paste("SELECT AnimalRaised.trip, AnimalRaised.year, AnimalRaised.speciesCode, AnimalRaised.landingCategory, 
              AnimalRaised.numberTotalPerLength, AnimalRaised.length, AnimalRaised.station
              FROM AnimalRaised
              WHERE     (AnimalRaised.year=",year," and AnimalRaised.trip = '",trip,"'and AnimalRaised.cruise='",cruise,"')"
              ,sep = "")
query2



query3<-paste("SELECT SpeciesListRaised.trip, SpeciesListRaised.year, SpeciesListRaised.speciesCode, SpeciesListRaised.landingCategory, SpeciesListRaised.numberTotal, SpeciesListRaised.weightTotal, SpeciesListRaised.station, SpeciesListRaised.numberSubSample AS speciesList_numberSubSample,
SpeciesListRaised.speciesListRaisedId as ID
   FROM         SpeciesListRaised INNER JOIN
                      Sample ON SpeciesListRaised.sampleId = Sample.sampleId
              WHERE     (SpeciesListRaised.year=",year," and SpeciesListRaised.trip = '",trip,"'and SpeciesListRaised.cruise='",cruise,"')"
              ,sep = "")
query3


query4<-paste("SELECT Sample.station, Sample.fishingtime, Sample.latPosStartDec AS lat, Sample.lonPosStartDec AS lon, Sample.catchRegistration, Sample.speciesRegistration,Sample.gearType,
  				  Sample.selectionDevice,Sample.meshSize, Sample.dfuArea, Sample.statisticalRectangle, Sample.quarterGearStart,Sample.latPosEndDec AS latEnd, Sample.lonPosEndDec AS lonEnd
              FROM Sample
              WHERE     (Sample.year=",year," and Sample.trip = '",trip,"' and Sample.cruise='",cruise,"')"
              ,sep = "")
query4

query3b<-paste("SELECT SpeciesList.trip, SpeciesList.year,SpeciesList.station,  SpeciesList.speciesCode, 
                       SpeciesList.landingCategory,SpeciesList.number,SpeciesList.speciesListId as ID
                FROM   SpeciesList INNER JOIN
                       Sample ON SpeciesList.sampleId = Sample.sampleId
                WHERE  (SpeciesList.year=",year," and SpeciesList.trip = '",trip,"'and SpeciesList.cruise='",cruise,"' and 
                       SpeciesList.weightStep0 IS NOT NULL)"
              ,sep = "")
query3b


#Importing data
#data1: Metadata; observator, skipper, dato mm.
#data2: arter,  landingskategori, antaltotal, langder
#data3: arter, landingskategori, antaltotal, vagttotal
#data3: alle stationer pa turen
channel <- odbcConnect("FishLineDW")
data1 <- sqlQuery(channel, paste(query1),stringsAsFactors=FALSE)
data2 <- sqlQuery(channel, paste(query2),stringsAsFactors=FALSE)
data3 <- sqlQuery(channel, paste(query3),stringsAsFactors=FALSE)
data3b <- sqlQuery(channel, paste(query3b),stringsAsFactors=FALSE)
data4 <- sqlQuery(channel, paste(query4),stringsAsFactors=FALSE)
close(channel)


query5<-paste("SELECT Person.name, Person.Address, Person.zipTown, Person.personId
              FROM Person
              WHERE     (Person.personId='",data1$contactPersonId,"')"
              ,sep = "")
query5
query6<-paste("SELECT L_Species.speciesCode, L_Species.dkName
              FROM L_Species"
              ,sep = "")
query6
query7<-paste("SELECT L_GearType.gearType, L_GearType.catchOperation
              FROM L_GearType"
              ,sep = "")
query7

#data5: Metadata; skipper, skipper adresses, skipper postnummer+by.
#data6: artskoder, dk_arter
channel <- odbcConnect("FishLine")
data5 <- sqlQuery(channel, paste(query5),stringsAsFactors=FALSE)
data6 <- sqlQuery(channel, paste(query6),stringsAsFactors=FALSE)
data7 <- sqlQuery(channel, paste(query7),stringsAsFactors=FALSE)
close(channel)



```

```{r minimum_landing_size, include=FALSE, cache=FALSE} 

areatable <- 
    data.frame(dfuArea = c("22","23","24","25","26","27","28","29","30","31","32","4A","4B","4C","20","21",NA),
               farvand = c("Vestlige Østersø","Vestlige Østersø","Vestlige Østersø","Østlige Østersø","Østlige Østersø","Østlige Østersø","Østlige Østersø","Østlige Østersø", "Østlige Østersø", "Østlige Østersø", "Østlige Østersø", "Nordsøen","Nordsøen","Nordsøen","Skagerrak","Kattegat","Andre områder"),
               stringsAsFactors = F)
areatable$farvand2 <- factor(areatable$farvand, levels = c("Nordsøen","Kattegat","Skagerrak","Vestlige Østersø","Østlige Østersø","Andre områder"))

# data <- left_join(data0, areatable, by = "dfuArea")


MLS <- data.frame("art" = c("Brill","Cod","Dab","Flounder","Haddock","Hake","Herring","Ling","Atlantic mackerel","Nephrops","Plaice","Saith","Salmon","Sole","Trout","Turbut","Whiting"),
"speciesCode"	= c("SLH","TOR","ISG","SKR","KUL","KLM","SIL","LNG","MAK","DVH","RSP","MSJ","LKS","TNG","ORD","PGH","HVL"),
"Skagerrak" = c(30,30,25,25.5,27,30,18,NA,20,13,27,30,60,24,40,30,23),
"Kattegat" = c(30,30,25,25.5,27,30,18,NA,20,13,27,30,60,24,40,30,23),
"Nordsøen" = c(30,35,25,25.5,30,27,20,30,30,8.5,27,35,60,24,40,30,27),
"Vestlige_Østersø" = c(30,35,25,23,27,30,NA,NA,NA,13,25,30,60,24,40,30,NA),
"Østlige_Østersø" = c(30,35,25,23,27,30,NA,NA,NA,13,25,30,60,24,40,30,NA),
note = NA)


MLS2010 <- tidyr::gather(MLS,area, length, -note, -speciesCode, -art)
MLS2010$note[MLS2010$speciesCode=="SKR" & MLS2010$area=="Baltic"] <- "23 in SD 22-25"
MLS2010$length_mm <- MLS2010$length*10

```



```{r adjust_letters, echo=FALSE}

#Function to adjust letters 

capwords <- function(s, strict = FALSE) {
    cap <- function(s) paste(toupper(substring(s, 1, 1)),
                  {s <- substring(s, 2); if(strict) tolower(s) else s},
                             sep = "", collapse = " " )
    sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))  }

#nice date formats
start_date <- gsub(" 0", "", 
                   paste("",format(as.POSIXct(data1$dateStart,
                                              tz = "Europe/Copenhagen"),
                                   "%d. %B %Y")))
end_date <- gsub(" 0", "", 
                 paste("",format(as.POSIXct(data1$dateEnd,
                                            tz = "Europe/Copenhagen"), 
                                 "%d. %B %Y")))
if (start_date==end_date) {end_date <- ""} else {end_date <- paste("- ",end_date,sep="")}

#Skipper
skipper <- 'Fiskeskipper'
if(is.na(data1$contactPersonName)==F) { skipper <- capwords(toString(data1$contactPersonName), strict=TRUE) }
#Observatør
if(is.na(data1$tripLeaderName)==F) { obs <- capwords(toString(data1$tripLeaderName), strict=TRUE) ;
                           observator <- obs
} else {observator="-"} 


h1 <- paste("Den ",start_date," ",end_date," var en af DTU Aquas medarbejdere med ombord på din kutter for at indsamle oplysninger om fangsten til brug i vores vurderinger af, hvor store fiskebestandene er.",sep="")
h2 <- "Vi vil gerne takke for, at du ville have os med og håber ikke, at det var til alt for meget besvær. Vi er overbeviste om, at det på lang sigt er en fordel for fiskeriet, at de data, som bliver brugt i bestandsvurderingerne, er så gode som muligt, og det kræver, at vi også kan indsamle oplysninger direkte fra kutterne."

if (hilsen=="") {
	hilsen1 <- h1; hilsen2 <- h2; hilsen3 <- ""
		} else {hilsen1 <- hilsen; hilsen2 <- ""; hilsen3 <- "Vi er overbeviste om, at det på lang sigt er en fordel for fiskeriet, at de data, som bliver brugt i bestandsvurderingerne, er så gode som muligt, og det kræver, at vi også kan indsamle oplysninger direkte fra kutterne." }

if (length(species_individ)>0) {
	fig_LW <- "På de sidste figurer er vist forholdet mellem længde og vægt for udvalgte arter. 
			   Resultaterne holdes op imod DTU Aquas øvrige database fra tilsvarende kvartal og område siden 2010." 
} else {fig_LW <- ""}


test <- merge(data4,data7)
mesh <- ifelse(!is.na(data4$meshSize[1]),paste0(data4$meshSize[1]," mm"), "-")
selection <- ifelse(!is.na(data4$selectionDevice[1]),data4$selectionDevice[1], "-")
CatchType <- merge(data4,data7)
catchOperation <- ifelse(unique(CatchType$catchOperation) %in% c("A","G","C","E"),"træk","stationer")
catchOperation <- ifelse(unique(CatchType$catchOperation) %in% c("D"),"kast",catchOperation)

catchOperation2 <- ifelse(catchOperation=="stationer","station",catchOperation)
catchOperation3 <- paste(toupper(substr(catchOperation2, 1, 1)), substr(catchOperation2, 2, nchar(catchOperation2)), sep="")
if (catchOperation3=="Træk") {catchOperation3 <- "Nummer"}


```



<!-- define header -->
 
\lhead{\footnotesize Tur nummer: `r trip`, `r start_date`  `r end_date`}
\rhead{\footnotesize Observat\o r: `r observator`}
\lfoot{\footnotesize Udskrevet: \today }

```{r , include=F}
# coast <- st_read(coast_string) %>% st_transform(crs=4326)
# dkeez <- st_read(dk_eez_string) %>% st_transform(crs=4326)
# ices_areas <- st_read(ices_areas_string) %>% st_transform(crs=4326)
# ices_sq <- st_read(ices_sq_string) %>% st_transform(crs=4326)  

coast <- read.shapefile(substr(coast_string,start = 0,stop = nchar(coast_string)-4))
ices_areas <- read.shapefile(substr(ices_areas,start = 0,stop = nchar(ices_areas)-4))
map <- NULL
  
```

```{r, echo=FALSE, include=FALSE}
pos <- matrix(c(position$lon,position$lat,position$lonEnd,position$latEnd),
            ncol=4,dimnames = list(position$station,NULL))
set.seed(42)
pdf("tripmap3.pdf")
# col <- terrain.colors(13)
# 
# # plot.new()
# # plot(pos[,1],pos[,2])
# 
basemap(xlim=xlim, ylim=ylim, main = "",
        xlab=expression("Grader nordlig bredde"),
        ylab=expression("Grader østlig længde"),bg = "lightblue" ) #, bg="white")
draw.rect(col="grey")
draw.shape(ices_areas, col="transparent",border="grey40", xlim=xlim, ylim=ylim)
draw.shape(coast, col="cornsilk", border="grey40", xlim=xlim, ylim=ylim)
par(cex = 1)
segments(x0=pos[,1], y0=pos[,2], x1=pos[,3], y1=pos[,4],
         cex=0.8, length = .05,col="blue")
points(x = pos[,1], y =pos[,2], pch=16, col="red", cex=.8)
points(x =pos[,3], y = pos[,4], pch=24, col="black",bg="green", cex=.8)
# wordcloud::textplot(x=pos[,1]-.3, y=pos[,2],words = rownames(pos),
#          show.lines = T,new = F,cex=.8)
# spread.labels(pos[,1],pos[,2],labels = rownames(pos),cex=.8)
pos <- cbind(pos,rep(min(pos[,1],na.rm = T)-1,nrow(pos)))
tmp.y <- sort(as.vector(spread.labs(pos[,2],mindiff = .1,min = min(ylim),
                                    max=max(ylim))),decreasing = T)
pos <- cbind(pos,tmp.y)
midx <- numeric()
midy <- numeric()
for (i in 1:nrow(pos)){
  a <- midPoint(p1 = c(pos[i,1],pos[i,2]), p2=c(pos[i,3],pos[i,4]))
  midx <- rbind(midx,a[,1])
  midy <- rbind(midy,a[,2])
}
pos <- cbind(pos,midx,midy)
# station numbers ----
# textbox(x = pos[,5], y= pos[,6], textlist = rownames(pos),justify = "l",
#         fill = "white",cex = .9,adj=c(0,.2),border = "white")
# graphics::text(x=pos[,5],y=pos[,6],labels=rownames(pos),cex=1,col="#7F0799")
# legend(x=pos[,5],y=pos[,6],rownames(pos),cex=1,box.col=c("white"))
# segments(x0=pos[,7],x1=pos[,5]+.4,y0=pos[,8],y1=pos[,6],col = "grey60")
legend(x="bottomright",legend=c("ICES-område","ICES-kvadrat",
                                "Station start","Station","Station slut"),
       lty=c(1,2,0,1,0),pch=c(NA,NA,16,NA,24),
       col = c("grey40","grey","red","blue","black"),cex = 0.9, 
       pt.bg=c("white","white","white","white","green") ,bg=c("white"))

dev.off()
}

```

```{r, echo=FALSE, include=FALSE}
#  
# a <- vector()
#   
# for (l in LETTERS[2:8]){
#         for (n in seq(0,9,1)){
#           a <- c(a,paste0(l,n))
#         }
#    }
# labels <- data.frame(x = seq(-44,29,1),
#                      ices = c(paste0("A",seq(0,3,1)),a),
#                      stringsAsFactors = F)
# 
# #------------Frontpage figure----------------------------
# 
# 
# # position <- data4[complete.cases(data4[,c(3:8,1,13,14)]),c(3:8,1,13,14)]
# position <- data4 %>% 
#   dplyr::select(station,lat,lon,latEnd,lonEnd) %>% 
#   dplyr::arrange(station) %>% 
#   # this is not the super correct way of finding a midpoint, 
#   # but it works sufficiently for out needs
#   dplyr::mutate(latMid = (lat+latEnd)/2,
#                 lonMid = (lon+lonEnd)/2)
# 
# pdf("tripmap3.pdf")
# set.seed(42)
# 
# ylim <- c(min(c(position$lat,position$latEnd)-.25,na.rm=T),
#               max(c(position$lat,position$latEnd),na.rm=T))
# xlim <- c(min(c(position$lon,position$lonEnd)-.5,na.rm=T),
#               max(c(position$lon,position$lonEnd),na.rm=T)+.5)
# 
# 
# ia_centroid <- ices_areas %>%
#   st_make_valid() %>% 
#   st_crop(xmin = min(xlim), xmax = max(xlim), 
#           ymin = min(ylim), ymax = max(ylim)) 
#   
# 
# iac <- cbind(ia_centroid,
#                  st_coordinates(st_centroid(ia_centroid)))
# st_geometry(iac)<-NULL
# iac2 <- iac %>% 
#   dplyr::select(ICES_SUB,X,Y) %>% 
#   dplyr::mutate(type = "ICES area")
# 
# 
# 
# 
# isc <- ices_sq %>% 
#   st_crop(xmin = min(xlim)-.5, xmax = max(xlim)+.5,
#           ymin = min(ylim)-.25, ymax = max(ylim)+.25)
# isc2 <- cbind(isc, st_coordinates(st_centroid(isc)))
# 
# 
# set.seed(42)
# pdf("tripmap3.pdf")
# # col <- terrain.colors(13)
# # 
# # # plot.new()
# # # plot(pos[,1],pos[,2])
# # 
# basemap(xlim=xlim, ylim=ylim, main = "",
#         xlab=expression("Grader nordlig bredde"),
#         ylab=expression("Grader østlig længde"),bg = "lightblue" ) #, bg="white")
# draw.rect(col="grey")
# draw.shape(ices_areas, col="transparent",border="grey40", xlim=xlim, ylim=ylim)
# draw.shape(coast, col="cornsilk", border="grey40", xlim=xlim, ylim=ylim)
# par(cex = 1)
# segments(x0=pos[,1], y0=pos[,2], x1=pos[,3], y1=pos[,4],
#          cex=0.8, length = .05,col="blue")
# points(x = pos[,1], y =pos[,2], pch=16, col="red", cex=.8)
# points(x =pos[,3], y = pos[,4], pch=24, col="black",bg="green", cex=.8)
# wordcloud::textplot(x=pos[,1]-.3, y=pos[,2],words = rownames(pos),
#          show.lines = T,new = F,cex=.8)
# spread.labels(pos[,1],pos[,2],labels = rownames(pos),cex=.8)
# pos <- cbind(pos,rep(min(pos[,1],na.rm = T)-1,nrow(pos)))
# tmp.y <- sort(as.vector(spread.labs(pos[,2],mindiff = .1,min = min(ylim),
#                                     max=max(ylim))),decreasing = T)
# pos <- cbind(pos,tmp.y)
# midx <- numeric()
# midy <- numeric()
# for (i in 1:nrow(pos)){
#   a <- midPoint(p1 = c(pos[i,1],pos[i,2]), p2=c(pos[i,3],pos[i,4]))
#   midx <- rbind(midx,a[,1])
#   midy <- rbind(midy,a[,2])
# }
# pos <- cbind(pos,midx,midy)

dev.off()




# p <- ggplot()+
#   
#   geom_sf(data = isc2, #col = "grey60",
#           fill="lightblue",
#           aes(linetype = "ICES square",size = "ICES square",col="ICES square"))+
#   # geom_sf(data = ices_areas,#col = "grey40",
#   #         fill=NA,
#   #         aes(linetype = "ICES område",size = "ICES område",col="ICES område")) +
#   # geom_sf(data = coast, fill="cornsilk") +
#   # geom_sf(data = dkeez, aes(linetype = "DK EEZ",size="DK EEZ",col="DK EEZ")) +
#   coord_sf(xlim = xlim, ylim = ylim,crs = 4326) +
#   
#   geom_segment(data=position,aes(x = lon, xend = lonEnd, y= lat,
#                                  yend=latEnd,group=station,
#                                  col="Station",linetype="Station",size="Station"),
#                fill=NA)+#,
#                # colour="darkblue")+
#   geom_point(data=position, 
#              aes(x=lon,y=lat,fill="Start",shape="Start"))+
#   geom_point(data=isc2, aes(x=X,y=Y),alpha=1)+
#   geom_point(data=position, aes(x=lonEnd,y=latEnd,fill="Slut",shape="Slut"))+
#   
#   # geom_text(data = iac, aes(label=ICES_SUB2,x=X,y=Y),col="grey40")+
#   # geom_text(data = isc2, aes(label = ICESNAME, x=X,y=Y),col="grey70")+
#   
#   geom_text_repel(data=position,
#                   aes(x=lonMid,y=latMid,label=station),alpha=.8,
#                   segment.color = "grey50",force = 50)+
#   scale_color_manual(values = c("DK EEZ"="red","ICES square"="grey40",
#                                 "ICES område"="grey60","Station"="darkblue"))+
#   scale_fill_manual(values = c("Start" = "red","Slut"= "green"),
#                     guide = guide_legend(reverse=TRUE))+
#   scale_shape_manual(values = c("Start"= 24, "Slut" = 21),
#                      guide = guide_legend(reverse=TRUE))+
#   scale_size_manual(values = c("ICES square" = 0.25, "ICES område" = .5,
#                                "DK EEZ"=.25,"Station"=.5))+
#   scale_linetype_manual(values = c("ICES square" = "solid", "ICES område" = "twodash",
#                                    "DK EEZ" = "solid","Station"="solid"))+
#   # scale_y_continuous(sec.axis = dup_axis())+
#   # sec_axis(trans = ~ (.-36+.5)*2,
#   #                   name="ICES lat"))+
#   scale_x_continuous(sec.axis = dup_axis(labels = labels$ices,
#                                          name = ""))+##trans = ~ floor(./10)+4))+
#                               # breaks = seq(from=min(xlim),to=max(xlim), by=1),
#                               # name="ICES lon")+
#   labs(y = "Grader nordlig bredde",
#        x = ifelse(min(xlim)>0,"Grader østlig længde","Grader vestlig længde"),
#        shape = "Station",color="",fill="Station",linetype="",size="")+
#   theme_bw()
  # theme(#axis.ticks.length = unit(3, "cm"),
  #       legend.position = "none"
  #       )


# 
# plot(p)
# 
# 
# dev.off()
# }




```




\thispagestyle{empty}

<!-- Fisker Adressefelt -->

`r if(exists("data1") && !is.na(data1[1,9])==TRUE) {toupper(toString(data1[1,9]))}` \
`r if(exists("data5") && !is.na(data5[1,1])==TRUE) {capwords(toString(data5[1,1]), strict=TRUE)}` \
`r if(exists("data5") && !is.na(data5[1,2])==TRUE) {capwords(toString(data5[1,2]), strict=TRUE)}` \
`r if(exists("data5") && !is.na(data5[1,3])==TRUE) {capwords(toString(data5[1,3]), strict=TRUE)}` \




\pagebreak



<!-- definere forside -->

\begin{titlepage}

        
        \vspace{-1cm}

        \textbf{\Huge Fangstrapport}
        
        \vspace{0.5cm}
        \textbf{Tur nummer: `r trip`}
        
        \vspace{1.5cm}

        Foretaget den: `r start_date`  `r end_date`\\
        Fartøj: `r data1[1,9]`\\
        Observatør: `r observator`

\vspace{0.7cm}   

\begin{figure}[H]
        \centering
        \includegraphics[width=0.8\textwidth]{tripmap3.pdf}
\end{figure}

\vspace{-1cm}       
\vfill
              
        DTU Aqua\\
        Sektion for Monitering og Data\\
        Kemitorvet 201\\
        2800 Kgs. Lyngby
        

\end{titlepage}


\pagebreak

<!-- Brev til fiskeskipper -->

\raggedright

\vspace*{-0.8cm}

\section{FANGSTRAPPORT}

\vspace{0.1cm}



\renewcommand{\arraystretch}{1.5}
\begin{tabularx}{\textwidth}{@{}lXr@{}}
\textbf{Til} & `r skipper`&\\ 
\textbf{Vedr.} & Observatørdeltagelse på din kutter&\\
\textbf{Fra} & DTU Aqua &  \today
\end{tabularx}


\vspace{0.2cm}

\inputencoding{utf8}

\subsection{Kære `r skipper`}

\vspace{0.1cm}

`r hilsen1`\
\vspace{0.1cm}
`r hilsen2`

\vspace{0.2cm}

\textbf{Du får en oversigt over de oplysninger, vi indsamlede}\
`r hilsen3`
For at give dig en tilbagemelding fra turen, får du her en oversigt over de oplysninger, som vi indsamlede:

\underline{Kortet}\
Kortet først i rapporten viser, hvor vi indsamlede oplysningerne.

\underline{Tabellerne}\
Den første tabel viser antal og vægt af fangsterne på turen, både hvad der blev landet, og hvad der blev genudsat. Den anden tabel viser fangsterne per time. Over hver tabel er indholdet forklaret. Vægten er angivet for urensede fisk. 

\underline{Figurerne}\
Første figur viser vægten af de arter, som er vist i tabellerne - fordelt på discard og konsum. De næste figurer viser længdefordelingen af de vigtigste arter i fangsten - fordelt på discard og konsum. `r fig_LW`

Alle arter er længdemålt i centimeter, undtagen jomfruhummer og rejer, som er angivet i millimeter. Fiskenes aldersfordeling er ikke med i rapporten, da aldersaflæsning først foretages senere. Figurerne viser derfor kun fiskenes længde.

\vspace{0.2cm}

\textbf{Det bruger vi oplysningerne til}\
Oplysningerne om fangsten bliver brugt i vurderingerne af, hvor store fiskebestandene er. I vores beregninger indgår information om antal fisk per art, vægten af fiskene og alderen. 

Oplysningerne fra en enkelt tur bliver ikke brugt alene. Vi samler alle oplysninger fra alle ture inden for et kvartal og et område, når vi laver beregningerne.  

\vspace{0.2cm}

\textbf{Oplysningerne fra din kutter er vigtige}\
De oplysninger, vi har indsamlet ombord på din kutter, er med til at øge vores forståelse af bestandene og indgår i bestandsvurderingerne sammen med indsamlinger fra havnene og fra vores egne togter. 

Det betyder, at det er vigtigt, at du fisker på samme måde, når vi er med ude til søs, som når du fisker en hvilken som helst anden dag. Vores hovedinteresse er at få så korrekte data som muligt, så bestandsvurderingerne kan blive så rigtige som muligt.

\vspace{0.2cm}

\textbf{Har du spørgsmål?}\
Hvis du har spørgsmål om rapporten, eller har du forslag til forbedringer af rapporten, kan du ringe til Frank Hansen på tlf. 3588 3363 (indre danske farvande) eller Aage Thaarup på tlf. 3588 3248 (Nordsøen og Skagerrak).


\vspace{0.4cm}

Med venlig hilsen\
DTU Aqua

\vspace{2cm}

<!-- \begin{tcolorbox}[colback=white!5,colframe=blue!40!black,title=Information om turen] -->
\renewcommand{\arraystretch}{1.2}
\begin{tabularx}{\textwidth}{@{}lXr@{}}
\textbf{Dato og Tid} & `r start_date`  `r end_date` &\\ 
\textbf{Område} & `r data4$dfuArea[1]`&\\
\textbf{Antal `r catchOperation`} & `r nrow(data4)`&\\
\textbf{Redskab} & `r data4$gearType[1]` &\\
\textbf{Maskevidde} & `r mesh` &\\ 
\textbf{Selektionsredskab} & `r selection` & 
\end{tabularx}
<!-- \end{tcolorbox} -->


\pagebreak

```{r, echo=FALSE, include=FALSE, cache=FALSE}

#####Data for table 1 and plots of collected catch #####


data3 <- merge(data3,data3b,all.x=TRUE)

data3$landingCategory <- ifelse(data3$speciesCode %in% c("AF1","AF2","AF3","AF4","AF5"), 
                                "KON", 
                                data3$landingCategory)

data3[data3$numberTotal==0,"numberTotal"] <- data3[data3$numberTotal==0,]$number

#List of stations to ensure using only those where all landings have been evaluated
SL <- as.matrix(apply(as.matrix(data4[,c(1,5,6)]), 1, function(x) if (is.na(x[2])==FALSE & x[2] =="ALL" & x[3] =="ALL") { x[1] }))
station_list <- as.numeric(data.frame(SL)[data.frame(SL)[1]!='NULL'])

#Subsets of data for evaluated stations only
data3_summed_stat <- subset(data3, data3$station %in% station_list & landingCategory!="IND", drop=TRUE)
data3_summed_stat$numberTotal <- ifelse(data3_summed_stat$numberTotal==0,data3_summed_stat$speciesList_numberSubSample,data3_summed_stat$numberTotal)

#summere data3 mht landinskategori og art
data3_summed1 <- ddply(data3_summed_stat, 
                       c("landingCategory", "speciesCode"),
                       plyr::summarize,
                       numberTotal= sum(numberTotal),
                       weightTotal= sum(weightTotal))

#Expand to include KON and DIS for all species
expand1 <- expand.grid(speciesCode=levels(factor(data3_summed1$speciesCode)),
                       landingCategory=c("DIS","KON"),
                       numberTotal=0,
                       weightTotal=0)
expand2 <- rbind(data3_summed1,expand1)
data3_summed <- plyr::ddply(expand2,
                            c("landingCategory", "speciesCode"),
                            plyr::summarize,
                            numberTotal= sum(numberTotal),
                            weightTotal= sum(weightTotal))

#Reshape into wide format depending on landing category
data3_summed2 <- reshape(data3_summed,
                         timevar = "landingCategory",
                         idvar = c("speciesCode"),
                         direction = "wide")
data3_summed3 <- merge(data3_summed2,data6,by="speciesCode", all.x=TRUE)

#Subsetting af data i hovedarter (data3_summed_sub) og ovrige arter (data3_summed_os)
data3_summed_sub <- data3_summed3[data3_summed3$speciesCode %in% input_art_multiplot,
                                  c("dkName","numberTotal.KON",
                                    "numberTotal.DIS","weightTotal.KON",
                                    "weightTotal.DIS")]
# data3_summed_sub <- data3_summed_sub %>% arrange(desc(weightTotal.KON))


data3_summed_os<- data3_summed3[!(data3_summed3$speciesCode %in% input_art_multiplot),
                                c("dkName","numberTotal.KON",
                                  "numberTotal.DIS","weightTotal.KON",
                                  "weightTotal.DIS")]


###### Forberede tabel 1: art, antal_landet, antal_genudsat, vagt_landet, vagt_genudsat, proc_antal, proc_vagt.

#Add row of "other species" and their summed weight
finalData1 <- rbind(data3_summed_sub,
                    data.frame("dkName"="Øvrige arter",
                               "numberTotal.KON"=NA,
                               "numberTotal.DIS"=NA,
                               "weightTotal.KON"= 
                        sum(data3_summed_os$weightTotal.KON),
                        "weightTotal.DIS"=sum(data3_summed_os$weightTotal.DIS))) 

finalData1 <- finalData1 %>% arrange(desc(weightTotal.KON),desc(weightTotal.DIS))
#Add row of total catch/discard
SumRows <- data.frame("dkName"=c(NA,"Alle arter"),"numberTotal.KON"=c(NA,NA), "numberTotal.DIS"=c(NA,NA), "weightTotal.KON"= 
                        c(NA,sum(finalData1$weightTotal.KON)),"weightTotal.DIS"=c(NA,sum(finalData1$weightTotal.DIS)))

#Combine summed individual species and summed catch, and calculate percentages
finalData <- rbind(finalData1,SumRows) 
finalData[,"ProcNum"] <- as.numeric(finalData[,3])/(as.numeric(finalData[,2])+as.numeric(finalData[,3]))*100
finalData[,"ProcWeight"] <- as.numeric(finalData[,5])/(as.numeric(finalData[,4])+as.numeric(finalData[,5]))*100

finalData_U <- finalData 
#Round all digits with comma as decimal mark
for (i in c(2,3,6,7) ) { finalData_U[,i] <- prettyNum(round(finalData_U[,i],0), decimal.mark = ",") }
for (i in c(4,5)) { finalData_U[,i] <- formatC(round(finalData_U[,i],1), decimal.mark = ",", digits = 1,format = "f") }

finalData_U[1:nrow(data3_summed_sub),c(2:5)][finalData_U[1:nrow(data3_summed_sub),c(2:5)]=="NA"] <- "-"
finalData_U[finalData_U==NaN | finalData_U=="NA"] <- ""

```





```{r, echo=FALSE, include=FALSE, cache=FALSE}

##make tex-table 1


tbl <- xtable(finalData_U)
print(tbl,
      digits = 0,
    only.contents=TRUE,
    include.rownames=FALSE,
    include.colnames=FALSE,
    type="latex",
    file="tblout.tex")
    
```



<!-- Tabel1: samlet fangst -->

\section{Samlet fangst}

\inputencoding{latin5}

\CatchFileDef{\tabmacro}{tblout}{}


\definecolor{lightgray}{gray}{0.9}
\setlength{\LTleft}{-20cm plus -1fill}
\setlength{\LTright}{\LTleft}
\setlength{\tabcolsep}{0.8em}
\def\arraystretch{1.3}
\rowcolors{3}{}{lightgray}
\begin{longtable}{l|r|r|r|r|r|r}
\centering
\textbf{Arter} & \multicolumn{2}{c|}{\textbf{Antal}}  & \multicolumn{2}{c|}{\textbf{V\ae gt i kg}}  & \multicolumn{2}{c}{\textbf{Procent genudsat}}\\
                      &  \multicolumn{1}{r}{Landet} &  \multicolumn{1}{r|}{Genudsat} &       
                         \multicolumn{1}{r}{Landet} &  \multicolumn{1}{r|}{Genudsat} &    
                          \multicolumn{1}{r}{Antal (\%)} &  \multicolumn{1}{r}{V\ae gt (\%)} \\
\hline
\endhead

\tabmacro

\end{longtable}



\inputencoding{utf8}



Tabellen udgøres af `r catchOperation` hvor både landinger og discard er opgjort for alle arter.
\newline
Ovenstående tal udgøres af `r length(station_list)` ud af `r nrow(data4)` `r catchOperation`.
\newline
"-" indikerer at denne del af fangsten ikke er oparbejdet.



\pagebreak

```{r, echo=FALSE, include=FALSE, cache=FALSE}

#### Data for 2. table, showing catch/hour/station

#summing data3 by landingcat, species and station
data3_summed <- ddply(data3[data3$landingCategory %in% c("KON","DIS"),], 
                      c("landingCategory", "speciesCode","station"),
                      plyr::summarize, 
                      weightTotal= sum(weightTotal))

#data3_summedt <- aggregate(data3$weightTotal, by=list(data3$landingCategory, data3$speciesCode, data3$station), "sum")
#data3_summed <- plyr::rename(data3_summed, c("Group.2"="speciesCode","Group.1"="landingCategory","Group.3"="station","x"="weightTotal"))
 
#Expand to include both categories "KON" and "DIS" for all species at all stations
expand1 <- expand.grid(station=levels(factor(data3_summed$station)),
                       landingCategory=c("DIS","KON"),
                       speciesCode=levels(factor(data3_summed$speciesCode)),
                       weightTotal=0)

expand2 <- rbind(data3_summed,expand1)

# Merge with fishingtime per station and calculate catch på hour
data3_summed1 <- merge(data4[,c("station","fishingtime")],
                       expand2,by="station",
                       all.y=TRUE)
# data3_summed1$weightTotal <- data3_summed1$weightTotal*60/data3_summed1$fishingtime

#Merge species names
data3_summed2 <- plyr::ddply(data3_summed1,
                        c("station","landingCategory","speciesCode","fishingtime"),
                        plyr::summarize,
                        weightTotal= sum(weightTotal))

data3_summed2 <- merge(data3_summed2,data6,by="speciesCode", all.x=TRUE)

#Wide format witch columsn per landing category
data3_summed3 <- 
  reshape(data3_summed2[,c("station","dkName","weightTotal","landingCategory")], 
          timevar = "landingCategory",
          idvar = c("station","dkName"),
          direction = "wide")

#Create output table by considering each stations individually.
#Species that are in "input_art_multiplot" are inlcuded individually, while remaining species are summed (per station)
data3_summed3 <- data3_summed3[data3_summed3$weightTotal.DIS!=0 |
                                 data3_summed3$weightTotal.KON!=0,]

dkList <- data6[data6$speciesCode %in% input_art_multiplot,"dkName"]

finalData_tab2 <- data.frame()

for (i in sort(unique(data3_summed3$station))) {
        data <- data3_summed3[data3_summed3$station==i,] #data at station 1
        #if (length(unique(data$dkName))!=length(dkList)) {
        if (length(dkList)>0) {
          
          data_inc <- data[data$dkName %in% dkList,] 
          data_inc <- data_inc %>% arrange(dkName)# species in input_art_multiplot
          data_OS <- data.frame()
            
          if (nrow(data[!(data$dkName %in% dkList),])>0) { # species not in input_art_multiplot
            data_OS <- data.frame("station"=i,
                                  "dkName"="Øvrige arter",
                                  "weightTotal.DIS"=sum(data[!(data$dkName %in% dkList),"weightTotal.DIS"]),
                                  "weightTotal.KON"=sum(data[!(data$dkName %in% dkList),"weightTotal.KON"]))
          }
          
          finalData_tab2 <- rbind(finalData_tab2,data_inc,data_OS) #Combine individual data sets from each station
        }
}


finalData_tab3 <- finalData_tab2 %>% 
  arrange(station, desc(weightTotal.KON),desc(weightTotal.DIS))

#Rounding and change decimal mark to comma
finalData_tab3$weightTotal.DIS <- formatC(finalData_tab3$weightTotal.DIS, 
                                          decimal.mark = ",", digits = 1,format = "f")
finalData_tab3$weightTotal.KON <- formatC(finalData_tab3$weightTotal.KON, 
                                          decimal.mark = ",", digits = 1,format = "f")

#data of non sampled stations are assigned with "-" (if any)
finalData_tab3$weightTotal.DIS[!(finalData_tab3$station %in% station_list) & finalData_tab3$weightTotal.DIS == 0] <- "-"
finalData_tab3$weightTotal.KON[!(finalData_tab3$station %in% station_list) & finalData_tab3$weightTotal.KON == 0] <- "-"


finalData_tab3[duplicated(finalData_tab3$station),"station"] <- ""


```


```{r, echo=FALSE, include=FALSE, cache=FALSE}

##make tex-table 2

finalData_tab3b <- finalData_tab3[,c(1,2,4,3)] 

tbl <- xtable(finalData_tab3b)
print(tbl,
    only.contents=TRUE,
    include.rownames=FALSE,
    include.colnames=FALSE,
    digits = 0,
    type="latex",
    file="tblout2.tex")
   
```


<!-- Tabel for fangst/time -->

\section{Samlet fangst per `r catchOperation2`}

\inputencoding{latin5}

\CatchFileDef{\tabmacro}{tblout2}{}


\setlength{\LTleft}{-20cm plus -1fill}
\setlength{\LTright}{\LTleft}

\setlength{\tabcolsep}{2em}
\def\arraystretch{1.3}
\rowcolors{3}{}{lightgray}
\begin{longtable}{l|l|r|r}
\centering

  \textbf{`r catchOperation3`}  & \textbf{Art} & \multicolumn{2}{c}{\textbf{Fangst (kg)}} \\
                    &              & \multicolumn{1}{r}{Landet}  & \multicolumn{1}{r}{Genudsat}\\
\hline
\endhead
\tabmacro

\end{longtable}


\inputencoding{utf8}

Ovenstaende tal udgøres af `r length(unique(data3$station))` ud af `r nrow(data4)` `r catchOperation`.
\newline
"-" indikerer at denne del af fangsten ikke er oparbejdet.


\pagebreak


```{r, echo=FALSE}

####Adjustements to plots####

#roundUp <- function(x) 10^ceiling(log10(x)) # use for ablin
roundUpNice <- function(x, nice=c(1,2,3,4,5,6,7,8,9,10)) {
    if(length(x) != 1) stop("'x' must be of length 1")
    10^floor(log10(x)) * nice[[which(x <= 10^floor(log10(x)) * nice)[[1]]]]  }

```



\subsection{Samlet fangst i vægt}

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=18, fig.height=11}



######## PLots af den samlede fangst ############


#-----------------------------PLOT1---------------------------------------------------------------


#Input and layouts for plot1

plot_data1 <- sqldf("select     speciesCode, landingCategory, sum(numberTotal) as numberTotal, sum(weightTotal) as weightTotal
                     from      data3_summed_stat
                     group by  speciesCode, landingCategory ")

plot_data2 <- plot_data1[plot_data1$speciesCode %in% input_art_multiplot,]

expand1 <- expand.grid(speciesCode=levels(factor(plot_data2$speciesCode)),
                       landingCategory=c("DIS","KON"),
                       numberTotal=0,
                       weightTotal=0)

expand2 <- rbind(plot_data2,expand1)

expand3 <- sqldf("select     speciesCode, landingCategory, sum(numberTotal) as numberTotal, sum(weightTotal) as weightTotal
                  from       expand2
                  group by   speciesCode, landingCategory ")

plot_data2.1 <- merge(expand3, data6, by="speciesCode",all.x=TRUE)
#plot_data3[plot_data3$landingCategory=="KON",]$landingCategory <- "Landet"
#plot_data3[plot_data3$landingCategory=="DIS",]$landingCategory <- "Genudsat"

dat = dcast(plot_data2.1, 
            dkName+weightTotal+numberTotal+speciesCode ~ landingCategory, 
            fun.aggregate = length,
            value.var="numberTotal")

dat.melt = melt(dat, 
                id.vars = c("speciesCode","numberTotal","weightTotal","dkName"), 
                measure.vars = c("DIS", "KON"))

dat.melt$numberTotal <- dat.melt$numberTotal*dat.melt$value
dat.melt$weightTotal <- dat.melt$weightTotal*dat.melt$value

plot_data3 <- plyr::rename(dat.melt, c("variable"="landingCategory"))
# plot_data3.1 <- plot_data3[plot_data3$value==1,]

if(nrow(plot_data3)>1) { 
  
  soj <- rbind(finalData$weightTotal.DIS[1:(nrow(finalData)-3)],
               finalData$weightTotal.KON[1:(nrow(finalData)-3)])
  
  ytop <- roundUpNice(max(as.numeric(soj), na.rm=TRUE)) #roundUpNice((max(colSums(as.matrix(soj), na.rm=TRUE))))
  
  plot1 <- ggplot(plot_data3, aes(x=dkName, y=weightTotal)) + 
    geom_bar(stat="identity",aes(fill=factor(landingCategory)), position ="dodge",width=0.6)+
    theme_classic(base_size = 24, base_family = "")+
    labs(x = "", y="Vægt (kg)")+
    theme(axis.title.y = element_text(vjust = 2),
          axis.title.x = element_text(vjust = -1),
          axis.line = element_line(colour = "black"),
          axis.text.x = element_text(angle = 30, hjust = 1),
          # legend.text = element_text(size = 20, face = 'bold'),
          plot.title = element_text(face="bold",vjust=3,hjust=0))+
    theme(panel.grid.major = element_line(colour="grey", size=0.5),
          panel.grid.major.x = element_blank(),
          panel.border = element_rect(colour = "black", fill=NA, size=1))+
    theme(legend.justification = c(1, 1), 
          legend.position = c(1, 1), 
          legend.key.size = unit(0.6, "cm"),
          legend.text=element_text(size=20),
          legend.background = element_rect(size=0.6, 
                                           linetype="solid",
                                           colour ="black"),
          legend.title=element_blank())+
    scale_fill_manual(values=c("cadetblue3","Olivedrab"),#"#B57BA6"), 
                      labels=c("Genudsat","Landet"))+#,"Landet fisk under\n mindstemål (BMS)"))+
    theme(plot.margin=unit(c(0.5,0,1.5,0.5), "cm"))

  plot(plot1)

}


```



Grafen udgøres af `r catchOperation`, hvor både landinger og discard er opgjort for alle arter. Det er på denne tur `r length(station_list)` ud af `r nrow(data4)` `r catchOperation`.


\pagebreak


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=18, fig.height=10,cache=FALSE, results='asis'}
mround <- function(x,base){ 
        base*round(x/base) 
} 

statArea <- data4[,c("station","dfuArea")]
statArea$dfuArea <- as.character(statArea$dfuArea)

#Loop gennem liste med input-arter
data2_stat0 <- subset(data2, data2$station %in% station_list, drop=TRUE)

data2_stat <- left_join(data2_stat0, statArea) %>% 
  left_join(areatable) %>% 
  mutate(farvand_ = str_replace_all(farvand," ","_")) %>% 
  left_join(MLS2010[,c("speciesCode","area","length_mm")], 
            by = c("speciesCode","farvand_"="area"))

plot_spec1 <- sqldf("select     speciesCode, landingCategory, length,
                     sum(numberTotalPerLength) as numberTotalPerLength, length_mm
                     from      data2_stat
                     group by  speciesCode, landingCategory,length ")

plot_spec2 <- merge(plot_spec1, data6, by="speciesCode",all.x=TRUE)

# input_art <- sort(unique(data2_stat[data2_stat$speciesCode %in% input_art,"speciesCode"]))

for (i in input_art) {
  
  # if (i %in% data2$speciesCode) {
    if (i %in% plot_spec2$speciesCode) {
  
    data <- plot_spec2[plot_spec2$speciesCode==i,]
    
    # hard coding garbage as consume (it looks better than showing it as discard)
    data$landingCategory <- ifelse(data$speciesCode %in% 
                                     c("AF1","AF2","AF3","AF4","AF5"), 
                                    "KON", 
                                    data$landingCategory)
    
    dkfisk <- data$dkName[1]
    
    cat("\n\n\\subsection{Længdefordeling i antal for",dkfisk,"}", "\n")
    
    #Expand to include KON and DIS for all species
    expand1 <- rbind(data,expand.grid(speciesCode=i,
                                      landingCategory=c("DIS","KON"),#,"BMS"),
                                      length=data$length[1],
                                      numberTotalPerLength=0,
                                      length_mm = data$length_mm[1],
                                      dkName=unique(data$dkName)))
    
    data <- plyr::ddply(expand1, 
                        c("speciesCode", "landingCategory","length","dkName","length_mm"),
                        plyr::summarize,
                        numberTotalPerLength= sum(numberTotalPerLength))
    # landingcategories <- c("BMS","DIS","KON")
    landingcategories <- c("DIS","KON")
    
    dat = dcast(data, 
                numberTotalPerLength+length+length_mm ~ landingCategory,
                fun.aggregate = length,
                value.var="numberTotalPerLength")
    
    dat.melt = melt(dat, 
                    id.vars = c("length","numberTotalPerLength","length_mm"), 
                    measure.vars = landingcategories)
    
    dat.melt$number <- dat.melt$numberTotalPerLength*dat.melt$value
    dat.melt$variable <- factor(dat.melt$variable,
                                ordered = T, levels = c("DIS","KON"))#,"BMS"))
  
    measure <- "mm"
    # tick <- 10
    limit <- dat.melt$length_mm[1]
    if (i =="DVH") { 
        dat.melt$length <- round(3.0947*dat.melt$length + 13.203)
      } else if (i =="HRJ") { 
        dat.melt$length <- round((dat.melt$length+0.7486)/0.2317)
      } else if (i =="DRJ") {
        dat.melt$length <- dat.melt$length*4
      } else{
        dat.melt$length <- dat.melt$length/10
        measure <-"cm"
        # tick <- 5
        limit <- dat.melt$length_mm[1]/10
      }
    #height <- rbind(height1[,2],height1[,3])
    #height[is.na(height)] <- 0
    
    # for (i in c(25,20,15,10,5,4,3,2,1)){
    #     print(paste(length(seq(mround(min(c(limit,dat.melt$length),na.rm=T)*.9,i),
    #                    mround(max(c(limit,dat.melt$length),na.rm=T)*1.1,i),5)),i))
    #     
    #     }
    
    tick<-NA
    for (i in c(100,50,40,30,25,20,15,10,8,5,2,1)){
        ticks <- length(seq(mround(min(c(limit,dat.melt$length),na.rm=T)*.9,5),
                            mround(max(c(limit,dat.melt$length),na.rm=T)*1.1,5), i))
        
    
    if (ticks %in% 6:12) tick <- i
    if (!is.na(tick)) break
        
    }
    if (is.na(tick)) tick <- 0.5
    
      plot2 <- ggplot(dat.melt, aes(x=length, y=number)) + 
        # geom_rect(aes(xmin=-Inf, xmax=limit, ymin = Inf, max = Inf),fill="grey",alpha=.5)+
        geom_bar(stat="identity",aes(fill=variable), 
                 position="dodge",width=0.6)
      
      # tilføj linje for mindstemål
      if (!is.na(limit)){
        plot2 <- plot2 + 
          geom_vline(aes(xintercept = limit-.5 ,linetype = "limit"),
                                    color = "red", size = 1)+
          scale_linetype_manual(values = "dashed",name="",
                                labels=paste0("Mindstemål\n(",limit," ",measure,")"))
          
      }
            
        plot2 <- plot2 + 
          theme_classic(base_size = 26, base_family = "")+
          labs(x = paste0("Længde (",measure,")"), y="Antal")+
          theme(axis.title.y = element_text(vjust = 2),
                axis.title.x = element_text(vjust = -1),
                axis.line = element_line(colour = "black"),
                axis.text.x = element_text(angle = 30, hjust = 1),
                plot.title = element_text(face="bold",vjust=3,hjust=0))+
          theme(panel.grid.major = element_line(colour="grey", size=0.5),
                panel.grid.major.x = element_blank(),
                panel.border = element_rect(colour = "black", fill=NA, size=1))+
          theme(
          #legend.justification = c(1, 1), 
              legend.position = "right",#c(1, 1), 
              legend.key.size = unit(0.6, "cm"),
              legend.text=element_text(size=20),
              legend.title=element_blank())+
        scale_x_continuous(breaks=seq(0,#mround(min(c(limit,dat.melt$length),na.rm=T)*.9-1,1),
                                      mround(max(c(limit,dat.melt$length),na.rm=T)*1.1,1), tick),
                          limits = c(mround(min(c(limit,dat.melt$length),na.rm=T)*.9-1,1),
                                     mround(max(c(limit,dat.melt$length),na.rm=T)*1.1+1,1)))
          # scale_y_continuous(breaks = pretty_breaks())# c(0:(max(dat.melt$number)+1)))
        # if ("BMS" %in% landingcategories){
          plot2 <- plot2 + scale_fill_manual(values=c("cadetblue3",
                                                      "Olivedrab"
                                                      # ,"#B57BA6"
                                                      ),
                            labels=c("Genudsat","Landet"
                                     # ,"Landet fisk under\n mindstemål (BMS)"
                                     ))
        # }
        # if (!("BMS" %in% landingcategories)){
        #   plot2 <- plot2 + scale_fill_manual(values=c("cadetblue3","Olivedrab"),
        #                     labels=c("Genudsat","Landet"))
        # }
        
        plot2 <- plot2 + theme(plot.margin=unit(c(0.5,0,1.5,0.5), "cm"))

  plot(plot2)
        
        
  }
}

```




```{r, echo=FALSE, include=FALSE, cache=FALSE}

st_year <- year-5
year_all <- c(st_year:year)

area <- as.character(unique(data4$dfuArea))
qrt <- unique(data4$quarterGearStar)
species_trip <- as.character(unique(data2$speciesCode))

query_Ind <-paste("SELECT     Animal.year, Animal.trip, Animal.station, Animal.dfuArea, Animal.speciesCode, Animal.individNum, 
                              Animal.length, Animal.number,(Animal.weight/Animal.number)*1000 AS weight,  Animal.cruise
                   FROM       Animal
                   WHERE      Animal.year IN ('", paste(year_all,collapse = "','"),"') AND 
                              Animal.speciesCode IN ('", paste(species_trip,collapse = "','"),"') AND
                              Animal.dfuArea IN ('", paste(area,collapse = "','"),"') AND
                              Animal.individNum != 0 AND
                              Animal.quarterGearStart IN ('", paste(qrt,collapse = "','"),"')"
                   , sep = "")
query_Ind


channel <- odbcConnect("FishLineDW")
data_ind <- sqlQuery(channel, paste(query_Ind),stringsAsFactors=FALSE)
close(channel)

```


```{r ,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE}

if (length(species_individ)>0) { 

cat("\\newpage")

cat("\\subsection{Længde-vægt forhold}")  

#cat("De følgende grafer viser længde-vægt-fordelingen på ")
}



```




```{r ,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE, fig.width=13, fig.height=8}


for (i in species_individ) {
  
    data_ind1 <- data_ind[data_ind$speciesCode==i,]
    data_ind2 <- data_ind1[complete.cases(data_ind1[,c(7,9)]),]
    
    if (nrow(data_ind2[data_ind2$trip!=trip,])>0) {
      
      data_ind2$dfuArea <- as.character(data_ind2$dfuArea)
      data_ind3 <- left_join(data_ind2, areatable, by="dfuArea")
      data_ind3$length_cm <- data_ind3$length/10
      data_ind4 <- data_ind3[data_ind3$trip==trip,]
      
      if (nrow(data_ind4)>0){
      
      tick<-NA
      for (u in c(100,50,40,30,25,20,15,10,8,5,2,1)){
          ticks <- length(seq(0,mround(max(c(limit,data_ind4$length_cm),na.rm=T)*1.1,5), u))
          
          if (ticks %in% 6:12) tick <- u
          if (!is.na(tick)) break
          }    
              
      p_individ <- ggplot(data=data_ind3[data_ind3$length<max(data_ind4$length)*1.1,],
                          aes(x=length_cm, y=weight)) +
        geom_point(data=data_ind3[data_ind3$trip!=trip,],
                   aes(color="all"),pch=18,size=5)
      
      if (nrow(data_ind4)>0)
        
      p_individ <- p_individ +
        geom_point(data=data_ind4,aes(color="trip"),pch=18,size=5)
      
      # add red limit line if it exists for the species and area
       if (length(MLS2010[MLS2010$speciesCode == i & 
                          MLS2010$area == 
                            str_replace(data_ind3$farvand," ","_"),"length"])>0){
         
         limit = max(MLS2010$length[MLS2010$speciesCode == i & 
                                  MLS2010$area == str_replace(data_ind3$farvand," ","_")],
                     na.rm=T)
            
        p_individ <- p_individ + 
            geom_vline(aes(xintercept = limit,
                           linetype = "limit"),
                       color = "red", size = 1)+
          scale_linetype_manual(values ="dashed",
                                name="",
                                labels=paste0("Mindstemål\n(",limit," cm)"))
       }
      
      p_individ <- p_individ + 
        theme_classic(base_size = 18, base_family = "")+
        labs(x = "Længde (cm)", y="Vægt (g)", 
             title=paste("Art:", i,"- Område:",area,"- Kvartal:",
                         paste(qrt, collapse = ","), sep=" "))+
        theme(axis.title.y = element_text(vjust = 2),
              axis.title.x = element_text(vjust = -1),
              axis.line = element_line(colour = "black"),
              legend.title = element_text(size = 12, face = 'bold'),
              plot.title = element_text(face="bold",vjust=1.5))+
        theme(panel.grid.major = element_line(colour="grey", size=0.5),
              panel.grid.major.x = element_blank(),
              panel.border = element_rect(colour = "black", fill=NA, size=1))+
        theme(legend.position="right")+
        scale_color_manual(values=c("cadetblue3","red"),
                           name="",labels=c("Database",paste("Tur:",trip,sep=" ")))+
        theme(plot.margin=unit(c(0.5,0,1.5,0.5), "cm"))+
        scale_x_continuous(limits = c(0,mround(max(c(data_ind4$length_cm,limit),na.rm = T)*1.1,5)),
                           breaks = seq(0,
                                        mround(max(c(data_ind4$length_cm,limit),na.rm = T)*1.1,5),
                                        by = tick))+
        scale_y_continuous(limits = c(0,(max(data_ind4$weight)*1.25)))
    
 
     plot(p_individ)    
      }
    }
}

```

