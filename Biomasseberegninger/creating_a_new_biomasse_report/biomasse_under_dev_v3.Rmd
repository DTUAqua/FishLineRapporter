---
geometry: top=2cm, bottom=1.5cm, left=3cm, right=3cm
header-includes:
  \usepackage{tabularx}
  \usepackage[table, dvipsnames]{xcolor}
  \usepackage{tcolorbox}
  \usepackage{booktabs}
  \usepackage{longtable}
  \usepackage{array}
  \usepackage{multirow}
output: 
  pdf_document: 
    latex_engine: xelatex
params:
  species: BMS
---

\renewcommand{\familydefault}{\sfdefault}
\sffamily

# Test
## Tests needs to run species by species

## Remember before upload to FishLine

1.    Delete new output in save_output and open up for the old way
2.    Delete version_name in define_input chuck
3.    Delete getdata_test chunck
4.    Change eval to T in getdata chunck
5.    Delete output_dir in define_input
6.    Change eval to T in db_messages chunck
7.    Delete params from YAML
8.    Delete test paragraph
9.    Move text out of intro chunck
10.   Remove [c(1:10)] from tables - this is just implemented, so the report don't get spammed, when working with all cruises
11.   Change eval to T in ref_annex chunck
12.   Open up for code marked with 'Open this up later'
13.   Include all gearQuality types in the extraction - remove all other than 'V' after overview of gearQuality

## Tests
v0: Nothing changed - except preparing script for testing

v1: Change the slow loop in chuck 'final_correction_selction' - no changes

### Using a reference table with old values

v2: Import and display reference table. Get stationType and redsk_dim from reference table - no changes

v3: Distance is calculated seperatly - no changes. All station with relevant New_DISMETH == "Kan ikke udregnes" are invalid


```{r intro, include = F, eval = F}
# \section{Data - Biomasseberegninger}
# 
# \begin{tcolorbox}[colback=white!5,colframe=blue!40!black,title=Information om udtrækket]
# \renewcommand{\arraystretch}{1.2}
# \begin{tabularx}{20cm}{@{}lXr@{}}
# \textbf{År} & `r year` & \\ 
# \textbf{Togt} & `r cruise` & \\
# \textbf{Art} & `r species` & \\
# \textbf{Redskabstype} & `r unique(data$gearType)` &
# \end{tabularx}
# \end{tcolorbox}

```


```{r define_input, echo=FALSE}

version_name <- "v3"
output_dir <- "Q:/mynd/kibi/fishLine/FishLineRapporter/Biomasseberegninger/creating_a_new_biomasse_report/output/"

species <- params$species

#Parameters

# year <- 2002; cruise <- "BV VH HMS april"; species <- "HMS"
# year <- 2011; cruise <- "BV LF OES mar"; species <- "OES"
# year <- 2017; cruise <- "BV VH BMS mar sug"; species <- "BMS"
# year <- 2017; cruise <- "BV VH HMS okt sug +R"; species <- "HMS"
# year <- 2018; cruise <- "BV LF HMS april"; species <- "HMS"
# year <- 2018; cruise <- "BV VH BMS OST april"; species <- "BMS"
# year <- 2017; cruise <- "BV HF BMS sept"; species <- "BMS"
# year <- 2018; cruise <- "BV VH HMS apr ekstra"; species <- "HMS"

# #Parameters
 # year<- @paramYear ; cruise <- @paramCruise;  species <- @paramSpecies

```


```{r set_libraries, include=FALSE}

#Libraries
if (!require(sqldf)) {
  install.packages("sqldf", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(sqldf)
}
if (!require(RODBC)) {
  install.packages("RODBC", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(RODBC)
}
if (!require(plyr)) {
  install.packages("plyr", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(plyr)
}
if (!require(data.table)) {
  install.packages("data.table", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(data.table)
}
if (!require(tidyr)) {
  install.packages("tidyr", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(tidyr)
}
if (!require(dplyr)) {
  install.packages("dplyr", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(dplyr)
}
if (!require(knitr)) {
  install.packages("knitr", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(knitr)
}
# if (!require(kableExtra)) {
#   install.packages("kableExtra", repos="http://ftp.ussg.iu.edu/CRAN/")
#   library(kableExtra)
# }
if (!require(xtable)) {
  install.packages("xtable", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(xtable)
}
if (!require(Hmisc)) {
  install.packages("Hmisc", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(Hmisc)
}
detach("package:Hmisc", unload=TRUE)
```

```{r functions, include = F}

makeTable <- function(data){
  
  bold <- function(x) {paste('{\\textbf{',x,'}}', sep ='')}
  rws <- seq(1, nrow(data) - 1, by = 2)
  col <- rep("\\rowcolor{Blue!50!white}", length(rws))
  
  options(xtable.comment = FALSE)
  print(
    xtable(x = data, 
           align = c(
      rep("l", ncol(data)), rep("l", 1)
    )),
    include.rownames = F,
    sanitize.text.function = function(str) gsub("_", "\\_", str, fixed = TRUE),
    sanitize.colnames.function = function(x) {
      x <- gsub("_", "\\_", x, fixed = TRUE)
      x <- paste0("\\textbf{", x, "}")
      return(x)
},
    booktabs = T,
    add.to.row = list(pos = as.list(rws), command=col),
    tabular.environment = "longtable"
  )

}

```


```{r getdata, echo=FALSE, message=FALSE, warning=FALSE, eval = F}


channel <- odbcConnect("FishLineDW")
data <- sqlQuery(channel, paste("SELECT    Sample.sampleId, Sample.year, Sample.cruise, Sample.trip, Sample.station, Sample.stationName,
                                           Sample.haulType, Sample.latPosStartText, Sample.lonPosStartText, Sample.latPosEndText, 
                                           Sample.lonPosEndText, Sample.latPosStartDec, Sample.lonPosStartDec, Sample.latPosEndDec, 
                                           Sample.lonPosEndDec, Sample.fishingtime, Sample.distancePositions, Sample.coursetrack,
                                           Sample.distanceBottom,Sample.haulSpeedBot * 0.514 as haulSpeedBotMS,Sample.gearQuality, SpeciesList.speciesCode, SpeciesList.dfuBase_Category, 
                                           SpeciesList.weightStep0, SpeciesList.weightStep1, SpeciesList.weightStep2, 
                                           SpeciesList.weightStep3, SpeciesList.raisingFactor, Animal.representative, Animal.individNum,
                                           Animal.length, Animal.number, Animal.weight, Animal.sizeSortingDFU, SpeciesList.speciesListId, Animal.animalId, Sample.gearType
                                FROM       Animal RIGHT OUTER JOIN
                                           SpeciesList ON Animal.speciesListId = SpeciesList.speciesListId LEFT JOIN
                                           Sample ON SpeciesList.sampleId = Sample.sampleId
                                 WHERE     Sample.year = (",year,") AND
                                           Sample.cruise = ('",cruise,"') AND
                                           Sample.gearQuality = 'V' ", sep=""), stringsAsFactors=FALSE) 
db_message <- sqlQuery(channel, 
                       sprintf("SELECT * FROM ErrorLog where origin like '%s->%s%s'",
                               year,cruise,"%"),
                       stringsAsFactors=F)
close(channel)


#If want to selcet by trip: Sample.trip = ('",trip,"') AND


```


```{r getdata_test, echo=FALSE, message=FALSE, warning=FALSE, eval = T}


channel <- odbcConnect("FishLineDW")
data <- sqlQuery(channel, paste("SELECT    Sample.sampleId, Sample.year, Sample.cruise, Sample.trip, Sample.station, Sample.stationName,
                                           Sample.haulType, Sample.latPosStartText, Sample.lonPosStartText, Sample.latPosEndText, 
                                           Sample.lonPosEndText, Sample.latPosStartDec, Sample.lonPosStartDec, Sample.latPosEndDec, 
                                           Sample.lonPosEndDec, Sample.fishingtime, Sample.distancePositions, Sample.coursetrack,
                                           Sample.distanceBottom,Sample.haulSpeedBot * 0.514 as haulSpeedBotMS,Sample.gearQuality, SpeciesList.speciesCode, SpeciesList.dfuBase_Category, 
                                           SpeciesList.weightStep0, SpeciesList.weightStep1, SpeciesList.weightStep2, 
                                           SpeciesList.weightStep3, SpeciesList.raisingFactor, Animal.representative, Animal.individNum,
                                           Animal.length, Animal.number, Animal.weight, Animal.sizeSortingDFU, SpeciesList.speciesListId, Animal.animalId, Sample.gearType
                                FROM       Animal RIGHT OUTER JOIN
                                           SpeciesList ON Animal.speciesListId = SpeciesList.speciesListId LEFT JOIN
                                           Sample ON SpeciesList.sampleId = Sample.sampleId
                                 WHERE     Sample.cruise like 'BV%'", sep = ""), stringsAsFactors = FALSE) 

# db_message <- sqlQuery(channel, 
#                        sprintf("SELECT * FROM ErrorLog where origin like '%s->%s%s'",
#                                year,cruise,"%"),
#                        stringsAsFactors = F)
close(channel)


#If want to selcet by trip: Sample.trip = ('",trip,"') AND

ref_sample <- distinct(read.csv(paste0(output_dir, "ref_table_filled_v2.csv")), gearType, gearVal, stationType, redsk_dim)
ref_species <- read.csv(paste0(output_dir, "ref_table_filled_v2.csv"))

```

# Træk validitet (gearQuality)
Rapporten medtager kun valide (V) træk. Nedestående tabel viser antal træk (noSamples) per kombination i udtrækket

```{r gearQuality, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.pos='H'}
dat_tab <- summarise(group_by(data, gearQuality), noSamples = length(unique(sampleId)))
makeTable(dat_tab)

#data <- filter(data, gearQuality == "V") # Open this up later
```


# Stationstype (STATTYPE - omdøbes senere)
Stationstype defineres vha. redskabet (gearType), se reference tabellen i Annex 1. Nedestående tabel viser antal træk (noSamples) per kombination i udtrækket

```{r set stationType, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.pos='H'}

data <- left_join(data, ref_sample, by = c("gearType" = "gearType"))

dat_tab <- summarise(group_by(data, gearType, stationType), noSamples = length(unique(sampleId)))
makeTable(dat_tab)

```

# Redskabsdimension (REDSKDIM - omdøbes senere)
Redskabs dimension defineres vha. redskabet (gearType), se reference tabellen i Annex 1. Nedestående tabel viser antal træk (noSamples) per kombination i udtrækket

```{r redsk_dim, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.pos='H'}

tab_dat <- summarise(group_by(data, gearType, stationType, redsk_dim), noSamples = length(unique(sampleId)))
makeTable(tab_dat)

```

# Distance (DISTANCE)
Distance bestemmes vha. følgende hieraki
    
1.    Udsejlet distance (coursetrack) - Indtastes direkt i FiskeLine
2.    Distance start-slut (distancePositions) - Distancen mellem positionerne. Udregnes af databasen
3.    Træktid*trækhastighed (distanceBottom) - Distancen udregnet vha. Trækhastighed og fisketid. Udregnes af databasen

**DISMETH** angiver metoden

```{r distance, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.pos='H'}

data[data$coursetrack == 0 & !is.na(data$coursetrack),"coursetrack"] <- NA
data[data$distancePositions == 0 & !is.na(data$distancePositions),"distancePositions"] <- NA
#data[data$distanceBottom == 0 & !is.na(data$distanceBottom),"distanceBottom"] <- NA # Open this up later


data <- mutate(data, DISTANCE = ifelse(!is.na(coursetrack), coursetrack,
                                       ifelse(!is.na(distancePositions) & is.na(coursetrack), distancePositions*1852, 
                                              ifelse(!is.na(distanceBottom) & is.na(distancePositions) & is.na(coursetrack), distanceBottom*1852, NA))),
               DISMETH = ifelse(!is.na(coursetrack), "Udsejlet distance", 
                                     ifelse(!is.na(distancePositions) & is.na(coursetrack), "Distance start-slut", 
                                            ifelse(!is.na(distanceBottom) & is.na(distancePositions) & is.na(coursetrack), "Træktid*trækhastighed", "Kan ikke udregnes"))))

tab_dat <- summarise(group_by(data, stationType, DISMETH, gearQuality), noSamples = length(unique(sampleId)))
makeTable(tab_dat)

```

```{r, include = F}

#####################################################

#Calculate Befisket areal depending on species

data[data$coursetrack==0 & !is.na(data$coursetrack),"coursetrack"] <- NA
data[data$distancePositions==0 & 
       !is.na(data$distancePositions),"distancePositions"] <- NA


#Areal = udsejlet distance* redskabsbredde (Hvis udsejlet distance er kendt)
data[!is.na(data$coursetrack) & 
       !(data$stationType %in% c('RAM','VV')) ,"Befisket_Areal_m2"] <- 
  data[!is.na(data$coursetrack) & !(data$stationType %in% c('RAM','VV')) ,]$coursetrack*
  data[!is.na(data$coursetrack) & !(data$stationType %in% c('RAM','VV')) ,]$redsk_dim
data[!is.na(data$coursetrack) & 
       !(data$stationType %in% c('RAM','VV')) ,"areal_metode"] <- "Udsejlet distance"
  
#Areal = Distance*redskabsbredde (Hvis Distance ≠0 og coursetrack=NA)
data[!is.na(data$distancePositions) & 
       is.na(data$coursetrack) & 
       !(data$stationType %in% c('RAM','VV')) ,"Befisket_Areal_m2"] <- 
  data[!is.na(data$distancePositions) & 
         is.na(data$coursetrack) & 
         !(data$stationType %in% c('RAM','VV')) ,]$distancePositions*1852*
  data[!is.na(data$distancePositions) & 
         is.na(data$coursetrack) & 
         !(data$stationType %in% c('RAM','VV')) ,]$redsk_dim
data[!is.na(data$distancePositions) & 
       is.na(data$coursetrack) & 
       !(data$stationType %in% c('RAM','VV')) ,"areal_metode"] <- 
  "Distance start-slut"

#Areal = træktid*træhastighed*redskabsbredde (Distance=0 og udsejlet distance ukendt), distanceBottom= Trækhast*fisketid i sømil (haulSpeedBot*fishingtime).
data[is.na(data$distancePositions) & 
       is.na(data$coursetrack) & 
       !(data$stationType %in% c('RAM','VV'))  ,"Befisket_Areal_m2"] <- 
  data[is.na(data$distancePositions) & 
         is.na(data$coursetrack) & 
         !(data$stationType %in% c('RAM','VV')) ,]$distanceBottom*1852*
  data[is.na(data$distancePositions) & 
         is.na(data$coursetrack) & 
         !(data$stationType %in% c('RAM','VV')),]$redsk_dim
data[is.na(data$distancePositions) & 
       is.na(data$coursetrack) & 
       !(data$stationType %in% c('RAM','VV')),"areal_metode"] <- 
  "Træktid*trækhastighed"

#Areal = rammeareal (Hvis redskab=ramme)
data[data$gearType %like% '^RAM' & 
       data$gearType!="RAM" & 
       !is.na(data$gearType),"Befisket_Areal_m2"] <- 
  data[data$gearType %like% '^RAM' & 
         data$gearType!="RAM" & 
         !is.na(data$gearType),]$redsk_dim # kig på geartype, RAM0625 = 0,0625

data[data$gearType=="RAM" & !is.na(data$gearType),"Befisket_Areal_m2"] <- 0.01
data[data$gearType %like% '^RAM' & !is.na(data$gearType),"areal_metode"] <- 
  "Ramme-areal"


#Areal = GrapAreal (Hvis redskab=VV)
data[data$gearType %like% '^VV' &
      !is.na(data$gearType),"Befisket_Areal_m2"] <-
 data[data$gearType %like% '^VV' &
        !is.na(data$gearType),]$redsk_dim 
data[data$gearType %like% '^VV' &
      !is.na(data$gearType),"areal_metode"] <- "Grab-areal"

# Areal = sugeareal (Hvis redskab=sug)
data$Befisket_Areal_m2[data$gearType %like% '^SUG' & !is.na(data$gearType)] <-
  data$redsk_dim[data$gearType %like% '^SUG' & !is.na(data$gearType)]*
  data$coursetrack[data$gearType %like% '^SUG' & !is.na(data$gearType)] # skal ganges med en længde (distance position)
data[data$gearType %like% '^SUG' & !is.na(data$gearType),"areal_metode"] <-
  "Suge-areal"


areal <- filter(data, is.na(Befisket_Areal_m2))
######################################################

data <- data[!is.na(data$speciesCode),] 
  

#Calculate total weight, total number, lengths etc. from weight, number and raisingfactor
# data$Weight_kg_STO <-
#   ifelse(data$sizeSortingDFU=="STO" & !is.na(data$sizeSortingDFU) & 
#            data$speciesCode=="BMS",
#          as.numeric(apply(data[,c("weightStep0","weightStep1",
#                                   "weightStep2","weightStep3")],
#                           1, function(x) min(x[1], x[2], x[3], x[4], na.rm=T)))*
#            data$raisingFactor,
#          NA)
# data$Weight_kg_small <-
#   ifelse((data$sizeSortingDFU!="STO" | is.na(data$sizeSortingDFU)) & 
#            data$speciesCode=="BMS",
#          as.numeric(apply(data[,c("weightStep0","weightStep1","weightStep2","weightStep3")],
#                           1, function(x) min(x[1], x[2], x[3], x[4], na.rm=T)))*data$raisingFactor,
#          NA)
data$TotalWeight_kg <- as.numeric(apply(data[,c("weightStep0","weightStep1","weightStep2","weightStep3")], 
                                        1, function(x) min(x[1], x[2], x[3], x[4], na.rm=TRUE)))*data$raisingFactor

# data$TotalWeight_kg2 <- rowSums(data[,c("Weight_kg_small","Weight_kg_STO")],na.rm=T)
data$TotalNumber <- data$number*data$raisingFactor
data$Length_cm <- data$length/10
data$SOP_Length <- data$Length_cm*data$number*data$raisingFactor


```


```{r Prep_outputData, echo=FALSE, warning=FALSE,message=FALSE}

# Prepare for output data set
# Since not the same variables are needed depedning on the species in quation,




# data2 <- sqldf('select    sampleId, stationType, haulType,gearType, year, cruise, trip, station, stationName, 
#                           latPosStartText,lonPosStartText, latPosStartDec, lonPosStartDec,
#                           latPosEndText,lonPosEndText, latPosEndDec, lonPosEndDec, fishingtime,haulSpeedBotMS,
#                           redsk_dim as RedskabDim, Befisket_Areal_m2,areal_metode, speciesCode,weight_kg_STO, weight_kg_small,
#                           sum(TotalWeight_kg) as TotalWeight_kg, sum(TotalNumber) as TotalNumber, 
#                           sum(SOP_Length)/sum(TotalNumber) as MeanLength_cm, 
#                           min(Length_cm) as Min_Length_cm
#                 from      data
#                 group by  sampleId, haulType,stationType, year, cruise, trip, station, stationName, latPosStartText,
#                           lonPosStartText,latPosStartDec, lonPosStartDec, latPosEndText,lonPosEndText, latPosEndDec, 
#                           lonPosEndDec, Befisket_Areal_m2, speciescode')

if (length(unique(data$sizeSortingDFU[data$speciesCode=="BMS"]))>1 & 
    species == "BMS"){

  # sizeSortingDFU2 <- unique(c(unique(data$sizeSortingDFU),c("SMÅ","STO")))  
  sizeSortingDFU2 <- c("SMÅ","STO")  
  
  bms <- data %>%
    filter(speciesCode=="BMS") %>%
    tidyr::expand(nesting(sampleId,stationType,haulType,gearType,year,cruise,trip,station,
                   stationName,latPosStartText,lonPosStartText,latPosStartDec,
                   lonPosStartDec,latPosEndText,lonPosEndText,latPosEndDec,
                   lonPosEndDec,fishingtime,haulSpeedBotMS,redsk_dim,
                   Befisket_Areal_m2,areal_metode, DISMETH,speciesCode),
           sizeSortingDFU2) %>%
    dplyr::rename(sizeSortingDFU=sizeSortingDFU2)
  
  data1 <- data %>% full_join(bms)
  
  data1$sizeSortingDFU[data1$speciesCode=="BMS" & 
                       is.na(data1$sizeSortingDFU)] <- "SMÅ"
  
} else{data1 <- data}



# uw <- unique(data1[,c("speciesListId","sizeSortingDFU","TotalWeight_kg")])
# # 
data2 <- data1 %>%
  # full_join(bms) %>% 
  # filter(station==1) %>% 
  dplyr::rename(RedskabDim = redsk_dim) %>%
  dplyr::group_by(sampleId,stationType, haulType,gearType, year, cruise, trip,
                  station, stationName, latPosStartText,lonPosStartText,
                  latPosStartDec, lonPosStartDec,latPosEndText,lonPosEndText,
                  latPosEndDec, lonPosEndDec, fishingtime,haulSpeedBotMS,
                  RedskabDim, Befisket_Areal_m2,areal_metode, DISMETH, speciesCode) %>% 
  dplyr::summarise(TotalWeight_kg_SMÅ = 
                     sum(unique(TotalWeight_kg[sizeSortingDFU=="SMÅ"]),na.rm=T),
                   TotalNumber_SMÅ = 
                     sum(TotalNumber[sizeSortingDFU=="SMÅ"],na.rm=T),
                   MeanLength_cm_SMÅ = sum(SOP_Length[sizeSortingDFU=="SMÅ"],na.rm=T)/
                     sum(TotalNumber[sizeSortingDFU=="SMÅ"],na.rm=T),
                   Min_Length_cm_SMÅ = 
                     min(Length_cm[sizeSortingDFU=="SMÅ"],na.rm=T),
                   
                   TotalWeight_kg_STO = 
                     sum(unique(TotalWeight_kg[sizeSortingDFU=="STO"]),na.rm=T),
                   TotalNumber_STO = 
                     sum(TotalNumber[sizeSortingDFU=="STO"],na.rm=T),
                   MeanLength_cm_STO = 
                     sum(SOP_Length[sizeSortingDFU=="STO"],na.rm=T)/
                     sum(TotalNumber[sizeSortingDFU=="STO"],na.rm=T),
                   Min_Length_cm_STO = 
                     min(Length_cm[sizeSortingDFU=="STO"],na.rm=T),
                   
                   TotalWeight_kg = sum(unique(TotalWeight_kg),na.rm=T),
                   TotalNumber = sum(TotalNumber,na.rm=T),
                   MeanLength_cm = 
                     sum(SOP_Length,na.rm=T)/sum(TotalNumber,na.rm=T),
                   Min_Length_cm = min(Length_cm,na.rm=T)) 



if (species=="SST") {data2$Min_Length_cm <- NULL; data2$MeanLength_cm <- NULL;}
if (species=="SKL") {data2$Min_Length_cm <- NULL; data2$MeanLength_cm <- NULL;}


```



```{r fangst_and_korrigeret_fangst, echo=F,include=F,warning=F,message=F}

#Catch per m2 - overall and spread out with new variables
data2$Fangst_kg_m2_SMÅ <- data2$TotalWeight_kg_SMÅ/as.numeric(data2$Befisket_Areal_m2)
data2$Fangst_kg_m2_STO <- data2$TotalWeight_kg_STO/as.numeric(data2$Befisket_Areal_m2)
data2$Fangst_kg_m2 <- data2$TotalWeight_kg/as.numeric(data2$Befisket_Areal_m2)


data2[species==species & 
        data2$speciesCode==species,
      paste0("fangst_",tolower(species),"_kg_m2_SMÅ")] <- 
        as.numeric(data2[species==species & 
                           data2$speciesCode==species,]$Fangst_kg_m2_SMÅ)
data2[species==species & 
        data2$speciesCode==species,
      paste0("fangst_",tolower(species),"_kg_m2_STO")] <- 
        as.numeric(data2[species==species & 
                           data2$speciesCode==species,]$Fangst_kg_m2_STO)

data2[species==species & 
        data2$speciesCode==species,
      paste0("fangst_",tolower(species),"_kg_m2")] <- 
        as.numeric(data2[species==species & 
                           data2$speciesCode==species,]$Fangst_kg_m2)


#### Korrigeret fangst ####

    
    #BMS
    # data2[data2$stationType=="BMS" & data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_SMÅ"] <- 
    #     data2[data2$stationType=="BMS" & data2$speciesCode=="BMS",]$Fangst_kg_m2_SMÅ/(
    #       (37*data2[data2$stationType=="BMS" & 
    #                   data2$speciesCode=="BMS",]$Fangst_kg_m2^0.71)/100)
    data2[data2$stationType=="BMS" & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_STO"] <- 
        data2[data2$stationType=="BMS" &
                data2$speciesCode=="BMS",]$Fangst_kg_m2_STO/(
          (37*data2[data2$stationType=="BMS" & 
                      data2$speciesCode=="BMS",]$Fangst_kg_m2^0.71)/100)
    data2[data2$stationType=="BMS" & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2"] <- 
        data2[data2$stationType=="BMS" &
                data2$speciesCode=="BMS",]$Fangst_kg_m2/(
          (37*data2[data2$stationType=="BMS" & 
                      data2$speciesCode=="BMS",]$Fangst_kg_m2^0.71)/100)
        data2[data2$stationType=="BMS" &
                data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_SMÅ"] <- 
          data2[data2$stationType=="BMS" &
                data2$speciesCode=="BMS","Korrigeret_bms_kg_m2"] - 
          data2[data2$stationType=="BMS" &
                data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_STO"]
        
    # data2[data2$stationType=="BOS" & data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_SMÅ"] <- 
    #   data2[data2$stationType=="BOS" & data2$speciesCode=="BMS",]$Fangst_kg_m2_SMÅ*2.47
    data2[data2$stationType=="BOS" & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_STO"] <- 
      data2[data2$stationType=="BOS" & 
              data2$speciesCode=="BMS",]$Fangst_kg_m2_STO*2.47
    data2[data2$stationType=="BOS" & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2"] <- 
      data2[data2$stationType=="BOS" & 
              data2$speciesCode=="BMS",]$Fangst_kg_m2*2.47
        data2[data2$stationType=="BOS" &
                data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_SMÅ"] <- 
      data2[data2$stationType=="BOS" & 
              data2$speciesCode=="BMS","Korrigeret_bms_kg_m2"] - 
          data2[data2$stationType=="BOS" & 
              data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_STO"]
     
    # data2[data2$stationType=='RAM' & data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_SMÅ"] <-  
    #     data2[data2$stationType=='RAM' & data2$speciesCode=="BMS",]$Fangst_kg_m2_SMÅ 
    # data2[data2$stationType=='SUG' & data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_SMÅ"] <- 
    #     data2[data2$stationType=='SUG' & data2$speciesCode=="BMS",]$Fangst_kg_m2_SMÅ 
    data2[data2$stationType=='RAM' & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_STO"] <- 
        data2[data2$stationType=='RAM' &
                data2$speciesCode=="BMS",]$Fangst_kg_m2_STO
    data2[data2$stationType=='SUG' & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_STO"] <- 
        data2[data2$stationType=='SUG' &
                data2$speciesCode=="BMS",]$Fangst_kg_m2_STO 
    data2[data2$stationType=='RAM' & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2"] <- 
        data2[data2$stationType=='RAM' & 
                data2$speciesCode=="BMS",]$Fangst_kg_m2 
    data2[data2$stationType=='SUG' & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2"] <- 
        data2[data2$stationType=='SUG' &
                data2$speciesCode=="BMS",]$Fangst_kg_m2
    data2[data2$stationType=='RAM' & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_SMÅ"] <- 
        data2[data2$stationType=='RAM' & 
                data2$speciesCode=="BMS",]$Fangst_kg_m2_SMÅ 
    data2[data2$stationType=='SUG' & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_SMÅ"] <- 
        data2[data2$stationType=='SUG' & 
                data2$speciesCode=="BMS",]$Fangst_kg_m2_SMÅ 
        
            
    # BMS-OKYST
    # data2[data2$stationType=="BMSOK", "Korrigeret_bms_kg_m2"] <-
    #   data2[data2$stationType=="BMSOK",]$Fangst_kg_m2*(1/65*100)
    # data2[data2$stationType=="BMSOK", "Korrigeret_bms_kg_m2_SMÅ"] <-
    #   0.073 * ((data2[data2$stationType=="BMSOK",]$Fangst_kg_m2_SMÅ)^1.696) + 
    #   data2[data2$stationType=="BMSOK",]$Fangst_kg_m2_SMÅ
    data2[data2$stationType=="BMSOK" & 
            data2$speciesCode=="BMS", "Korrigeret_bms_kg_m2_STO"] <-
      0.073 * ((data2[data2$stationType=="BMSOK" & 
            data2$speciesCode=="BMS",]$Fangst_kg_m2_STO)^1.696) + 
      data2[data2$stationType=="BMSOK" & 
            data2$speciesCode=="BMS",]$Fangst_kg_m2_STO
    
    data2[data2$stationType=="BMSOK" & 
            data2$speciesCode=="BMS", "Korrigeret_bms_kg_m2"] <-
      0.073 * ((data2[data2$stationType=="BMSOK" & 
            data2$speciesCode=="BMS",]$Fangst_kg_m2)^1.696) + 
      data2[data2$stationType=="BMSOK" & 
            data2$speciesCode=="BMS",]$Fangst_kg_m2
    
    data2[data2$stationType=="BMSOK" & 
            data2$speciesCode=="BMS", "Korrigeret_bms_kg_m2_SMÅ"] <-
      data2[data2$stationType=="BMSOK" & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2"] - 
      data2[data2$stationType=="BMSOK" & 
            data2$speciesCode=="BMS","Korrigeret_bms_kg_m2_STO"]
    
    
    data2[data2$stationType=="BMSOK", "Korrigeret_sst_kg_m2"] <- 
      data2[data2$stationType=="BMSOK",]$Fangst_kg_m2*(1/50*100)

    
    #OES 
    data2[data2$stationType=="OES" & data2$speciesCode=="OES","Korrigeret_oes_kg_m2"] <- 
        data2[data2$stationType=="OES" & data2$speciesCode=="OES",]$Fangst_kg_m2*3
    data2[data2$stationType=="BOS" & data2$speciesCode=="OES","Korrigeret_oes_kg_m2"] <-
        data2[data2$stationType=="BOS" & data2$speciesCode=="OES",]$Fangst_kg_m2*(1/42*100)
    data2[data2$stationType=="SUG" & data2$speciesCode=="OES","Korrigeret_oes_kg_m2"] <- 
        data2[data2$stationType=="SUG" & data2$speciesCode=="OES",]$Fangst_kg_m2


    #SST
    data2[data2$stationType=="SST" & data2$speciesCode=="SST","Korrigeret_sst_kg_m2"] <-
    	  data2[data2$stationType=="SST" & data2$speciesCode=="SST",]$Fangst_kg_m2
    data2[data2$stationType=="BMS" & data2$speciesCode=="SST","Korrigeret_sst_kg_m2"] <-
    	  data2[data2$stationType=="BMS" & data2$speciesCode=="SST",]$Fangst_kg_m2*2
    data2[data2$stationType=="OES" & data2$speciesCode=="SST","Korrigeret_sst_kg_m2"] <-
    	  data2[data2$stationType=="OES" & data2$speciesCode=="SST",]$Fangst_kg_m2*5
    data2[data2$stationType=="BOS" & data2$speciesCode=="SST","Korrigeret_sst_kg_m2"] <-
    	  data2[data2$stationType=="BOS" & data2$speciesCode=="SST",]$Fangst_kg_m2*5
    #SKL
    data2[data2$stationType=="BMS" & data2$speciesCode=="SKL" & species=="SKL","Korrigeret_skl_kg_m2"] <-
        data2[data2$stationType=="BMS" & data2$speciesCode=="SKL" & species=="SKL",]$Fangst_kg_m2/((37*(
        data2[data2$stationType=="BMS" & data2$speciesCode=="SKL" & species=="SKL",]$Fangst_kg_m2)^0.71)/100)
    #OST
    data2[data2$stationType=="BMS" & data2$speciesCode=="OST","Korrigeret_ost_kg_m2"] <-
    	  data2[data2$stationType=="BMS" & data2$speciesCode=="OST",]$Fangst_kg_m2
    data2[data2$stationType=="OES" & data2$speciesCode=="OST","Korrigeret_ost_kg_m2"] <-
    	  data2[data2$stationType=="OES" & data2$speciesCode=="OST",]$Fangst_kg_m2
    data2[data2$stationType=='RAM' & data2$speciesCode=="OST","Korrigeret_ost_kg_m2"] <- 
        data2[data2$stationType=='RAM' & data2$speciesCode=="OST",]$Fangst_kg_m2 
    data2[data2$stationType=='BOS' & data2$speciesCode=="OST","Korrigeret_ost_kg_m2"] <-
        data2[data2$stationType=='BOS' & data2$speciesCode=="OST",]$Fangst_kg_m2*(1/42*100)
    data2[data2$stationType=='SUG' & data2$speciesCode=="OST","Korrigeret_ost_kg_m2"] <- 
        data2[data2$stationType=='SUG' & data2$speciesCode=="OST",]$Fangst_kg_m2 

    #HMS
    data2[data2$stationType=='RAM' & data2$speciesCode=="HMS","Korrigeret_hms_kg_m2"] <- 
        data2[data2$stationType=='RAM' & data2$speciesCode=="HMS",]$Fangst_kg_m2 
    data2[data2$stationType=='VV' & data2$speciesCode=="HMS","Korrigeret_hms_kg_m2"] <- 
        data2[data2$stationType=='VV' & data2$speciesCode=="HMS",]$Fangst_kg_m2
    data2[data2$stationType=='SUG' & data2$speciesCode=="HMS","Korrigeret_hms_kg_m2"] <- 
        data2[data2$stationType=='SUG' & data2$speciesCode=="HMS",]$Fangst_kg_m2


```



```{r final_correction_selction,echo=F,include=F,warning=F,message=F}


#Select data depending on mark and sample ID

data2[data2$stationType=="OES" & data2$speciesCode=="OES" & species=="OES" |
      data2$stationType=="OES" & data2$speciesCode=="BMS" & species=="BMS" |
      data2$stationType=="OES" & data2$speciesCode=="SST" & species=="SST" |
      data2$stationType=="OES" & data2$speciesCode=="OST" & species=="OST" |
        
      data2$stationType=="BMS" & data2$speciesCode=="OES" & species=="OES" |
      data2$stationType=="BMS" & data2$speciesCode=="BMS" & species=="BMS" |
      data2$stationType=="BMS" & data2$speciesCode=="SST" & species=="SST" |
      data2$stationType=="BMS" & data2$speciesCode=="SKL" & species=="SKL" |
      data2$stationType=="BMS" & data2$speciesCode=="OST" & species=="OST" |
      
      data2$stationType=="RAM" & data2$speciesCode=="HMS" & species=="HMS" |
      data2$stationType=="RAM" & data2$speciesCode=="BMS" & species=="BMS" |
      data2$stationType=="RAM" & data2$speciesCode=="OST" & species=="OST" |
        
      data2$stationType=="SST" & data2$speciesCode=="SST" & species=="SST" |
        
      data2$stationType=="VV" & data2$speciesCode=="HMS" & species=="HMS" |
      
      data2$stationType=="SUG" & data2$speciesCode=="BMS" & species=="BMS" |      
      data2$stationType=="SUG" & data2$speciesCode=="OST" & species=="OST" |
      data2$stationType=="SUG" & data2$speciesCode=="HMS" & species=="HMS" |
        
      data2$stationType=="BOS" & data2$speciesCode=="OES" & species=="OES" |
      data2$stationType=="BOS" & data2$speciesCode=="BMS" & species=="BMS" |
      data2$stationType=="BOS" & data2$speciesCode=="OST" & species=="OST" |
      data2$stationType=="BOS" & data2$speciesCode=="SST" & species=="SST" |
      
      data2$stationType=="BMSOK" & data2$speciesCode=="OES" & species=="OES" |
      data2$stationType=="BMSOK" & data2$speciesCode=="BMS" & species=="BMS" |
      data2$stationType=="BMSOK" & data2$speciesCode=="SST" & species=="SST" |
      data2$stationType=="BMSOK" & data2$speciesCode=="SKL" & species=="SKL" |
      data2$stationType=="BMSOK" & data2$speciesCode=="OST" & species=="OST" ,
      "mark"]  <-1


data2[is.na(data2$mark),"mark"] <- 2
data3 <- data2[with(data2, order(sampleId,mark)), ]

dat_spp <- subset(data3, speciesCode %in% species)

dat_no_spp <- slice(arrange(group_by(subset(data3, !(sampleId %in% dat_spp$sampleId)), sampleId), sampleId, mark, speciesCode), 1)

data4 <- rbind(dat_spp, dat_no_spp)

# Removing slow loop
# data4 <- data3[0,]
# for (sample in unique(data3$sampleId)){
#   dat <- data3[data3$sampleId==sample,]
# 
#   if (species %in% unique(dat$speciesCode)){
#     data4 <- rbind(data4,dat[dat$speciesCode==species,])
#     }
#   if (!(species %in% unique(dat$speciesCode))){
#     data4 <- rbind(data4,dat[1,])
#     }
#   }

# 
# first_sampleId <- c(1,1+which(diff(data3$sampleId)!=0))
# data4 <-data3[first_sampleId,] # data2[data2$mark==1, ]#
data4$mark <- NULL
data4$sampleId <- NULL

## Remove "korrigeret" catch values for other species than the one in question

if (species=="BMS") {
  data4$Korrigeret_oes_kg_m2<-NULL;
  data4$Korrigeret_sst_kg_m2<-NULL;
  data4$Korrigeret_skl_kg_m2<-NULL;
  data4$Korrigeret_hms_kg_m2<-NULL;
  data4$Korrigeret_ost_kg_m2<-NULL
  }
if (species=="OES") {
    data4$Korrigeret_bms_kg_m2<-NULL;
  data4$Korrigeret_bms_kg_m2_STO<-NULL;
  data4$Korrigeret_bms_kg_m2_SMÅ<-NULL;
  data4$Korrigeret_sst_kg_m2<-NULL;
  data4$Korrigeret_skl_kg_m2<-NULL;
  data4$Korrigeret_hms_kg_m2<-NULL;
  data4$Korrigeret_ost_kg_m2<-NULL
  }
if (species=="SST") {
    data4$Korrigeret_bms_kg_m2<-NULL;
  data4$Korrigeret_bms_kg_m2_STO<-NULL;
  data4$Korrigeret_bms_kg_m2_SMÅ<-NULL;
  data4$Korrigeret_oes_kg_m2<-NULL;
  data4$Korrigeret_skl_kg_m2<-NULL;
  data4$Korrigeret_hms_kg_m2<-NULL;
  data4$Korrigeret_ost_kg_m2<-NULL
  }
if (species=="SKL") {
    data4$Korrigeret_bms_kg_m2<-NULL;
  data4$Korrigeret_bms_kg_m2_STO<-NULL;
  data4$Korrigeret_bms_kg_m2_SMÅ<-NULL;
  data4$Korrigeret_sst_kg_m2<-NULL;
  data4$Korrigeret_oes_kg_m2<-NULL;
  data4$Korrigeret_hms_kg_m2<-NULL;
  data4$Korrigeret_ost_kg_m2<-NULL
  }
if (species=="HMS") {
    data4$Korrigeret_bms_kg_m2<-NULL;
  data4$Korrigeret_bms_kg_m2_STO<-NULL;
  data4$Korrigeret_bms_kg_m2_SMÅ<-NULL;
  data4$Korrigeret_sst_kg_m2<-NULL;
  data4$Korrigeret_oes_kg_m2<-NULL;
  data4$Korrigeret_skl_kg_m2<-NULL;
  data4$Korrigeret_ost_kg_m2<-NULL
  }
if (species=="OST") {
  data4$Korrigeret_bms_kg_m2<-NULL;
  data4$Korrigeret_bms_kg_m2_STO<-NULL;
  data4$Korrigeret_bms_kg_m2_SMÅ<-NULL;
  data4$Korrigeret_sst_kg_m2<-NULL;
  data4$Korrigeret_oes_kg_m2<-NULL;
  data4$Korrigeret_skl_kg_m2<-NULL;
  data4$Korrigeret_hms_kg_m2<-NULL
  }


## Final corrections - zeroes/NA's

data4[is.na(data4$TotalWeight_kg),"TotalWeight_kg"] <- 0
data4[is.na(data4$Fangst_kg_m2),"Fangst_kg_m2"] <- 0
data4[is.na(data4[[paste0("fangst_",tolower(species),"_kg_m2")]]),
      paste0("fangst_",tolower(species),"_kg_m2")] <- 0

data4[is.na(data4[[paste0("Korrigeret_",tolower(species),"_kg_m2")]]),
      paste0("Korrigeret_",tolower(species),"_kg_m2")] <- 0
data4[data4[[paste0("fangst_",tolower(species),"_kg_m2")]]==0,
      "TotalWeight_kg"] <- 0
data4[data4[[paste0("fangst_",tolower(species),"_kg_m2")]]==0,
      "TotalNumber"] <- 0
data4[data4[[paste0("fangst_",tolower(species),"_kg_m2")]]==0,
      "Fangst_kg_m2"] <- 0
data4[data4[[paste0("fangst_",tolower(species),"_kg_m2")]]==0,
      paste0("Korrigeret_",tolower(species),"_kg_m2")] <- 0

if (species %in% c("OES","BMS","HMS")) {
    data4[data4[[paste0("fangst_",tolower(species),"_kg_m2")]]==0,
          "Min_Length_cm"] <- NA
    data4[data4[[paste0("fangst_",tolower(species),"_kg_m2")]]==0,
          "MeanLength_cm"] <- NA

}

final_data <- data4

final_data[, c(23:ncol(final_data))][
  is.na(final_data[, c(23:ncol(final_data))])] <- 0

final_data$Min_Length_cm_SMÅ[is.infinite(final_data$Min_Length_cm_SMÅ)]<-0
final_data$Min_Length_cm_STO[is.infinite(final_data$Min_Length_cm_STO)]<-0
# final_data[is.infinite(final_data)] <- 0
```





```{r db_messages, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H', eval = F}


makeTable <- function(data){
  
  bold <- function(x) {paste('{\\textbf{',x,'}}', sep ='')}
  rws <- seq(1, nrow(data) - 1, by = 2)
  col <- rep("\\rowcolor{Aquamarine!50!white}", length(rws))
  
  options(xtable.comment = FALSE)
  print(
    xtable(x = data, align = c(
      rep("l", 4), rep("p{5cm}", 1), rep("p{2cm}", 1), rep("l", 1)
    )),
    include.rownames = F,
    #sanitize.colnames.function = identity,
    sanitize.colnames.function = bold,
    booktabs = T,
    add.to.row = list(pos = as.list(rws), command=col)
  )

}
cat("# Meddelelser fra datawarehouset\n")
cat("Her vil der blive vist eventuelle fejl og advarsler fra ejsporten af togtet fra databasen til datawarehouset. Fejl og advarsler kan forklare uventede resultater, men kan også være af mindre betydning. Hvis der er lavet ændringer siden den anførte logTime og der har været efterfølgende eksport af togtet uden at logTime har ændret sig, betyder det at togtet efter ændringer ikke har udløst nye fejl.\n\n")

if (nrow(db_message)>0){
  
  db_message$year <- 0
  db_message$cruise <- ""
  db_message$trip <- ""
  db_message$station <- ""
  
  for (i in 1:nrow(db_message)){
    origin <- strsplit(db_message$origin[i],split="->")
    
    db_message$year[i] <- as.numeric(origin[[1]][1])
    db_message$cruise[i] <- origin[[1]][2]
    db_message$trip[i] <- origin[[1]][3]
    db_message$station[i] <- origin[[1]][4]
  }
  
  db_message$logTime <- as.character(db_message$logTime)
  
  warnings <- db_message[db_message$errorType=="Warning",]
  errors <- db_message[db_message$errorType=="Error",]
 
}

cat("\\subsection{Advarsler fra datawarehouset}")
# if (exists("warnings")){
  if (!is.null(nrow(warnings)) && nrow(warnings)>0){

  w <- warnings %>% 
    dplyr::select(trip,station,recordType,description,logTime,transferErrorId) 
  
  makeTable(w)

} else{
  cat("Der har ikke været registreret advarsler fra datawarehouset\n")
}


cat("\\subsection{Fejlmeddelelser fra datawarehouset}")

if (!is.null(nrow("errors")) && nrow(errors)>0){
  
  er <- errors %>% 
    dplyr::select(trip,station,recordType,description,logTime,transferErrorId) 
  
  makeTable(er)
} else{
  cat("Der har ikke været registreret fejl fra datawarehouset\n")
  }
 
```


```{r save_output, echo=FALSE, warning=FALSE,message=FALSE}

#Write csv
# cruise <- gsub(" ","_",cruise)
# write.csv(final_data, 
#           file=paste("Biomasse_",year,"_",cruise,"_",species,"_",
#                      format(Sys.time(), "%d%b%Y"),".csv",sep=""),
#           row.names=FALSE,fileEncoding = "UTF-8")

# Output folder for testing - delete this part before uploade to FishLine

write.csv(final_data,
          file = paste(output_dir, "Biomasse_",species,"_",version_name,"_",
                     format(Sys.time(), "%d%b%Y"),".csv",sep = ""),
          row.names=FALSE,fileEncoding = "UTF-8")

saveRDS(final_data,
          file = paste(output_dir, "Biomasse_",species,"_",version_name,"_",
                     format(Sys.time(), "%d%b%Y"),".rds",sep = ""))


```

```{r ref_annex, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.pos='H', eval = F}

cat("\n\\newpage\n")
cat("# Annex 1 - Reference tabel\n")

makeTable(ref_species)

```

