
---
fontsize: 12pt
geometry: top=2cm, bottom=1cm, left=2cm, right=2cm,headsep=1cm
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{floatrow}
- \usepackage[T1]{fontenc}
- \usepackage[danish]{babel}
- \usepackage[utf8]{inputenc}
- \usepackage{graphicx}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhf{}
- \fancyfoot{}
- \usepackage{pifont}
- \usepackage{amssymb}
- \usepackage[table]{xcolor}
- \usepackage{ragged2e}
- \usepackage{catchfile}
- \usepackage{array}
- \usepackage[export]{adjustbox}
- \usepackage{multirow}
- \linespread{1.15}
- \usepackage{tabularx}
- \usepackage{tcolorbox}
- \usepackage{lipsum}
- \usepackage{float}
- \usepackage{lastpage}
output:
  pdf_document: default
  fig_caption: yes
  keep_tex: yes
---

\renewcommand{\familydefault}{\sfdefault}
\sffamily


\setlength{\LTleft}{-20cm plus -1fill}
\setlength{\LTright}{\LTleft}


\lhead{\footnotesize \color{darkgray}  Kvalitet og Status - Discardindsamling}
\rhead{\footnotesize  \color{darkgray} SIDE \color{red} \thepage\ \color{darkgray} AF \color{darkgray} \pageref*{LastPage} }

```{r define_input, echo=FALSE}

#Parameters
# year<- @paramYear
# quarter <- @paramQuarter
# cruise <- @paramCruise
# mappath <- 'europe_simple_wgs84'
 

year<- 2018
quarter <- 1
cruise <- 'MON'
mappath <- "../Discardtjek/kort/europe_simple_wgs84"


```




```{r set_libraries, include=FALSE}

#Libraries
if (!require(sqldf)) {
  install.packages("sqldf", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(sqldf)
}
if (!require(RODBC)) {
  install.packages("RODBC", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(RODBC)
}
if (!require(plyr)) {
  install.packages("plyr", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(plyr)
}
if (!require(xtable)) {
  install.packages("xtable", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(xtable)
}
if (!require(gplots)) {
  install.packages("gplots", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(gplots)
}
if (!require(grid)) {
  install.packages("grid", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(grid)
}
if (!require(reshape2)) {
  install.packages("reshape2", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(reshape2)
}
if (!require(ggrepel)) {
  install.packages("ggrepel", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(ggrepel)
}
 if (!require(grid)) {
  install.packages("grid", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(grid)
} 
 if (!require(gridExtra)) {
  install.packages("gridExtra", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(gridExtra)
}
 if (!require(gplots)) {
  install.packages("gplots", repos="http://ftp.ussg.iu.edu/CRAN/")
  library(gplots)
} 
 if (!require(Hmisc)) {
  install.packages("Hmisc", repos="http://ftp.ussg.iu.edu/CRAN/")
}  
 if (!require(stringr)) {
  install.packages("stringr", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(dismo)) {
  install.packages("dismo", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(raster)) {
  install.packages("raster", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(marmap)) {
  install.packages("marmap", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(rgdal)) {
  install.packages("rgdal", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(maptools)) {
  install.packages("maptools", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(rasterVis)) {
  install.packages("rasterVis", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(shapefiles)) {
  install.packages("shapefiles", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(calibrate)) {
  install.packages("calibrate", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(plotrix)) {
  install.packages("plotrix", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(base)) {
  install.packages("base", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(mapplots)) {
  install.packages("mapplots", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
 if (!require(data.table)) {
  install.packages("data.table", repos="http://ftp.ussg.iu.edu/CRAN/")
}   
 if (!require(dplyr)) {
  install.packages("dplyr", repos="http://ftp.ussg.iu.edu/CRAN/")
} 
if (!require(Hmisc)) {
  install.packages("Hmisc", repos="http://ftp.ussg.iu.edu/CRAN/")
}
if (!require(colorspace)) {
  install.packages("colorspace", repos="http://ftp.ussg.iu.edu/CRAN/")
}
detach(package:Hmisc)

```





```{r functions1, include=FALSE}




round2 = function(x) trunc(x+0.5);
sumNA = function(x) sum(x,na.rm=T);

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}


simpleCap <- function(x) {
  s <- strsplit(tolower(x), " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
      sep="", collapse=" ")
}


mylatex <- function (...) {
  o <- capture.output(latex(...))
  o <- grep('^%', o, inv=T, value=T)
  cat(o, sep='\n')
}

printQtr <- function(q,y,qtr=quarter){
  if (qtr<5){
    return(q)
  }else{
    return(y)
  }
}

```

```{r echo = F, include=FALSE}
library(knitr)
opts_chunk$set(fig.lp = '')
```

```{r include=FALSE, cache=FALSE} 

########## Collecting data from Fishline ###########



channel <- odbcConnect("FishLineDW")
sample <- sqlQuery(channel,paste("SELECT   Sample.tripId, Sample.trip, Sample.station, Sample.fishingtime, Sample.latPosStartDec AS lat, 
                                           Sample.lonPosStartDec AS lon,Sample.latPosStartText AS latT, 
                                           Sample.lonPosStartText AS lonT, Sample.catchRegistration, 
                                           Sample.speciesRegistration, Sample.gearType, Sample.selectionDevice,
                                           Sample.meshSize, Sample.dfuArea, Sample.statisticalRectangle, Sample.quarterGearStart as qtr,
                                           Sample.remark
                                  FROM     Sample
                                  WHERE    Sample.year = (",year,") AND
                                           Sample.cruise = ('",cruise, "') AND 
                                           Sample.quarterGearStart <=  ('",quarter, "')", sep = ""), stringsAsFactors=FALSE
                  
                 )
speciesList <- sqlQuery(channel,
                        sprintf("SELECT  SpeciesList.station,SpeciesList.speciesCode, SpeciesList.landingCategory,
                                               SpeciesList.number,SpeciesList.raisingFactor, SpeciesList.weightStep0, 
                                               SpeciesList.weightStep1, SpeciesList.weightStep2, SpeciesList.weightStep3,
                                               SpeciesList.treatmentFactor, SpeciesList.totalWeight, SpeciesList.trip,
                                               SpeciesList.quarterGearStart as qtr, SpeciesList.remark   
                                       FROM    SpeciesList
                                       WHERE   SpeciesList.year = (%s) AND
                                               SpeciesList.cruise = ('%s') AND 
                                               SpeciesList.quarterGearStart <=  ('%s') ", 
                                year,cruise,quarter), 
                        stringsAsFactors=FALSE)

animal <- sqlQuery(channel,
                   sprintf("SELECT    Animal.year, Animal.cruise, Animal.trip,Animal.station, Animal.speciesCode, 
                                            Animal.dfuArea, Animal.number, Animal.length,Animal.weight, Animal.landingCategory, 
                                            Animal.individNum, Animal.representative, Animal.quarterGearStart as qtr
                                  FROM      Animal
                                  WHERE     Animal.year = (%s) AND
                                            Animal.cruise = ('%s') AND 
                                            Animal.quarterGearStart <=  ('%s') ",
                           year,cruise,quarter),
                   stringsAsFactors=FALSE)

l_species <- sqlQuery(channel,paste("SELECT   L_Species.speciesCode, L_Species.dkName
                                     FROM    L_Species", sep = ""), stringsAsFactors=FALSE
                      )


tripIds <- unique(sample$tripId) 

trip <- sqlQuery(channel,
                 sprintf("SELECT     Trip.year, Trip.contactPersonName , Trip.trip, Trip.cruise, tripLeaderName, dateStart, 
                                           dateEnd, platform1, Trip.logBldNr,Trip.samplingMethod, Trip.fisheryType,Trip.remark,
                                           DATEPART(quarter,dateStart) as qtr, Trip.tripLeaderId
                                FROM       Trip
                                WHERE      Trip.tripId IN ('%s')", 
                         paste(tripIds,collapse = "','")),
                 stringsAsFactors=FALSE)

close(channel)

personId <- unique(trip$tripLeaderId) 
personId <- personId[!is.na(personId)]

channel <- odbcConnect("FishLine")
person <- sqlQuery(channel,
                   sprintf("SELECT     dfuPersonId, initials
                                  FROM       DFUPerson
                                  WHERE      DFUPerson.dfuPersonId IN ('%s')",
                           paste(personId,collapse = "','")),
                   stringsAsFactors=FALSE)
close(channel)

``` 


\thispagestyle{empty}

\vspace*{2cm} 


```{r ,echo=F}
headline <- printQtr("Kvartalstjek og status på discardindsamlingerne",
                     "Årstjek og status på discardindsamlingerne")

headline2 <- printQtr(sprintf("%s. Kvartal %s",quarter,year),
                      sprintf("%s",year))

```
\textbf{\LARGE `r headline`}
        
\vspace{3cm}   

\textbf{\LARGE `r headline2`}



\vspace{0.5cm}

\textbf{\Large Togt:}
\textbf{\Large `r cruise`}\






\newpage

\renewcommand{\contentsname}{Indhold}
\tableofcontents

\newpage




\part{Mangler, indtastningsfejl og outliers}

\section{Ture}

Tabellen herunder viser de ture, hvor nogle af informationerne: observatør, skipper, metode, type eller logbogsbladnummer mangler.


\small
\renewcommand{\arraystretch}{1.1}
\renewcommand{\tabcolsep}{8pt}

```{r data_out2, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H'}

#Check for missing trip informations

trip_input <- trip %>% 
  dplyr::filter(if (quarter< 5) qtr==quarter else qtr<5) %>% 
  dplyr::select(trip,tripLeaderName,contactPersonName,samplingMethod,fisheryType,logBldNr,remark)

row.names(trip_input) <- trip_input$trip

trip_input <- trip_input %>% dplyr::select(-trip)
#trip_input$trip <- as.character(trip_input$trip)
trip_input$fisheryType <- as.character(trip_input$fisheryType)
trip_input$contactPersonName <-  sapply(trip_input$contactPersonName, simpleCap)
trip_input[is.na(trip_input$remark) | trip_input$remark=="\r\n","remark"] <- "-"

colnames(trip_input) <- c("\\bf Observatør","\\bf Skipper","\\bf Metode","\\bf Type","\\bf Log-nummer","\\bf Bemærkning")
mis_trip <- trip_input[!complete.cases(trip_input[,-6]),]


mis_trip[is.na(mis_trip)] <- "\\color{red} \\textsl{Mangler}"

####################################################################

#Make table

if (nrow(mis_trip)>0) {

library(Hmisc)
     mylatex(mis_trip,file='',booktabs =T,rowlabel="\\bf Tur",where='H', collabel.just="l",
             col.just=c("l","p{1.2in}","l","l","l","p{1in}"),longtable= TRUE, lines.page=5000)
detach(package:Hmisc)
     
  
}
```


\newpage

\section{Stationer}


\subsection{Positioner}

Tabellen viser de stationer, hvor det ikke har været muligt at assosiere et ICES område og/eller square til stationen. Alle stationer er også vist på kortet i figur \ref{fig:map}, hvor stationer uden område og square er vist med grønt. 

\vspace{0.2cm}

\renewcommand{\tabcolsep}{12pt}



\begin{center}
```{r stations, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H'}

#Check for missing trip informations

# stat_input <- sample[sample$qtr== quarter,c("trip","station","lat","lon","latT","lonT","dfuArea","statisticalRectangle")]
stat_input <- sample %>% 
  dplyr::filter(if(quarter<5) qtr==quarter else !is.na(qtr)) %>% 
  dplyr::select(trip,station,lat,lon,latT,lonT,dfuArea,statisticalRectangle)

mis_stat <- stat_input[!complete.cases(stat_input),-c(3:4)]


if (nrow(mis_stat)>0) {

mis_stat[is.na(mis_stat)] <- "\\color{red} \\textsl{Mangler}"

mis_stat <- mis_stat[order(mis_stat$trip,mis_stat$station),] 
colnames(mis_stat) <- c("\\bf Tur","\\bf Station","\\bf Længdegrad","\\bf Breddegrad",
                        "\\bf ICES område","\\bf ICES square")

####################################################################

#Make table

library(Hmisc)
     mylatex(mis_stat,file='',booktabs =T,rowlabel="",rowname="",where='H', collabel.just="l",position='none',
             longtable= TRUE, lines.page=5000)
detach(package:Hmisc)
     
  
}

caption <- printQtr(sprintf("Stationer på alle %s-ture i %s. kvartal, %s.\\label{fig:map}",
                            cruise,quarter,year),
                    sprintf("Stationer på alle %s-ture i %s.\\label{fig:map}",
                            cruise,year))

```
\end{center}

\vspace*{-2.5cm}

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=7, fig.height=7,fig.cap=caption,fig.pos='H'}

#pos <- data_sample[,c("station","stationName","gearType","gearQuality","lat","lon","dfuArea")]

coast <- read.shapefile(mappath)

  ylim <- c(floor(-0.5+min(stat_input$lat,na.rm=T))-.5,floor(0.5+max(stat_input$lat,na.rm=T))+.5)
  xlim <- c(floor(-0.5+min(stat_input$lon,na.rm=T))-.5,floor(0.5+max(stat_input$lon,na.rm=T))+.5)

########
col <- terrain.colors(12)


#####################################################################################################
##
##  Draw the map
##
#####################################################################################################

basemap(xlim=xlim, ylim=ylim, main = "",
        xlab=expression("Længdegrad"*~degree*"Ø"),
        ylab=expression("Breddegrad"*~degree*"N") ) #, bg="white")

draw.shape(coast, col="cornsilk", border="transparent", xlim=xlim, ylim=ylim)

draw.rect(col="grey")


#pointLabel(x, y, as.character(round(x,5)), offset = 0, cex = .7)

# if (any(is.na(stat_input$dfuArea) | is.na(stat_input$statisticalRectangle))) {
#   par(cex = 0.2)
#   pointLabel(x=stat_input[is.na(stat_input$dfuArea) | is.na(stat_input$statisticalRectangle),"lon"], 
#            y=stat_input[is.na(stat_input$dfuArea) | is.na(stat_input$statisticalRectangle),"lat"],
#            labels=as.character(stat_input[is.na(stat_input$dfuArea) | is.na(stat_input$statisticalRectangle),"station"]),
#            cex=3,offset=-1,allowSmallOverlap = FALSE)
# 
# }
par(cex = 0.8)
#text(x=pos[pos$gearQuality=="V","lon"], y=pos[pos$gearQuality=="V","lat"], 
#     labels=pos[pos$gearQuality=="V","stationName"], adj = c(1,1),cex=0.8)

points(stat_input$lon, stat_input$lat, pch=16, col="blue", cex=.8)

points(x=stat_input[is.na(stat_input$dfuArea) | is.na(stat_input$statisticalRectangle),"lon"], 
       y=stat_input[is.na(stat_input$dfuArea) | is.na(stat_input$statisticalRectangle),"lat"],
       pch=16, col="darkorange", cex=.8)

legend( x="bottomright", title = "Stationer",
        legend=c("Område ok", "Område ikke fundet"),
        pch=c(16, 16), col = c("blue","darkorange"),
        cex = 0.9)

```

\newpage


\subsection{Redskaber}

Tabellen giver et overblik over stationer, hvor der er fejl eller mangler i forbindelse med redskabet. I Kattegat (område 21) skal man bruge Seltra som selektionsudstyr, mens man i område 22-32 skal bruge Bacoma eller T90. Tabellen herunder vil derfor vise, hvis man har brugt et forkert selektrionsudtryr i et af områderne. I så fald vil selektionsudstyr og område være vist med rødt. Tabellen vil også fortælle, hvis maskevidden mangler.


\renewcommand{\tabcolsep}{12pt}

\begin{center}
```{r mis_gear, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H'}

#Check for missing trip informations

gear_input1 <- sample %>% 
  dplyr::filter(if (quarter<5) qtr== quarter else qtr < 5) %>%
  dplyr::select(trip,station,dfuArea,gearType,meshSize,selectionDevice)

gear_input1[gear_input1$gearType %in% c("LL","LLD","LLS") &
              is.na(gear_input1$meshSize),"meshSize"] <- "-"

mis_gear <- gear_input1[!complete.cases(gear_input1),]

gear_input <- gear_input1[complete.cases(gear_input1),]

gear_input[gear_input$dfuArea %in% c(21) & 
             !(gear_input$selectionDevice %in%
                 c("Seltra 300","Topløs/seltra >175mm","4 panel/270 diamant")) & 
             gear_input$gearType %in% c("OTB","OTT","PTB"),"dfuArea"] <- 
  paste("\\color{red}",
        gear_input[gear_input$dfuArea %in% c(21) &
                     !(gear_input$selectionDevice %in% 
                         c("Seltra 300","Topløs/seltra >175mm","4 panel/270 diamant")) & 
                     gear_input$gearType %in% c("OTB","OTT","PTB"),"dfuArea"])

gear_input[gear_input$dfuArea %in% c(22:32) & 
             !(gear_input$selectionDevice %in% c("110 Bacoma","120 Bacoma","T90")) & 
             gear_input$gearType %in% c("OTB","OTT","PTB"),"dfuArea"] <- 
  paste("\\color{red}",
        gear_input[gear_input$dfuArea %in% c(22:32) & 
                     !(gear_input$selectionDevice %in%
                         c("110 Bacoma","120 Bacoma","T90")) & 
                     gear_input$gearType %in% c("OTB","OTT","PTB"),"dfuArea"])

gear_input[gear_input$dfuArea %like% "\\color","selectionDevice"] <- 
  paste("\\color{red}",
        gear_input[gear_input$dfuArea %like% "\\color","selectionDevice"])

mis_gear2 <- rbind(gear_input[gear_input$dfuArea %like% "\\color",],mis_gear)

if (nrow(mis_gear2)>0) {

mis_gear2[is.na(mis_gear2)] <- "\\color{red} \\textsl{Mangler}"

mis_gear2 <- mis_gear2[order(mis_gear2$trip,mis_gear2$station),] 
colnames(mis_gear2) <- c("\\bf Tur","\\bf Station","\\bf ICES område","\\bf Redskab","\\bf Maskevidde","\\bf Selektionsredskab")

####################################################################

#Make table

library(Hmisc)
     mylatex(mis_gear2,file='',booktabs =T,rowlabel="",rowname="",where='H', collabel.just="l",position='none',
             longtable= TRUE, lines.page=5000)
detach(package:Hmisc)
     
  
}
```
\end{center}

\newpage


\subsection{Registrering og oparbejdning}

\subsubsection{Bemærkninger}

I tabellen her er vist de stationer, hvor der er angivet en bemærking.

```{r remark, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H'}

#Check for missing trip informations
reg_input <- printQtr(sample[sample$qtr==quarter,c("trip","station","catchRegistration","speciesRegistration","remark")],
                      sample[,c("trip","station","catchRegistration","speciesRegistration","remark")])

trip_remarks <- trip[,c("trip","remark")]
colnames(trip_remarks)[2]<-"tripRemark"

reg_input2 <- merge(reg_input,trip_remarks)

reg_input2$station <- as.character(reg_input2$station)

remark_reg <- reg_input2[!is.na(reg_input2$tripRemark) &!is.na(reg_input$remark),]

remark_reg[is.na(remark_reg)] <- " - "

remark_reg <- remark_reg[order(remark_reg$trip,remark_reg$station),] 
colnames(remark_reg) <- c("\\bf Tur","\\bf Station","\\bf Prøve- tagnings- niveau","\\bf Oparbejd- ning af arter","\\bf Bemærking til tur","\\bf Bemærking til station")

####################################################################

#Make table

if (nrow(remark_reg)>0) {

library(Hmisc)
     mylatex(remark_reg,file='',booktabs =T,rowlabel="",rowname="",where='H', collabel.just=c("l","l","p{1cm}","p{1cm}","p{4cm}","p{4cm}"),
             col.just=c("l","l","p{1cm}","p{1cm}","p{4cm}","p{4cm}"),longtable= TRUE, lines.page=5000)
detach(package:Hmisc)
     
  
}
```
\subsection{Artslister}

```{r LAV_vs_singlefish, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H'}


sfQ <-sprintf("SELECT     year,cruise,trip,station,speciesCode,sizeSortingEU,
landingCategory,individNum,number,representative 
                   FROM       Animal
                   WHERE      year IN ('%s') AND 
                              cruise = '%s' AND
                              quarterGearStart = '%s'",year,cruise,quarter)

# sfQ

channel <- odbcConnect("FishLineDW")
singleFish <- sqlQuery(channel, paste(sfQ),stringsAsFactors=FALSE)
close(channel)

singleFish2<-singleFish %>% 
  dplyr::group_by(trip,station,speciesCode,sizeSortingEU,landingCategory) %>% 
  dplyr::summarise(LAV = sum(number[is.na(individNum) & representative=="ja"]),
                   enkeltfiskRep = sum(number[!is.na(individNum) & 
                                                representative=="ja"]),
                   enkeltfiskEjRep = sum(number[!is.na(individNum) &
                                                  representative=="nej"]),
                   remark = ifelse(LAV<=enkeltfiskEjRep & LAV>0,
                                   "Samme antal eller flere fisk i Enkeltfisk, ej rep.
                                   end i LAV. Er det de samme fisk?",
                                   "")) %>% 
  dplyr::arrange(trip,station, speciesCode,sizeSortingEU,landingCategory) %>% 
  dplyr::filter(remark!="") %>%
  dplyr::ungroup()

for (rmk in sort(unique(singleFish2$remark))){
  singleFish3 <- subset(singleFish2,
                        singleFish2$remark==rmk, 
                        select = -remark)

  if (nrow(singleFish3)>0){
  
    cat(rmk)
  colnames(singleFish3)<-c("\\bf Tur","\\bf Station","\\bf Art","\\bf Sort.",
                           "\\bf Landings-kategori","\\bf LAV",
                           "\\bf Enkelt-fisk, rep.","\\bf Enkelt-fisk, ej rep.")
  
  library(Hmisc)
       mylatex(singleFish3,
               file='',booktabs =T,rowlabel="",rowname="",where='H',
               collabel.just=c(rep("l",4),rep("p{2cm}",1),rep("|p{2cm}",3)),
               col.just=c(rep("l",4),rep("p{2cm}",1),rep("|p{2cm}",3)),
               longtable= TRUE, lines.page=5000)
  detach(package:Hmisc)
  
  } else{
    cat("Der er ingen bemærkninger til LAV og enkeltfisk, ej rep.-tabellerne.")
  }
}
```


\section{Tjek af registrering og oparbejdningsniveau}

Her gives et overblik over de stationer, hvor der virker til at være en uoverensstemmelse mellem det valgte prøvetagningsniveau og/eller oparbejdning og hvad der faktisk er indtastet i artslisten.

Der tjekkes for følgende tilfælde


\begin{itemize}
\item{\textcolor{red}{Kode 1}: Artslisten er tom, men prøvetagningsniveau valgt til 'ALL'}
\item{\textcolor{red}{Kode 2}: Alle arter står som registreret og oparbejdet, men KON eller DIS er kun registreret ved DTO}
\item{\textcolor{red}{Kode 3}: Prøvetagningsniveau eller udvælgelses af arter ikke oplyst}
\end{itemize}


```{r registration, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H', include = F}

if (nrow(speciesList)>0) {

if (quarter<5){
  reg_stat1 <- unique(speciesList[speciesList$qtr==quarter,c("station","speciesCode","landingCategory","remark")])
  qtrsample <- sample[sample$qtr==quarter,c("trip","station","catchRegistration","speciesRegistration")]
} else {
  reg_stat1 <-unique(speciesList[,c("station","speciesCode","landingCategory","remark")])
  qtrsample <- sample[,c("trip","station","catchRegistration","speciesRegistration")]
}
  
reg_stat1[reg_stat1$speciesCode!="DTO",]$speciesCode <- "ART"
reg_stat2 <- unique(reg_stat1[,c("station","speciesCode","landingCategory","remark")])
reg_stat2$var <- paste0(reg_stat2$speciesCode,reg_stat2$landingCategory)

for (i in unique(reg_stat2$station)) {
   stat <- reg_stat2[reg_stat2$station==i,]
   reg_stat2[reg_stat2$station==i,"reg_var"] <- paste(stat$var, collapse = " ")
  
}

reg_stat2[grepl("ARTKON",reg_stat2$reg_var) & grepl("ARTDIS",reg_stat2$reg_var),"status"] <- "ALL"
reg_stat2[grepl("ARTKON",reg_stat2$reg_var) & grepl("DTODIS",reg_stat2$reg_var) & is.na(reg_stat2$status),"status"] <- "KON-DTODIS"
reg_stat2[grepl("ARTDIS",reg_stat2$reg_var) & grepl("DTOKON",reg_stat2$reg_var) & is.na(reg_stat2$status),"status"] <- "DIS-DTOKON"


reg_stat2[is.na(reg_stat2$status),"status"] <- reg_stat2[is.na(reg_stat2$status),"reg_var"]

 
tjek_reg <- merge(qtrsample, 
                  unique(reg_stat2[,c("station","status","remark")]), all.x=TRUE)
tjek_reg[is.na(tjek_reg$status),"status"] <- "NON"


tjek_reg[tjek_reg$status=="NON" & tjek_reg$catchRegistration!="NON" & tjek_reg$speciesRegistration!="NON" &
           !is.na(tjek_reg$catchRegistration) & !is.na(tjek_reg$speciesRegistration),"tjek"] <- "Kode 1"
tjek_reg[tjek_reg$catchRegistration=="ALL" & tjek_reg$speciesRegistration=="ALL" &
         tjek_reg$status %in% c("KON-DTODIS","DIS-DTOKON") &
           !is.na(tjek_reg$catchRegistration) & !is.na(tjek_reg$speciesRegistration),"tjek"] <- "Kode 2"
tjek_reg[is.na(tjek_reg$catchRegistration) & is.na(tjek_reg$speciesRegistration),"tjek"] <- "Kode 3"

reg_tjek_out <- tjek_reg[!is.na(tjek_reg$tjek),c("trip","station","catchRegistration","speciesRegistration","tjek", "remark")]
reg_tjek_out <- reg_tjek_out[order(reg_tjek_out$tjek,reg_tjek_out$trip,reg_tjek_out$station),] 

reg_tjek_out$station <- as.character(reg_tjek_out$station)
reg_tjek_out$trip <- as.character(reg_tjek_out$trip)

colnames(reg_tjek_out) <- c("\\bf Tur", "\\bf Station", "\\bf Prøvetag- ning", "\\bf Oparbejdning af arter", "\\bf Tjek", "\\ Bemærkning")

##################################################


}
 
if (nrow(reg_tjek_out)>0) {

library(Hmisc)
     mylatex(reg_tjek_out,file='',booktabs =T,rowlabel="",rowname="",where='H', collabel.just=c("l","l","p{0.8in}","p{1in}","p{0.8in}","p{1in}"),
             col.just=c("l","l","l","l","l","l"),longtable= TRUE, lines.page=5000)
detach(package:Hmisc)
     
  
}


```

```{r registration2, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H'}
qtrString <- printQtr(sprintf("AND s.quarterGearStart = %s",quarter),
                      "")

sample_errorsQ<-sprintf("SELECT s.sampleId, s.tripId, s.year, s.cruise, s.trip, s.tripType, s.station, s.gearQuality, s.dfuArea, s.catchRegistration, s.speciesRegistration, s.remark as stationRemark, t.remark as tripRemark, s.gearQuality
               FROM  Sample as s
			   left join trip as t
			   on (s.year=t.year and
			   s.trip=t.trip)
               WHERE (s.year = %s) %s AND (s.cruise = '%s')",year,qtrString,cruise)
slQ<-sprintf("SELECT distinct s.sampleId, s.landingCategory, 1 as no
           FROM  SpeciesList s 
           WHERE (s.year = %s ) %s AND (s.cruise = '%s') and s.speciesCode<>'DTO'",
           year,qtrString,cruise)

#Importing data
channel <- odbcConnect("FishLineDW")
sample_errors <- sqlQuery(channel, paste(sample_errorsQ),stringsAsFactors=F)
sl <- sqlQuery(channel, paste(slQ),stringsAsFactors=F)
close(channel)

# unique(sample_errors$cruise)

sample_errors1<-subset(sample_errors, cruise %in% c("SEAS","MON","REF-Tunge"))

sl1<-aggregate(no~sampleId+landingCategory, data=sl, function(x) length(x))
sl2<-dcast(sampleId~landingCategory, data=sl1, value.var="no")

for (lc in c("BMS","DIS","KON","IND","LSC","SLP","SÆL")){
  if(!lc %in% names(sl2)){
    sl2[[lc]]<-0
  }
}

comment2 <- function(df,comment){
  if (nrow(df)>0){
    return(cbind(df,comment))
    }
}

# type2 <- function(df,type){
#   if (!is.null(df))
# }

sl2[is.na(sl2)]<-0
# sl2$sum<- sl2$DIS+sl2$IND+sl2$KON+sl2$SLP

sl2$sum <- base::rowSums(sl2[,2:ncol(sl2)])

sample_errors2<-merge(sample_errors1, sl2, all.x=T)

lan<-subset(sample_errors2, catchRegistration=="LAN" & sum!=1 & (DIS!=0 | SLP!=0))
lan<-comment2(lan,"Prøvetagningsniveau=LAN, men der er oplsyninger om DIS og/eller SLP på artslisten")
if(!is.null(lan)){lan$type <- "lan"}
dis<-subset(sample_errors2, catchRegistration=="DIS" & sum!=1 & (KON!=0 | IND!=0) )
dis<-comment2(dis,"Prøvetagningsniveau=DIS, men der er oplsyninger om KON og/eller IND på artslisten")
if(!is.null(dis)){dis$type <- "dis"}
non<-subset(sample_errors2, catchRegistration=="NON" & sum>0)
non<-comment2(non,"Prøvetagningsniveau=NON (ingen), men der er oplsyninger på artslisten")
if(!is.null(non)){non$type <- "non"}


fejl<-rbind(lan, dis, non)


slp<-subset(sample_errors2, SLP==1)
slp<-comment2(slp,"Der er oplysning om SLP på artslisten - er det korrekt?")
if(!is.null(slp)){slp$type <- "slp"}
ind<-subset(sample_errors2, IND==1)
ind<-comment2(ind,"Der er oplysning om IND på artslisten - er det korrekt?")
if(!is.null(ind)){ind$type <- "ind"}
bms<-subset(sample_errors2, BMS==1)
bms<-comment2(bms,"Der er oplysning om BMS på artslisten - er det korrekt?")
if(!is.null(bms)){bms$type <- "bms"}
allAll<-subset(sample_errors2, catchRegistration=="ALL" & speciesRegistration=="ALL" & sum<2 & DIS==0)
allAll <- comment2(allAll,"Var der 0 discard eller blev discarden ikke oparbejdet?")
if(!is.null(allAll)){allAll$type <- "allAll"}

question<-rbind(allAll, slp, ind, bms)

fq <- rbind(fejl,question)

```
<!-- \subsection{Fejl} -->

```{r errors, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H'}
types0 <- 
  data.frame(type = c(rep("Fejl",3),rep("Spørgsmål",4)),
             kode = c("dis","lan","non","allAll","slp","ind","bms"),
             overskrift = c("Discard registreret",
                           "Landede fisk registreret",
                           "Intet af fangsten er registreret",
                           "Alt prøvetaget, alt oparbejdet",
                            "SLP i artslisten",
                           "Industrifisk i artslisten",
                           "BMS i artslisten"),
             beskedVedtom = c("Ingen stationer med registreret discard har givet fejl i rapportens kontrol. ",
                              "Ingen stationer med landet fangst registreret har givet fejl i rapportens kontrol. ",
                              "Ingen stationer med uden prøvetagning har givet fejl i rapportens kontrol. ",
                              "Ingen stationer med alt registreret har givet fejl i rapportens kontrol. ",
                              "Ingen stationer med SLP i artslisten har givet fejl i rapportens kontrol. ",
                              "Ingen stationer med industrifisk i artslisten har givet fejl i rapportens kontrol. ",
                              "Ingen stationer med BMS i artslisten har givet fejl i rapportens kontrol. "),
             stringsAsFactors = F)

for (i in unique(types0$type)){
  
  cat(sprintf("\\subsection{%s} ",i))

  types <- types0[types0$type==i,]
  
  for (type in 1:nrow(types)){
    
    q <- fq[fq$type == types$kode[type],]
    cat(sprintf("\\subsubsection{%s} ",types$overskrift[type]))
    
    if (is.data.frame(q) && nrow(q)>0){
       # if(nrow(q)>0){
      # if (nrow(question)>0 ) {
      cat(as.character(q[1,(ncol(q)-1)]))
      # question2 <-   spm[,c(6,8,11,12,1)]
      q2 <-   q[,c(5,7,10,11,13,12)]
      q2[is.na(q2)]<-" "
      colnames(q2)<- c("\\bf Tur", "\\bf Station",
                      "\\bf Prøve-tagnings-niveau", "\\bf Oparbejd-ning af arter",
                      "\\bf Bemærkning til tur","\\bf Bemærkning til station")
      
      library(Hmisc)
      mylatex(q2,file='',booktabs =T,rowlabel="",rowname="",where='H',
              collabel.just=c(rep("l",2),"p{1cm}","p{1cm}","p{4cm}","p{4cm}"),
              col.just=c(rep("l",2),"p{1cm}","p{1cm}","p{4cm}","p{4cm}"),
              longtable= TRUE, lines.page=5000)
      detach(package:Hmisc)
      } else{
        cat(types$beskedVedtom[type])}
    # } else{
    #     cat(types$beskedVedtom[type])
      }
}
```






\pagebreak

\section{Tjek af artslisten}

I tabellen nedenfor er for hver oparbejdet station angivet den indtastede totalvægt og en udregnet totalvægt.
Den udregnede totalvægt er fundet ved at summere alle trin-0 vægte.
Er der stor forskel mellem vægtene, eller kan vægten ikke udregnes, vil det være beskrevet i bemærkningen.




\vspace{0.2cm}


```{r data_out, results='asis',echo=FALSE,message=FALSE,warning=FALSE,fig.pos='H'}

#Summarise each weight step per station, speciescode and landing category
if (quarter<5){
  splqtr <- speciesList[speciesList$qtr==quarter,]
} else{
  splqtr <- speciesList
}

test2 <- ddply(splqtr,
               .(station,speciesCode,landingCategory),
               summarise,
               weightStep0=sumNA(weightStep0),
               weightStep1=sumNA(weightStep1),
               weightStep2=sumNA(weightStep2),
               weightStep3=sumNA(weightStep3),
               weightAll=sumNA(weightStep0)+
                 sumNA(weightStep1)+
                 sumNA(weightStep2)+
                 sumNA(weightStep3))
#Get name of columns with the lowest value -> lowest weightstep
test2b <- test2[test2$weightAll!=0,]
test2b[test2b==0] <- NA
test2b$weightAll <- NULL
test2b$trin <- colnames(test2b)[apply(test2b,1,which.min)]


speciesList$weightAll <- rowSums(speciesList[,c("weightStep0", "weightStep1","weightStep2","weightStep3")], na.rm=TRUE)
# speciesList_a <- speciesList[speciesList$weightAll!=0 & speciesList$qtr==quarter,]
# speciesList_b <- speciesList[speciesList$weightAll==0 & speciesList$qtr==quarter,] #need to add these rows to output
if (quarter<5){
  speciesList_a <- speciesList[speciesList$weightAll!=0 & speciesList$qtr==quarter,]
  speciesList_b <- speciesList[speciesList$weightAll==0 & speciesList$qtr==quarter,]
} else{
  speciesList_a <- speciesList[speciesList$weightAll!=0,]
  speciesList_b <- speciesList[speciesList$weightAll==0,]
}

#Megre lowest weight step with data and get
data1t <- merge(speciesList_a, test2b[,c("station","speciesCode","landingCategory","trin")])
data1t$weight_val <- colnames(data1t[,c("weightStep0","weightStep1","weightStep2","weightStep3")])[apply(
  data1t[,c("weightStep0","weightStep1","weightStep2","weightStep3")],1,which.min)]

for (i in 1:nrow(data1t)) {
    data1t$tjek[i] <- 
      is.na(dplyr::select(data1t[i,],contains(data1t$trin[i]))) &
      is.na(data1t$raisingFactor[i]) &
      data1t$trin[i]==data1t$weight_val[i]
}

statError <- unique(data1t[data1t$tjek == "TRUE",c("trip","station","totalWeight","treatmentFactor")])

data <- printQtr(speciesList_a[!(speciesList_a$station %in% 
                                   unique(statError$station)) &
                        speciesList_a$qtr == quarter,],
                 speciesList_a[!(speciesList_a$station %in% 
                                   unique(statError$station)),])

if (nrow(data)>0) {

data[!is.na(data$treatmentFactor),"weight"] <-
    data[!is.na(data$treatmentFactor),]$weightStep0*data[!is.na(data$treatmentFactor),]$treatmentFactor

data[is.na(data$treatmentFactor),"weight"] <-
  data[is.na(data$treatmentFactor),]$weightStep0

#data[data$inc=="yes" & !is.na(data$inc),"weight"] <- data[data$inc=="yes"  & !is.na(data$inc),]$weightStep0

data2 <- ddply(data, .(trip,station,totalWeight),summarize, totCalc=round(sum(weight,na.rm=TRUE),2))

if (any(!is.na(data2$trip))) {

    data2$difWeight <- round(data2$totalWeight-data2$totCalc,2)
    data2$difProc <- round2(data2$difWeight/data2$totalWeight*100)

    #data2[data2$difProc<15 & !is.na(data2$difProc),"remark"] <- "Vægte ok"
    data2[is.na(data2$difProc),"remark"] <- "\\color{red} Ingen totalvægt indtastet"
    data2[data2$difProc>=15 & !is.na(data2$difProc),"remark"] <- "\\color{red} Stor forskel i indtastet og udregnet totalvægt"

    data3 <- rbind(data2[!is.na(data2$remark),],cbind(statError,totCalc=rep(NA,nrow(statError)),
                                                      difWeight=rep(NA,nrow(statError)),difProc=rep(NA,nrow(statError)),
                                                      remark=rep("\\color{red} DTO mangler eller andet problem!",nrow(statError) )))

}
} else if (nrow(statError)>0 & nrow(data)==0) {
  data3 <- cbind(statError,totCalc=rep(NA,nrow(statError)),difWeight=rep(NA,nrow(statError)),difProc=rep(NA,nrow(statError)),
  remark="\\color{red} DTO mangler eller andet problem!" )

}

if (exists("data3")>0) {

data3$trip <- as.character(data3$trip)
data3$station <- as.character(data3$station)
data3$totalWeight <- as.character(data3$totalWeight)
data3$totCalc <- as.character(data3$totCalc)
data3$difProc <- as.character(data3$difProc)
data3$difWeight <- NULL

data3 <- data3[order(data3$trip,data3$station),]

colnames(data3) <- c("\\bf Tur","\\bf Station","\\bf Totalvægt (Indtastet)","\\bf Totalvægt (Beregnet)", "\\bf Forskel %","\\bf Bemærkning")


if (nrow(data3)>0){

library(Hmisc)
     mylatex(data3,file='',booktabs =T,rowlabel="",rowname="",where='H', collabel.just=c("l","l","p{0.8in}","p{0.8in}","p{0.5in}","l"),
             col.just=c("l","l","l","l","l","p{2in}"),longtable= TRUE, lines.page=5000)
detach(package:Hmisc)

}
tx_weight <- ""

} else {
  tx_weight <- "\\bf Alle vægte er ok!"


}



```


\vspace{0.5cm}

`r tx_weight`


\section{Individfisk}

\subsection{Længde-vægt forhold}

I graferne nedenfor er plottet længde-vægt forhold for alle individfisk fra turene. I rød er markeret individer indsamler i det valgte år, kvartal og togt, mens individer i blå er taget fra den øvrige database, samme kvartal og togt, men fra de seneste fem år. Ved nogle stationer står også stationsnummeret, hvilket gælder for stationer, der afviger fra det typiske længde-vægt forhold. Da dette udregnes automatisk, kan det dog godt forekomme at individer med helt fine længde-vægt forhold betragtes som outliers. \

I den efterfølgende tabel er listet de individer, hvor der forekommer at være en stor afvigelse mellem disse og den øvrige database i længde-vægt-forholdet. De listedet er arter er markeret med statiosnnumre i plottene overnfor.\





```{r ,echo=FALSE,include=FALSE, cache=FALSE}


animal_ind <- animal[animal$qtr==quarter & animal$individNum>0 & !is.na(animal$individNum),
                     c("trip","station","speciesCode","dfuArea","landingCategory","length","weight")]
animal_ind <- animal %>%
  dplyr::filter(individNum>0 & !is.na(individNum)) %>%
  dplyr::filter(if (quarter<5) qtr==quarter else !is.na(quarter)) %>%
  dplyr::select(trip,station,speciesCode,dfuArea,landingCategory,length,weight)

#animal_ind$log_length <- log(animal_ind$length)
#animal_ind$log_weight <- log(animal_ind$weight)

#animal_ind2 <- animal_ind[complete.cases(animal_ind[,c("log_length","log_weight")]) & animal_ind$weight!=0,]



#plot(cooksd, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
#abline(h = 4*mean(cooksd, na.rm=T), col="red")  # add cutoff line
#text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4*mean(cooksd, na.rm=T),names(cooksd),""), col="red")  # add labels


#################################################################

spec_ind <- as.character(unique(animal_ind[!is.na(animal_ind$weight) & !is.na(animal_ind$length),]$speciesCode))
specCodes <- paste(spec_ind,collapse = "','")
year_min <- year - 4
if (quarter<5){
  quarterString <- sprintf(" Animal.quarterGearStart = (%s) AND ",quarter)
} else{quarterString <- ""}


channel <- odbcConnect("FishLineDW")
db_dat_ind <- sqlQuery(channel,
                       sprintf("SELECT     Animal.year, Animal.trip, Animal.station,
                                                  Animal.speciesCode,Animal.landingCategory, Animal.individNum,Animal.length,
                                                  (Animal.weight/Animal.number)*1000 AS weight
                                       FROM       Animal
                                       WHERE      Animal.year BETWEEN (%s) AND (%s) AND
                                                  Animal.speciesCode IN ('%s') AND
                                                  Animal.cruise =  ('%s')  AND
                                                  Animal.individNum > 0 AND
                                                  %s
                                                  Animal.length IS NOT NULL AND Animal.weight IS NOT NULL "
                               , year_min, year,specCodes,
                               cruise,quarterString),stringsAsFactors=FALSE)
close(channel)


db_dat_ind$log_length <- log(db_dat_ind$length)
db_dat_ind$log_weight <- log(db_dat_ind$weight)

```



\newpage

\renewcommand{\arraystretch}{1}



```{r ,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=8}

db_diff <- db_dat_ind[0,c(1:8)]


for (i in sort(spec_ind)) {
   # dat_spec <- animal_ind2[animal_ind2$speciesCode==i,]
    db_spec <- db_dat_ind[db_dat_ind$speciesCode==i &
                            db_dat_ind$weight!=0 &
                            db_dat_ind$length!=0 &
                            !is.na(db_dat_ind$weight) &
                            !is.na(db_dat_ind$length),]

    db_spec$cooksd <- cooks.distance(lm(log_length ~ log_weight, data=db_spec))

    db_spec[is.nan(db_spec$cooksd),"cooksd"] <- 1

    db_spec_y <- db_spec[db_spec$year==year,]
     
    lim <- ifelse(nrow(db_spec_y) < 10,
             nrow(db_spec_y),
             ifelse(nrow(db_spec_y) < 100, 5,10))
     
     
      db_spec_y[db_spec_y$cooksd >= 
                  db_spec_y$cooksd[order(db_spec_y$cooksd, decreasing=TRUE)][lim] ,"diffId"] <-
        1:nrow(db_spec_y[ db_spec_y$cooksd >= db_spec_y$cooksd[order(db_spec_y$cooksd, decreasing=TRUE)][lim] ,])
     
      db_spec2 <- db_spec[db_spec$year!=year,] 
      db_spec3 <- dplyr::bind_rows(db_spec_y,db_spec2)

      titleString <- printQtr(sprintf(" Art: %s - Kvartal: %s",i,quarter),
                              sprintf(" Art: %s - År: %s",i,year))
        

    p_individ <- ggplot(data=db_spec3, aes(x=length, y=weight, label=station)) +
      geom_point(data=db_spec3,aes(color="all"),pch=18,size=5)+
      geom_point(data=db_spec3[db_spec3$year==year,],
                 aes(color="qtr"),pch=18,size=5)+
      geom_label_repel(data=db_spec3[db_spec3$year==year,],
                       aes(label=as.character(diffId)),
                      force=10,size=7,seed = 42)+
      theme_minimal(base_size = 18)+
      labs(x = "Længde (mm)", y="Vægt (g)", title=titleString)+
      theme(axis.title.y = element_text(vjust = 2),
            axis.title.x = element_text(vjust = -1),
            axis.line = element_line(colour = "black"),
            legend.title = element_text(size = 12, face = 'bold'),
            plot.title = element_text(face="bold"))+
      theme(plot.title = element_text(margin = margin(t = 10, b = -25)))+
      theme(panel.grid.major = element_line(colour="grey", size=0.5),
            panel.grid.major.x = element_blank())+#,
      theme(legend.position="right")+
      scale_x_continuous(limits = c(0,(max(db_spec3$length)+10)))+
      scale_y_continuous(limits = c(0,(max(db_spec3$weight)+10)))+
      scale_color_manual(values=c("cadetblue3","red"),
                         name="",labels=c("Øvrig database","Valgt kvartal og år"))+
      theme(plot.margin=unit(c(0.5,0,0.5,0.5), "cm"))


      plot(p_individ)
      
      temp <- db_spec3[!is.na(db_spec3$diff),c(1:4,12,5:8)]
      if (!is.null(temp)){
        db_diff <- rbind(db_diff,temp)
      }

}


if (nrow(db_diff)>0) {

      db_diff <- db_diff[order(db_diff$speciesCode,
                               db_diff$year,
                               db_diff$trip,
                               db_diff$station,
                               db_diff$landingCategory,
                               db_diff$individNum),]

      colnames(db_diff) <- c("\\bf År", "\\bf Tur","\\bf Station","\\bf Art","\\bf Plot ID","\\bf Landings- kategori",
                             "\\bf individ- nummer","\\bf Længde (mm)","\\bf Vægt (g)")

      library(Hmisc)
      mylatex(db_diff,file='',booktabs =T,rowlabel="",rowname="",longtable= TRUE,
              collabel.just=c("l","l","l","p{0.3in}","p{0.4in}","p{0.6in}","p{0.6in}","p{0.4in}","p{0.4in}"), lines.page=5000)
      detach(package:Hmisc)


}

```



\newpage{}
\subsection{Længe-alder forhold}

I de følgende grafer er plottet længde-alder-forhold for alle individfisk fra turene. Rød markerer data for indsamlede arter i det valgte år. Blå angiver data for samme arter de foregående 5 år.

```{r age, include=FALSE, cache=FALSE}

################### Collecting data from Fishline #############################

# query <- paste(
#   "SELECT    animalID, year, cruise, trip,station,
#   speciesCode, dfuArea, number, length,
#   age, landingCategory, individNum,
#   representative, quarterGearStart as qtr,
#   sizeSortingEU
#   FROM      Age
#   WHERE     year = (",
#   year,
#   ") AND
#   cruise = ('",
#   cruise,
#   "') ",
#   sep = ""
#   )
#
#   message(query)
#
#   channel <- odbcConnect("FishLineDW")
#   # Age
#   age <- sqlQuery(channel, query, stringsAsFactors = FALSE)
#   close(channel)
#
```

```{r ,echo=FALSE,include=FALSE, cache=FALSE}

# Cheach length-age relation -----------------------------------------------

# age_ind <- age[,c("year","trip","station","speciesCode","dfuArea",
#                        "landingCategory","length","age")]
#
# age_ind2 <- filter(age_ind, length >= 0 & age >= 0)
# age_ind[complete.cases(age_ind[,c("length","age")]),]


###############################################################################

# retrieve data for the last five years

spec_ind <- as.character(unique(animal$speciesCode))
message(spec_ind)
year_min <- year - 4

five_year_query <- sprintf("SELECT [year],[cruise],[trip],[station],[quarterGearStart] as qtr,[speciesCode],[landingCategory],[individNum],[number],[length],[age]
  FROM [FishLineDW].[dbo].[Age]
WHERE year BETWEEN (%s) AND (%s)
AND speciesCode IN ('%s')
AND cruise =  ('%s')
--AND individNum > 0 
%s 
AND length IS NOT NULL
AND age IS NOT NULL",year_min,year,paste(spec_ind,collapse = "','"),
                      cruise,printQtr(sprintf("AND quarterGearStart = %s",quarter),""))

message(five_year_query)
channel <- odbcConnect("FishLineDW")
db_dat_ind <- sqlQuery(channel, five_year_query, stringsAsFactors=FALSE)
close(channel)

db_dat_ind$log_length <- log(db_dat_ind$length)
db_dat_ind$log_age <- log(db_dat_ind$age)

for (i in 1:nrow(db_dat_ind)){
  db_dat_ind$qtr[i] <- printQtr(db_dat_ind$qtr[i],5)
}


with_individNum <- db_dat_ind %>% filter(individNum>0)
no_individNum <- db_dat_ind %>% filter(individNum==0 | is.na(individNum))

spec_AL <- as.character(unique(db_dat_ind$speciesCode))
```


\renewcommand{\arraystretch}{1}

```{r ,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=8}
# library(plyr)
# Plot length - age relations ----------------------------------------------


# cat("\\subsubsection{Fisk med indvividnummer}")
cat("I de følgende grafer kan man se forholdet mellem længder og aldre på registrerede fisk i det valgte kvartal/år. Med blå vises fisk fra de seneste 5 år, med rød fisk fra det valgte kvartal/år. Figurerne omkring punkterne illustrerer antallet af fisk i en bestemt alder på de enkelte punkter. Da der er tale om forskellige antal fisk når et kvartal sammenlignes med et kvartal eller år, er figurerne tykkest, der hvor der er flest fisk på et alders- og længdetrin i enten databasen eller det valgte kvartal/år. Outliers findes i den samlede datamængde, men kun outliers fra det valgte kvartal/år fremhæves. \\newline ")
# length_age <- function(dataset, include_individNum = TRUE){
        # Takes two arguments,
        # Dataset is a data frame generated by an SQL request
        # include_indicidNum defaults to TRUE which includes the value individNum in the table.
        #   Using FALSE as second argument will remove the value individNum from the output table.

if (nrow(with_individNum[with_individNum$year==year &
                         with_individNum$qtr==quarter,])>0){
    dataset <- with_individNum
        # Pre define data set of outliers
        db_diff <- dataset[0,c(1:8)]
        db_diff$diffId = numeric()

        # dataset
      dataset[dataset$year==year,"year_group"] <- printQtr("Valgt kvartal og år",
                                                           "Valgt år")
      dataset[dataset$year!=year,"year_group"] <- printQtr("Øvrig database",
                                                           "Øvrig database")

        #Loop through each species and plot
        for (i in sort(spec_AL)) {
            db_spec0 <- dataset[dataset$speciesCode==i,]
            
            # db_spec1 <- db_spec0[db_spec0$year==year,]
            # db_spec_db <- db_spec0[db_spec0$year!=year,]
            
            
            # x = 1
            # counter <- function(x){x <<- x + 1}
            # # creates data for plotting outliers in custom colours
             db_spec1 <- db_spec0 %>% 
               dplyr::group_by(age) %>% 
               dplyr::mutate(Q1 = quantile(length, 0.25),
                              median = quantile(length, 0.5),
                              Q3 = quantile(length, 0.75),
                              IQR = Q3-Q1,
                              upper.limit = Q3+1.5*IQR,
                              lower.limit = Q1-1.5*IQR,
                              outlier =
                                as.numeric(ifelse(test = (length<lower.limit | length > upper.limit),
                                                  yes = row_number(), no = NA ))) %>% 
               dplyr::arrange(outlier)
           
             
               db_spec2 <- db_spec1 %>% 
                 dplyr::filter(year_group!="Øvrig database") %>% 
                 dplyr::mutate(outlier=as.numeric(ifelse(is.na(outlier),NA,row_number())))
             
               if (nrow(db_spec2)>0){    
               db_spec_db <- db_spec1 %>% 
                 dplyr::filter(year_group=="Øvrig database") %>% 
                 dplyr::mutate(outlier=NA)
               
               db_spec3 <- dplyr::bind_rows(db_spec_db,db_spec2)  
               
               titleString<- printQtr(sprintf(" Art: %s - Kvartal: %s",i,quarter),
                                      sprintf(" Art: %s - År: %s", i, year))
               
               p_ind <- ggplot(data=db_spec3, 
                               aes(x=factor(age,
                                            levels = c(0:(max(db_spec3$age,na.rm=T)+1))),
                                            y=length, label=outlier))
               
                 if (nrow(db_spec3[db_spec3$year_group=="Øvrig database",])>0){
                 p_ind <- p_ind +
                   geom_violin(data = db_spec3[db_spec3$year_group=="Øvrig database",],
                             aes(fill="all"),alpha=.2,scale="width")
                 }
                if (nrow(db_spec3[db_spec3$year_group!="Øvrig database",])>0){
                 p_ind <- p_ind +
                   geom_violin(data = db_spec3[db_spec3$year_group!="Øvrig database",],
                             aes(fill ="qtr"),alpha=.2,scale="width")
                }
                 
                if (nrow(db_spec3[db_spec3$year_group=="Øvrig database",])>0){
                 p_ind <- p_ind +
                  geom_point(data=db_spec3[db_spec3$year_group=="Øvrig database",],
                             aes(col="all"),pch=18,size=5)
                   }
                 if (nrow(db_spec3[db_spec3$year_group!="Øvrig database",])>0){
                 p_ind <- p_ind +
                  geom_point(data=db_spec3[db_spec3$year_group!="Øvrig database",],
                             aes(col="qtr"),pch=18,size=5)
                 }
                 
                 if (nrow(db_spec3[db_spec3$year_group!="Øvrig database",])>0){
                 p_ind <- p_ind +
                  geom_label_repel(aes(label=as.character(outlier)),
                                   force=10,size=7,seed = 42,fill="white")
                 }
                 
               p_ind <- p_ind +
                  theme_minimal(base_size = 18)+
                  labs(y = "Længde (mm)", x="Alder (år)", title=titleString)+
                  scale_color_manual(values=c("all"="cadetblue3","qtr"="red"), 
                                     name = "",
                                     labels=c("Øvrig database","Valgt kvartal og år"))+
                  scale_fill_manual(values=c("all"="cadetblue3","qtr"="red"), 
                                     name = "",
                                     labels=c("Øvrig database","Valgt kvartal og år"))+
                 scale_x_discrete(drop=F)+
                  theme(axis.title.y = element_text(vjust = 2),
                        axis.title.x = element_text(vjust = -1),
                        axis.line = element_line(colour = "black"),
                        legend.title =element_blank(),
                        legend.position="right",
                        plot.title = element_text(face="bold",margin = margin(t = 10, b = -25)),
                        panel.grid.major = element_line(colour="grey", size=0.5),
                        panel.grid.major.x = element_blank(),
                        plot.margin=unit(c(0.5,0,0.5,0.5), "cm"))+
                    coord_flip()
      
      
      
                    plot(p_ind)

              # Make table of outliers


              # if (include_individNum==TRUE & any(!is.na(db_spec3$outlier))){
                if (any(!is.na(db_spec3$outlier))){
              db_diff <- rbind(db_diff,
                               data.frame(db_spec3[!is.na(db_spec3$outlier),
                                               c("year", "trip", "station", "speciesCode",
                                                 "outlier", "landingCategory", "individNum",
                                                 "length", "age")]))
              # } else if(include_individNum!=TRUE & any(!is.na(db_spec3$outlier))){
              #     db_diff <- rbind(db_diff,db_spec3[!is.na(db_spec3$outlier),
              #                                  c("year", "trip", "station", "speciesCode",
              #                                    "outlier", "landingCategory",
              #                                    "length", "age")])
              }
        }
        }

        if (nrow(db_diff)>0) {

              # Output table of outliers

              cat("\\newpage")

              db_diff <- db_diff[order(db_diff$speciesCode,db_diff$outlier),]

              library(Hmisc)

              # if (include_individNum==TRUE){
              colnames(db_diff) <- c("\\bf År", "\\bf Tur","\\bf Station",
                                     "\\bf Art","\\bf Plot ID",
                                     "\\bf Landings- kategori",
                                     "\\bf individ- nummer","\\bf Længde (mm)",
                                     "\\bf Alder (år)")


              mylatex(db_diff,file='',booktabs =T,rowlabel="",rowname="",
                      longtable= TRUE,
                      collabel.just=c("l","l","l","l","l","p{0.6in}",
                                      "p{0.6in}","p{0.4in}","p{0.4in}"),
                      lines.page=5000)


              # } else if(include_individNum!=TRUE){
              #     colnames(db_diff) <- c("\\bf År", "\\bf Tur","\\bf Station",
              #                            "\\bf Art","\\bf Plot ID",
              #                            "\\bf Landings- kategori",
              #                            "\\bf Længde (mm)","\\bf Alder (år)")
              # 
              # 
              # mylatex(db_diff,file='',booktabs =T,rowlabel="",rowname="",
              #         longtable= TRUE,
              #         collabel.just=c("l","l","l","l","l","p{0.6in}",
              #                         "p{0.4in}","p{0.4in}"),
              #         lines.page=5000)

              }
              detach(package:Hmisc)



        } else{cat(sprintf("\\newline Der er ikke aflæst arter fra %s i %s %s endnu. ",
                   cruise,printQtr(sprintf("%s. kvartal",quarter),""),year))}


    # length_age(with_individNum)

                          
# }
# if (nrow(no_individNum)>0){
#     cat("\\subsubsection{Fisk uden indvividnummer}")
#     cat("I grafen nedenfor ses indsamlet data for fisk der ikke har et individnummer i FiskeLine, f.eks. tobis. Grunden til det mangelende individnummer er at alderen er indtastet under LAV. Rød angiver data for arter indsamlet i år. Blå angiver indsamlet data for disse arter for de seneste 5 år. I den efterfølgende tabel er de fremhævede outliers i plottene angivet. Outliers er i disse plots datapunkter udenfor IQR.\\newline{}")
#     length_age(no_individNum,FALSE)
# }
```

\newpage

\part{Status på indsamlet data i `r year`}

\section{Antal ture per område}

```{r, include = FALSE}

trip_area <- ddply(unique(sample[,c("trip","dfuArea","qtr")]), .(dfuArea,qtr),
                   summarise, numTrip=sum(!is.na(trip)))

```


Der er blevet udført `r nrow(trip)` i løbet af `r year`. Grafen og tabellen nedenfor viser hvor mange ture,
der har været per område per kvartal i `r year`.
Hvis en tur er foregået i flere områder, bliver hvert område talt som én tur, når antallet af ture fordeles per kvartal og område.
Regner man på denne måde, har der været `r sum(trip_area$numTrip)` i løbet af året.
I tabellen er også vist det totale antal ture per område for hele `r year`.

\renewcommand{\arraystretch}{1}
\renewcommand{\tabcolsep}{15pt}


```{r ,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6.8}


bp<- ggplot(trip_area, aes(x=factor(dfuArea), y=as.integer(numTrip), fill=factor(qtr)))+
  geom_bar(width = 0.7, stat = "identity",position='dodge')+ theme_minimal(base_size = 16)+
    theme(panel.grid.major.x=element_blank(),axis.title.y = element_text(margin = margin(l = 0, r = 15)))+
    labs(x = "Område", y="Antal ture")+ guides(fill=guide_legend(title="Kvartal"))+
    scale_y_continuous(breaks=seq(from = 2, to = max(trip_area$numTrip)+1, by = 2)) +scale_fill_brewer(palette="Dark2")

plot(bp)

#trip_area$numTrip <- as.character(trip_area$numTrip)
trip_area$qtr <- as.character(trip_area$qtr)
trip_area_tab <- reshape(trip_area, idvar = "qtr", timevar = "dfuArea", direction = "wide")

trip_area_tabA <- rbind(trip_area_tab, c("Total",colSums(trip_area_tab[-1],na.rm = TRUE)))

colnames(trip_area_tabA) <- gsub( "numTrip.",  "", names(trip_area_tab), fixed = TRUE)
colnames(trip_area_tabA)[1] <- c("\\bf Periode")


```



```{r,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE}


library(Hmisc)
mylatex(trip_area_tabA,file='',booktabs =T,rowlabel="",rowname="",longtable= TRUE,
        cgroup = c("", "Område"),n.cgroup = c(1, ncol(trip_area_tab)-1),rgroup=c("Kvartal","I alt"),
        n.rgroup=c(nrow(trip_area_tabA)-1,1), center='centering', lines.page=5000 )
detach(package:Hmisc)



```


\newpage

\section{Antal ture per discardsejler}


```{r, include = FALSE}

trip_ini <- merge(trip,person,by.x="tripLeaderId",by.y="dfuPersonId",all.x=TRUE)

trip_person <- ddply(trip_ini, .(initials,qtr), summarise, numTrip=sum(!is.na(trip)))
trip_person$initials <- toupper(trip_person$initials)

```




```{r ,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6.8}


bp<- ggplot(trip_person, aes(x=factor(initials), y=as.integer(numTrip), fill=factor(qtr)))+
  geom_bar(width = 0.7, stat = "identity",position='dodge')+ theme_minimal(base_size = 16)+
    theme(panel.grid.major.x=element_blank(),axis.title.y = element_text(margin = margin(l = 0, r = 15)))+
      labs(x = "Person", y="Antal ture")+ guides(fill=guide_legend(title="Kvartal"))+
    scale_y_continuous(breaks=seq(from = 2, to = max(trip_person$numTrip)+1, by = 2)) +scale_fill_brewer(palette="Dark2"
)

plot(bp)

#trip_area$numTrip <- as.character(trip_area$numTrip)
trip_person$qtr <- as.character(trip_person$qtr)
trip_person_tab <- reshape(trip_person, idvar = "qtr", timevar = "initials", direction = "wide")

trip_person_tabA <- rbind(trip_person_tab, c("Total",colSums(trip_person_tab[-1],na.rm = TRUE)))

colnames(trip_person_tabA) <- gsub( "numTrip.",  "", names(trip_person_tab), fixed = TRUE)
colnames(trip_person_tabA)[1] <- c("\\bf Periode")


```


\renewcommand{\tabcolsep}{10pt}


```{r,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE}


library(Hmisc)
mylatex(trip_person_tabA,file='',booktabs =T,rowlabel="",rowname="",longtable= TRUE,
        cgroup = c("", "Person"),n.cgroup = c(1, ncol(trip_person_tab)-1),rgroup=c("Kvartal","I alt"),
        n.rgroup=c(nrow(trip_person_tabA)-1,1), center='centering', lines.page=5000)
detach(package:Hmisc)



```


\newpage

\section{Enkeltfisk}


```{r, include = FALSE}

animal_inda <- ddply(animal[animal$individNum>0 & !is.na(animal$individNum),],
                    .(speciesCode,qtr,dfuArea, landingCategory), summarise, numInd=sumNA(number))

animal_inda[is.na(animal_inda$dfuArea),"dfuArea"] <- "-"
```



\renewcommand{\tabcolsep}{5pt}
\renewcommand{\arraystretch}{0.8}

```{r ,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=7.5}

animal_ind1 <- reshape(animal_inda[animal_inda$qtr==1,-2], idvar = c("speciesCode","dfuArea"), timevar = c("landingCategory"), direction = "wide")
animal_ind1$dfuArea.KON <- NULL
animal_ind1$TOT <- rowSums(animal_ind1[-c(1:2)],na.rm = TRUE)

lq1 <- ncol(animal_ind1) - 2

if (any(animal_inda$qtr==2)) {

    animal_ind2 <- reshape(animal_inda[animal_inda$qtr==2,-2], idvar = c("speciesCode","dfuArea"), timevar = c("landingCategory"), direction = "wide")
    animal_ind2$dfuArea.KON <- NULL
    animal_ind2$TOT <- rowSums(animal_ind2[-c(1:2)],na.rm = TRUE)
    colnames(animal_ind2)[-c(1,2)] <- paste0("2_",colnames(animal_ind2[-c(1,2)]))

    test1 <- merge(animal_ind1,animal_ind2,all=TRUE)

    lq2 <- ncol(animal_ind2) -2
} else { test1 <- animal_ind1}


if (any(animal_inda$qtr==3)) {

    animal_ind3 <- reshape(animal_inda[animal_inda$qtr==3,-2], idvar = c("speciesCode","dfuArea"), timevar = c("landingCategory"), direction = "wide")
    animal_ind3$dfuArea.KON <- NULL
    animal_ind3$TOT <- rowSums(animal_ind3[-c(1:2)],na.rm = TRUE)
    colnames(animal_ind3)[-c(1,2)] <- paste0("3_",colnames(animal_ind3[-c(1,2)]))

    test1 <- merge(test1,animal_ind3,all=TRUE)

    lq3 <- ncol(animal_ind3) -2
}

if (any(animal_inda$qtr==4)) {

    animal_ind4 <- reshape(animal_inda[animal_inda$qtr==4,-2], idvar = c("speciesCode","dfuArea"), timevar = c("landingCategory"), direction = "wide")
    animal_ind4$dfuArea.KON <- NULL
    animal_ind4$TOT <- rowSums(animal_ind4[-c(1:2)],na.rm = TRUE)
    colnames(animal_ind4)[-c(1,2)] <- paste0("4_",colnames(animal_ind4[-c(1,2)]))

    test1 <- merge(test1,animal_ind4,all=TRUE)

   lq4 <- ncol(animal_ind4) -2
}


test2 <- test1
test2$total <- rowSums(test2[grep("TOT", names(test2), value = TRUE)], na.rm=T)


if (length(unique(animal_inda$qtr))==1) {
    cg <- c("","1Q","Total")
    ncg <- c(1,lq1,1)
} else if (length(unique(animal_inda$qtr))==2) {
    cg <- c("","1Q","2Q","Total")
    ncg <- c(1,lq1,lq2,1)
} else if (length(unique(animal_inda$qtr))==3) {
    cg <- c("","1Q","2Q","3Q","Total")
    ncg <- c(1,lq1,lq2,lq3,1)
} else {
    cg <- c("","1Q","2Q","3Q","4Q","Total")
    ncg <- c(1,lq1,lq2,lq3,lq4,1)
}


# if (length(unique(animal_inda$qtr))==1) {
#     cg <- c("","","1Q","Total")
#     ncg <- c(1,lq1,1)
# } else if (length(unique(animal_inda$qtr))==2) {
#     cg <- c("","","1Q","2Q","Total")
#     ncg <- c(1,lq1,lq2,1)
# } else if (length(unique(animal_inda$qtr))==3) {
#     cg <- c("","","1Q","2Q","3Q","Total")
#     ncg <- c(1,lq1,lq2,lq3,1)
# } else {
#     cg <- c("","","1Q","2Q","3Q","4Q","Total")
#     ncg <- c(1,1,lq1,lq2,lq3,lq4,1)
# }



num_inda <- ddply(test2, .(speciesCode), summarise, numSpec=sumNA(!is.na(speciesCode)))
colnames(test2)[2] <- "\\bf Område"


colnames(test2) <- gsub("numInd.",  "", names(test2), fixed = TRUE)
colnames(test2) <- gsub("2_",  "", names(test2), fixed = TRUE)
colnames(test2) <- gsub("3_",  "", names(test2), fixed = TRUE)
colnames(test2) <- gsub("4_",  "", names(test2), fixed = TRUE)
#colnames(test2) <- gsub("ALL",  "", names(test2), fixed = TRUE)


test2$speciesCode <- NULL

library(Hmisc)
mylatex(test2,file='',booktabs =T,longtable= TRUE,rowlabel="",rowname="",cgroup = cg,n.cgroup = ncg, center='centering', lines.page=5000,
        rgroup=num_inda$speciesCode,n.rgroup=num_inda$numSpec)
detach(package:Hmisc)



```




```{r, include = FALSE}

animal_len <- ddply(animal[animal$representative=="ja",],
                    .(speciesCode,qtr,dfuArea, landingCategory), summarise, numInd=sumNA(number))

animal_len[is.na(animal_len$dfuArea),"dfuArea"] <- "-"

```

\newpage

\section{Repræsentative længdemålinger}


```{r ,echo=FALSE,results='asis', cache=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=7.5}

animal_ind1 <- reshape(animal_len[animal_len$qtr==1,-2], idvar = c("speciesCode","dfuArea"), timevar = c("landingCategory"), direction = "wide")
animal_ind1$dfuArea.KON <- NULL
animal_ind1$TOT <- rowSums(animal_ind1[-c(1:2)],na.rm = TRUE)

lq1 <- ncol(animal_ind1) - 2

if (any(animal_len$qtr==2)) {

    animal_ind2 <- reshape(animal_len[animal_len$qtr==2,-2], idvar = c("speciesCode","dfuArea"), timevar = c("landingCategory"), direction = "wide")
    animal_ind2$dfuArea.KON <- NULL
    animal_ind2$TOT <- rowSums(animal_ind2[-c(1:2)],na.rm = TRUE)
    colnames(animal_ind2)[-c(1,2)] <- paste0("2_",colnames(animal_ind2[-c(1,2)]))

    test1 <- merge(animal_ind1,animal_ind2,all=TRUE)

    lq2 <- ncol(animal_ind2) -2
} else { test1 <- animal_ind1}


if (any(animal_len$qtr==3)) {

    animal_ind3 <- reshape(animal_len[animal_len$qtr==3,-2], idvar = c("speciesCode","dfuArea"), timevar = c("landingCategory"), direction = "wide")
    animal_ind3$dfuArea.KON <- NULL
    animal_ind3$TOT <- rowSums(animal_ind3[-c(1:2)],na.rm = TRUE)
    colnames(animal_ind3)[-c(1,2)] <- paste0("3_",colnames(animal_ind3[-c(1,2)]))

    test1 <- merge(test1,animal_ind3,all=TRUE)

    lq3 <- ncol(animal_ind3) -2
}

if (any(animal_len$qtr==4)) {

    animal_ind4 <- reshape(animal_len[animal_len$qtr==4,-2], idvar = c("speciesCode","dfuArea"), timevar = c("landingCategory"), direction = "wide")
    animal_ind4$dfuArea.KON <- NULL
    animal_ind4$TOT <- rowSums(animal_ind4[-c(1:2)],na.rm = TRUE)
    colnames(animal_ind4)[-c(1,2)] <- paste0("4_",colnames(animal_ind4[-c(1,2)]))

    test1 <- merge(test1,animal_ind4,all=TRUE)

   lq4 <- ncol(animal_ind4) -2
}


test2 <- test1
test2$total <- rowSums(test2[grep("TOT", names(test2), value = TRUE)], na.rm=T)


if (length(unique(animal_inda$qtr))==1) {
    cg <- c("","1Q","Total")
    ncg <- c(1,lq1,1)
} else if (length(unique(animal_inda$qtr))==2) {
    cg <- c("","1Q","2Q","Total")
    ncg <- c(1,lq1,lq2,1)
} else if (length(unique(animal_inda$qtr))==3) {
    cg <- c("","1Q","2Q","3Q","Total")
    ncg <- c(1,lq1,lq2,lq3,1)
} else {
    cg <- c("","1Q","2Q","3Q","4Q","Total")
    ncg <- c(1,lq1,lq2,lq3,lq4,1)
}


num_inda <- ddply(test2, .(speciesCode), summarise, numSpec=sumNA(!is.na(speciesCode)))
colnames(test2)[2] <- "\\bf Område"


colnames(test2) <- gsub("numInd.",  "", names(test2), fixed = TRUE)
colnames(test2) <- gsub("2_",  "", names(test2), fixed = TRUE)
colnames(test2) <- gsub("3_",  "", names(test2), fixed = TRUE)
colnames(test2) <- gsub("4_",  "", names(test2), fixed = TRUE)
#colnames(test2) <- gsub("ALL",  "", names(test2), fixed = TRUE)


test2$speciesCode <- NULL

library(Hmisc)
mylatex(test2,file='',booktabs =T,longtable= TRUE,rowlabel="",rowname="",cgroup = cg,n.cgroup = ncg, center='centering', lines.page=5000,
        rgroup=num_inda$speciesCode,n.rgroup=num_inda$numSpec)
detach(package:Hmisc)



```


